{
  "entity": "Facility",
  "description": "Complete workflow analysis for Facility search and detail forms including user flows, state management, event chains, and modal patterns",
  "forms": {
    "search": {
      "formName": "frmFacilitySearch",
      "implements": "IBaseSearch",
      "purpose": "Search and manage facility records",
      "userFlows": [
        {
          "flowName": "InitialLoad",
          "trigger": "Form_Load",
          "steps": [
            {
              "order": 1,
              "action": "Initialize base form components",
              "method": "InitializeBase",
              "parameters": ["frmFacilitySearch"]
            },
            {
              "order": 2,
              "action": "Load River dropdown",
              "method": "LoadRiverDropdown",
              "dataSource": "sp_River_GetAll",
              "bindings": {
                "valueField": "RiverID",
                "displayField": "RiverName"
              }
            },
            {
              "order": 3,
              "action": "Load Facility Type dropdown",
              "method": "LoadFacilityTypeDropdown",
              "dataSource": "sp_BargeExLocationType_GetAll",
              "bindings": {
                "valueField": "BargeExLocationTypeID",
                "displayField": "Description"
              }
            },
            {
              "order": 4,
              "action": "Set default search criteria",
              "method": "SetDefaultSearchCriteria",
              "defaults": {
                "chkActiveOnly": true
              }
            },
            {
              "order": 5,
              "action": "Check user permissions",
              "method": "CheckSecurity",
              "permissions": ["FacilityReadOnly", "FacilityModify"]
            },
            {
              "order": 6,
              "action": "Configure button security",
              "method": "SetButtonType",
              "buttonConfigurations": [
                {
                  "button": "btnSearch",
                  "type": "Search",
                  "permission": "FacilityReadOnly"
                },
                {
                  "button": "btnClear",
                  "type": "Clear",
                  "permission": "FacilityReadOnly"
                },
                {
                  "button": "btnNew",
                  "type": "New",
                  "permission": "FacilityModify"
                },
                {
                  "button": "btnEdit",
                  "type": "Edit",
                  "permission": "FacilityModify"
                },
                {
                  "button": "btnDelete",
                  "type": "Delete",
                  "permission": "FacilityModify"
                }
              ]
            }
          ]
        },
        {
          "flowName": "SearchExecution",
          "trigger": "btnSearch_Click",
          "steps": [
            {
              "order": 1,
              "action": "Validate search criteria",
              "method": "AreFieldsValid",
              "validationRules": [
                {
                  "rule": "RiverRequiredIfMileRangeSpecified",
                  "condition": "numStartMile.HasValue OR numEndMile.HasValue",
                  "message": "River is required when searching by mile range"
                },
                {
                  "rule": "EndMileGreaterThanOrEqualStartMile",
                  "condition": "numStartMile.HasValue AND numEndMile.HasValue",
                  "message": "End Mile must be greater than or equal to Start Mile"
                }
              ]
            },
            {
              "order": 2,
              "action": "Build search parameters",
              "method": "BuildSearchParameters",
              "parameters": [
                {
                  "name": "@Name",
                  "source": "txtName.Text",
                  "type": "String",
                  "nullable": true
                },
                {
                  "name": "@ShortName",
                  "source": "txtShortName.Text",
                  "type": "String",
                  "nullable": true
                },
                {
                  "name": "@BargeExCode",
                  "source": "txtBargeExCode.Text",
                  "type": "String",
                  "nullable": true
                },
                {
                  "name": "@RiverID",
                  "source": "cboRiver.Value",
                  "type": "Int32",
                  "nullable": true
                },
                {
                  "name": "@FacilityTypeID",
                  "source": "cboFacilityType.Value",
                  "type": "Int32",
                  "nullable": true
                },
                {
                  "name": "@StartMile",
                  "source": "numStartMile.Value",
                  "type": "Decimal",
                  "nullable": true
                },
                {
                  "name": "@EndMile",
                  "source": "numEndMile.Value",
                  "type": "Decimal",
                  "nullable": true
                },
                {
                  "name": "@ActiveOnly",
                  "source": "chkActiveOnly.Checked",
                  "type": "Boolean",
                  "nullable": false
                }
              ]
            },
            {
              "order": 3,
              "action": "Execute search stored procedure",
              "method": "ExecuteSearch",
              "storedProcedure": "sp_FacilityLocationSearch",
              "resultSet": "FacilityLocationSearch collection"
            },
            {
              "order": 4,
              "action": "Bind results to grid",
              "method": "BindResultsToGrid",
              "target": "grdResults",
              "dataSource": "FacilityLocationSearch collection"
            },
            {
              "order": 5,
              "action": "Update result count display",
              "method": "UpdateResultCount",
              "display": "Number of records found"
            }
          ]
        },
        {
          "flowName": "ClearSearch",
          "trigger": "btnClear_Click",
          "steps": [
            {
              "order": 1,
              "action": "Clear all search criteria controls",
              "method": "ClearAllCriteria",
              "controls": [
                "txtName",
                "txtShortName",
                "txtBargeExCode",
                "cboRiver",
                "cboFacilityType",
                "numStartMile",
                "numEndMile"
              ]
            },
            {
              "order": 2,
              "action": "Reset default values",
              "method": "SetDefaultSearchCriteria",
              "defaults": {
                "chkActiveOnly": true
              }
            },
            {
              "order": 3,
              "action": "Clear results grid",
              "method": "ClearResultsGrid",
              "target": "grdResults"
            }
          ]
        },
        {
          "flowName": "CreateNewFacility",
          "trigger": "btnNew_Click",
          "steps": [
            {
              "order": 1,
              "action": "Check modify permission",
              "method": "CheckSecurity",
              "permission": "FacilityModify",
              "failureAction": "Display permission error and exit"
            },
            {
              "order": 2,
              "action": "Open detail form in Add mode",
              "method": "OpenFacilityDetailForm",
              "parameters": {
                "mode": "Add",
                "facilityId": null
              },
              "formType": "frmFacilityDetail",
              "modalDialog": true
            },
            {
              "order": 3,
              "action": "Refresh search results after close",
              "method": "RefreshGridAfterClose",
              "condition": "DialogResult == OK",
              "action": "Re-execute last search"
            }
          ]
        },
        {
          "flowName": "EditFacility",
          "trigger": "btnEdit_Click or grdResults_DoubleClick",
          "steps": [
            {
              "order": 1,
              "action": "Check modify permission",
              "method": "CheckSecurity",
              "permission": "FacilityModify",
              "failureAction": "Display permission error and exit",
              "note": "Read-only mode if only FacilityReadOnly"
            },
            {
              "order": 2,
              "action": "Get selected facility ID",
              "method": "GetSelectedFacilityID",
              "source": "grdResults.ActiveRow.Cells[LocationID].Value"
            },
            {
              "order": 3,
              "action": "Open detail form in Edit mode",
              "method": "OpenFacilityDetailForm",
              "parameters": {
                "mode": "Edit",
                "facilityId": "selectedLocationID"
              },
              "formType": "frmFacilityDetail",
              "modalDialog": true
            },
            {
              "order": 4,
              "action": "Refresh search results after close",
              "method": "RefreshGridAfterClose",
              "condition": "DialogResult == OK",
              "action": "Re-execute last search"
            }
          ]
        },
        {
          "flowName": "DeleteFacility",
          "trigger": "btnDelete_Click",
          "steps": [
            {
              "order": 1,
              "action": "Check modify permission",
              "method": "CheckSecurity",
              "permission": "FacilityModify",
              "failureAction": "Display permission error and exit"
            },
            {
              "order": 2,
              "action": "Get selected facility ID",
              "method": "GetSelectedFacilityID",
              "source": "grdResults.ActiveRow.Cells[LocationID].Value"
            },
            {
              "order": 3,
              "action": "Display confirmation dialog",
              "method": "ConfirmDeletion",
              "message": "Are you sure you want to delete this facility?",
              "dialogType": "YesNo"
            },
            {
              "order": 4,
              "action": "Execute soft delete",
              "method": "DeleteFacility",
              "storedProcedure": "sp_FacilityLocation_Delete",
              "parameters": {
                "LocationID": "selectedLocationID",
                "ModifiedBy": "CurrentUser"
              },
              "condition": "ConfirmationResult == Yes"
            },
            {
              "order": 5,
              "action": "Display success message",
              "method": "ShowSuccessMessage",
              "message": "Facility deleted successfully"
            },
            {
              "order": 6,
              "action": "Refresh search results",
              "method": "RefreshGrid",
              "action": "Re-execute last search"
            }
          ]
        }
      ],
      "stateManagement": {
        "searchCriteria": {
          "persistence": "In-memory during form session",
          "preservation": "Last search criteria preserved for refresh operations",
          "properties": [
            "Name",
            "ShortName",
            "BargeExCode",
            "RiverID",
            "FacilityTypeID",
            "StartMile",
            "EndMile",
            "ActiveOnly"
          ]
        },
        "gridState": {
          "selectedRow": "Tracked for Edit/Delete operations",
          "sortColumn": "Preserved during refresh",
          "scrollPosition": "Not preserved on refresh"
        },
        "formState": {
          "permissions": "Cached at form load",
          "lookupData": "Cached at form load (Rivers, FacilityTypes)"
        }
      },
      "refreshTriggers": [
        {
          "trigger": "Detail form closed with OK result",
          "action": "Re-execute last search",
          "preserves": "Search criteria, sort order"
        },
        {
          "trigger": "Successful delete operation",
          "action": "Re-execute last search",
          "preserves": "Search criteria, sort order"
        },
        {
          "trigger": "Manual refresh (if implemented)",
          "action": "Re-execute last search",
          "preserves": "Search criteria, sort order"
        }
      ]
    },
    "detail": {
      "formName": "frmFacilityDetail",
      "implements": "IBaseDetailEdit",
      "purpose": "Create, view, and edit facility records with related entities",
      "userFlows": [
        {
          "flowName": "InitialLoad",
          "trigger": "Form_Load",
          "steps": [
            {
              "order": 1,
              "action": "Initialize base form components",
              "method": "InitializeBase",
              "parameters": ["frmFacilityDetail"]
            },
            {
              "order": 2,
              "action": "Determine form mode (Add/Edit/View)",
              "method": "DetermineFormMode",
              "modes": ["Add", "Edit", "View"]
            },
            {
              "order": 3,
              "action": "Load dropdown data sources",
              "method": "LoadDropdowns",
              "dropdowns": [
                {
                  "control": "cboRiver",
                  "method": "LoadRiverDropdown",
                  "storedProcedure": "sp_River_GetAll",
                  "bindings": {
                    "valueField": "RiverID",
                    "displayField": "RiverName"
                  }
                },
                {
                  "control": "cboBank",
                  "method": "LoadBankDropdown",
                  "dataSource": "Static",
                  "values": [
                    {"value": "L", "display": "Left"},
                    {"value": "R", "display": "Right"},
                    {"value": "B", "display": "Both"}
                  ]
                },
                {
                  "control": "cboFacilityType",
                  "method": "LoadFacilityTypeDropdown",
                  "storedProcedure": "sp_BargeExLocationType_GetAll",
                  "bindings": {
                    "valueField": "BargeExLocationTypeID",
                    "displayField": "Description"
                  }
                }
              ]
            },
            {
              "order": 4,
              "action": "Load facility data (Edit mode only)",
              "method": "LoadFacilityData",
              "condition": "Mode == Edit OR Mode == View",
              "storedProcedure": "sp_FacilityLocation_GetByID",
              "parameters": {
                "LocationID": "facilityId"
              }
            },
            {
              "order": 5,
              "action": "Bind data to form controls",
              "method": "BindDataToControls",
              "bindings": [
                {"control": "txtName", "field": "Name"},
                {"control": "txtShortName", "field": "ShortName"},
                {"control": "cboRiver", "field": "RiverID"},
                {"control": "txtMile", "field": "Mile"},
                {"control": "cboBank", "field": "Bank"},
                {"control": "cboFacilityType", "field": "BargeExLocationTypeID"},
                {"control": "txtBargeExCode", "field": "BargeExCode"},
                {"control": "txtLockName", "field": "LockName"},
                {"control": "txtLockNumber", "field": "LockNumber"},
                {"control": "txtGaugeName", "field": "GaugeName"},
                {"control": "txtNdcName", "field": "NdcName"},
                {"control": "txtNdcAddress", "field": "NdcAddress"},
                {"control": "txtNdcCity", "field": "NdcCity"},
                {"control": "txtNdcState", "field": "NdcState"},
                {"control": "txtNdcZip", "field": "NdcZip"},
                {"control": "chkIsActive", "field": "IsActive"}
              ]
            },
            {
              "order": 6,
              "action": "Load related entities (Edit mode only)",
              "method": "LoadRelatedEntities",
              "condition": "Mode == Edit AND LocationID > 0",
              "entities": [
                {
                  "entity": "FacilityStatus",
                  "storedProcedure": "sp_FacilityStatus_GetByFacilityID",
                  "target": "grdStatus"
                },
                {
                  "entity": "FacilityBerth",
                  "storedProcedure": "sp_FacilityBerth_GetByFacilityID",
                  "target": "grdBerths"
                }
              ]
            },
            {
              "order": 7,
              "action": "Apply conditional field visibility",
              "method": "ApplyConditionalDisplay",
              "trigger": "Based on FacilityType value"
            },
            {
              "order": 8,
              "action": "Configure tab availability",
              "method": "ConfigureTabAccess",
              "rules": [
                {
                  "tab": "tabStatus",
                  "enabled": "LocationID > 0",
                  "reason": "Parent entity must be saved first"
                },
                {
                  "tab": "tabBerths",
                  "enabled": "LocationID > 0",
                  "reason": "Parent entity must be saved first"
                }
              ]
            },
            {
              "order": 9,
              "action": "Check user permissions and configure controls",
              "method": "CheckSecurity",
              "permissions": ["FacilityReadOnly", "FacilityModify"]
            },
            {
              "order": 10,
              "action": "Set form to read-only if view mode or insufficient permissions",
              "method": "SetReadOnlyMode",
              "condition": "Mode == View OR Permission == FacilityReadOnly"
            }
          ]
        },
        {
          "flowName": "FacilityTypeChanged",
          "trigger": "cboFacilityType_ValueChanged",
          "steps": [
            {
              "order": 1,
              "action": "Get selected facility type",
              "method": "GetSelectedFacilityType",
              "source": "cboFacilityType.Value"
            },
            {
              "order": 2,
              "action": "Show/hide Lock fields",
              "method": "ToggleLockFields",
              "condition": "FacilityType == 'Lock'",
              "affectedControls": ["txtLockName", "txtLockNumber"],
              "action": "Visible = (FacilityType == Lock)"
            },
            {
              "order": 3,
              "action": "Show/hide Gauge fields",
              "method": "ToggleGaugeFields",
              "condition": "FacilityType == 'Gauge Location'",
              "affectedControls": ["txtGaugeName"],
              "action": "Visible = (FacilityType == Gauge Location)"
            },
            {
              "order": 4,
              "action": "Clear conditional fields when hidden",
              "method": "ClearConditionalFields",
              "rules": [
                {
                  "fields": ["txtLockName", "txtLockNumber"],
                  "condition": "FacilityType != Lock"
                },
                {
                  "fields": ["txtGaugeName"],
                  "condition": "FacilityType != Gauge Location"
                }
              ]
            }
          ]
        },
        {
          "flowName": "SaveFacility",
          "trigger": "btnSave_Click",
          "steps": [
            {
              "order": 1,
              "action": "Check modify permission",
              "method": "CheckSecurity",
              "permission": "FacilityModify",
              "failureAction": "Display permission error and exit"
            },
            {
              "order": 2,
              "action": "Validate form fields",
              "method": "AreFieldsValid",
              "validationRules": [
                {
                  "rule": "RequiredField",
                  "field": "txtName",
                  "message": "Facility Name is required"
                },
                {
                  "rule": "RequiredField",
                  "field": "txtShortName",
                  "message": "Short Name is required"
                },
                {
                  "rule": "RequiredField",
                  "field": "cboFacilityType",
                  "message": "Facility Type is required"
                },
                {
                  "rule": "ConditionalBlank",
                  "field": "txtLockName",
                  "condition": "FacilityType != Lock",
                  "message": "Lock Name must be blank if Facility Type is not Lock"
                },
                {
                  "rule": "ConditionalBlank",
                  "field": "txtLockNumber",
                  "condition": "FacilityType != Lock",
                  "message": "Lock Number must be blank if Facility Type is not Lock"
                },
                {
                  "rule": "ConditionalBlank",
                  "field": "txtGaugeName",
                  "condition": "FacilityType != Gauge Location",
                  "message": "Gauge Name must be blank if Facility Type is not Gauge Location"
                },
                {
                  "rule": "RiverRequiredWithMile",
                  "fields": ["cboRiver", "txtMile"],
                  "condition": "txtMile.HasValue",
                  "message": "River is required when Mile is specified"
                }
              ]
            },
            {
              "order": 3,
              "action": "Apply business rules validation",
              "method": "CheckBusinessRules",
              "rules": [
                "Validate conditional field requirements",
                "Check for duplicate facility names",
                "Validate Mile range if specified"
              ]
            },
            {
              "order": 4,
              "action": "Save main facility record",
              "method": "SaveFacilityRecord",
              "storedProcedure": {
                "insert": "sp_FacilityLocation_Insert",
                "update": "sp_FacilityLocation_Update"
              },
              "parameters": [
                "@LocationID (Update only)",
                "@Name",
                "@ShortName",
                "@RiverID",
                "@Mile",
                "@Bank",
                "@BargeExLocationTypeID",
                "@BargeExCode",
                "@LockName",
                "@LockNumber",
                "@GaugeName",
                "@NdcName",
                "@NdcAddress",
                "@NdcCity",
                "@NdcState",
                "@NdcZip",
                "@IsActive",
                "@CreatedBy/@ModifiedBy"
              ],
              "returnValue": "LocationID (for Insert)"
            },
            {
              "order": 5,
              "action": "Save related Status entities",
              "method": "SaveFacilityStatuses",
              "condition": "Status grid has changes",
              "operations": [
                {
                  "operation": "Insert",
                  "storedProcedure": "sp_FacilityStatus_Insert",
                  "condition": "Row is new"
                },
                {
                  "operation": "Update",
                  "storedProcedure": "sp_FacilityStatus_Update",
                  "condition": "Row is modified"
                },
                {
                  "operation": "Delete",
                  "storedProcedure": "sp_FacilityStatus_Delete",
                  "condition": "Row is deleted"
                }
              ]
            },
            {
              "order": 6,
              "action": "Save related Berth entities",
              "method": "SaveFacilityBerths",
              "condition": "Berth grid has changes",
              "operations": [
                {
                  "operation": "Insert",
                  "storedProcedure": "sp_FacilityBerth_Insert",
                  "condition": "Row is new"
                },
                {
                  "operation": "Update",
                  "storedProcedure": "sp_FacilityBerth_Update",
                  "condition": "Row is modified"
                },
                {
                  "operation": "Delete",
                  "storedProcedure": "sp_FacilityBerth_Delete",
                  "condition": "Row is deleted"
                }
              ]
            },
            {
              "order": 7,
              "action": "Display success message",
              "method": "ShowSuccessMessage",
              "message": "Facility saved successfully"
            },
            {
              "order": 8,
              "action": "Update form state",
              "method": "UpdateFormState",
              "actions": [
                "Set Mode = Edit if was Add",
                "Update LocationID if was new",
                "Enable Status and Berths tabs",
                "Mark form as clean (no unsaved changes)"
              ]
            },
            {
              "order": 9,
              "action": "Set dialog result",
              "method": "SetDialogResult",
              "result": "OK",
              "note": "Triggers refresh in calling form"
            }
          ]
        },
        {
          "flowName": "DeleteFacility",
          "trigger": "btnDelete_Click",
          "steps": [
            {
              "order": 1,
              "action": "Check modify permission",
              "method": "CheckSecurity",
              "permission": "FacilityModify",
              "failureAction": "Display permission error and exit"
            },
            {
              "order": 2,
              "action": "Check if facility is deletable",
              "method": "CheckDeletionConstraints",
              "constraints": [
                "Check for related records in other systems",
                "Verify no active assignments"
              ]
            },
            {
              "order": 3,
              "action": "Display confirmation dialog",
              "method": "ConfirmDeletion",
              "message": "Are you sure you want to delete this facility?",
              "dialogType": "YesNo"
            },
            {
              "order": 4,
              "action": "Execute soft delete",
              "method": "DeleteFacility",
              "storedProcedure": "sp_FacilityLocation_Delete",
              "parameters": {
                "LocationID": "currentLocationID",
                "ModifiedBy": "CurrentUser"
              },
              "condition": "ConfirmationResult == Yes",
              "note": "Soft delete sets IsActive = 0"
            },
            {
              "order": 5,
              "action": "Display success message",
              "method": "ShowSuccessMessage",
              "message": "Facility deleted successfully"
            },
            {
              "order": 6,
              "action": "Close form with OK result",
              "method": "CloseForm",
              "dialogResult": "OK"
            }
          ]
        },
        {
          "flowName": "CancelChanges",
          "trigger": "btnCancel_Click",
          "steps": [
            {
              "order": 1,
              "action": "Check for unsaved changes",
              "method": "HasUnsavedChanges",
              "tracking": "Track IsDirty flag on form and child grids"
            },
            {
              "order": 2,
              "action": "Display confirmation if changes exist",
              "method": "ConfirmDiscardChanges",
              "condition": "HasUnsavedChanges == true",
              "message": "You have unsaved changes. Are you sure you want to cancel?",
              "dialogType": "YesNo"
            },
            {
              "order": 3,
              "action": "Close form with Cancel result",
              "method": "CloseForm",
              "dialogResult": "Cancel",
              "condition": "No unsaved changes OR User confirms discard"
            }
          ]
        },
        {
          "flowName": "AddStatus",
          "trigger": "btnAddStatus_Click",
          "steps": [
            {
              "order": 1,
              "action": "Check modify permission",
              "method": "CheckSecurity",
              "permission": "FacilityModify"
            },
            {
              "order": 2,
              "action": "Verify parent is saved",
              "method": "CheckParentSaved",
              "condition": "LocationID > 0",
              "failureMessage": "Please save the facility before adding status records"
            },
            {
              "order": 3,
              "action": "Open status modal dialog",
              "method": "OpenStatusModal",
              "mode": "Add",
              "modalType": "Status entry form"
            },
            {
              "order": 4,
              "action": "Add new row to status grid",
              "method": "AddStatusRow",
              "condition": "DialogResult == OK",
              "target": "grdStatus",
              "markAs": "PendingInsert"
            },
            {
              "order": 5,
              "action": "Mark form as dirty",
              "method": "SetDirtyFlag",
              "value": true
            }
          ]
        },
        {
          "flowName": "EditStatus",
          "trigger": "btnEditStatus_Click",
          "steps": [
            {
              "order": 1,
              "action": "Check modify permission",
              "method": "CheckSecurity",
              "permission": "FacilityModify"
            },
            {
              "order": 2,
              "action": "Get selected status row",
              "method": "GetSelectedStatusRow",
              "source": "grdStatus.ActiveRow"
            },
            {
              "order": 3,
              "action": "Open status modal dialog",
              "method": "OpenStatusModal",
              "mode": "Edit",
              "parameters": "Selected status data"
            },
            {
              "order": 4,
              "action": "Update status row in grid",
              "method": "UpdateStatusRow",
              "condition": "DialogResult == OK",
              "target": "grdStatus.ActiveRow",
              "markAs": "PendingUpdate"
            },
            {
              "order": 5,
              "action": "Mark form as dirty",
              "method": "SetDirtyFlag",
              "value": true
            }
          ]
        },
        {
          "flowName": "DeleteStatus",
          "trigger": "btnDeleteStatus_Click",
          "steps": [
            {
              "order": 1,
              "action": "Check modify permission",
              "method": "CheckSecurity",
              "permission": "FacilityModify"
            },
            {
              "order": 2,
              "action": "Get selected status row",
              "method": "GetSelectedStatusRow",
              "source": "grdStatus.ActiveRow"
            },
            {
              "order": 3,
              "action": "Display confirmation dialog",
              "method": "ConfirmDeletion",
              "message": "Are you sure you want to delete this status record?",
              "dialogType": "YesNo"
            },
            {
              "order": 4,
              "action": "Remove row from grid",
              "method": "DeleteStatusRow",
              "condition": "ConfirmationResult == Yes",
              "target": "grdStatus.ActiveRow",
              "markAs": "PendingDelete"
            },
            {
              "order": 5,
              "action": "Mark form as dirty",
              "method": "SetDirtyFlag",
              "value": true
            }
          ]
        },
        {
          "flowName": "AddBerth",
          "trigger": "btnAddBerth_Click",
          "steps": [
            {
              "order": 1,
              "action": "Check modify permission",
              "method": "CheckSecurity",
              "permission": "FacilityModify"
            },
            {
              "order": 2,
              "action": "Verify parent is saved",
              "method": "CheckParentSaved",
              "condition": "LocationID > 0",
              "failureMessage": "Please save the facility before adding berth records"
            },
            {
              "order": 3,
              "action": "Open berth modal dialog",
              "method": "OpenBerthModal",
              "mode": "Add",
              "modalType": "Berth entry form"
            },
            {
              "order": 4,
              "action": "Add new row to berth grid",
              "method": "AddBerthRow",
              "condition": "DialogResult == OK",
              "target": "grdBerths",
              "markAs": "PendingInsert"
            },
            {
              "order": 5,
              "action": "Mark form as dirty",
              "method": "SetDirtyFlag",
              "value": true
            }
          ]
        },
        {
          "flowName": "EditBerth",
          "trigger": "btnEditBerth_Click",
          "steps": [
            {
              "order": 1,
              "action": "Check modify permission",
              "method": "CheckSecurity",
              "permission": "FacilityModify"
            },
            {
              "order": 2,
              "action": "Get selected berth row",
              "method": "GetSelectedBerthRow",
              "source": "grdBerths.ActiveRow"
            },
            {
              "order": 3,
              "action": "Open berth modal dialog",
              "method": "OpenBerthModal",
              "mode": "Edit",
              "parameters": "Selected berth data"
            },
            {
              "order": 4,
              "action": "Update berth row in grid",
              "method": "UpdateBerthRow",
              "condition": "DialogResult == OK",
              "target": "grdBerths.ActiveRow",
              "markAs": "PendingUpdate"
            },
            {
              "order": 5,
              "action": "Mark form as dirty",
              "method": "SetDirtyFlag",
              "value": true
            }
          ]
        },
        {
          "flowName": "DeleteBerth",
          "trigger": "btnDeleteBerth_Click",
          "steps": [
            {
              "order": 1,
              "action": "Check modify permission",
              "method": "CheckSecurity",
              "permission": "FacilityModify"
            },
            {
              "order": 2,
              "action": "Get selected berth row",
              "method": "GetSelectedBerthRow",
              "source": "grdBerths.ActiveRow"
            },
            {
              "order": 3,
              "action": "Display confirmation dialog",
              "method": "ConfirmDeletion",
              "message": "Are you sure you want to delete this berth record?",
              "dialogType": "YesNo"
            },
            {
              "order": 4,
              "action": "Remove row from grid",
              "method": "DeleteBerthRow",
              "condition": "ConfirmationResult == Yes",
              "target": "grdBerths.ActiveRow",
              "markAs": "PendingDelete"
            },
            {
              "order": 5,
              "action": "Mark form as dirty",
              "method": "SetDirtyFlag",
              "value": true
            }
          ]
        }
      ],
      "stateManagement": {
        "formMode": {
          "states": ["Add", "Edit", "View"],
          "determination": "Based on LocationID parameter and permissions",
          "transitions": [
            {
              "from": "Add",
              "to": "Edit",
              "trigger": "Successful save of new facility"
            }
          ]
        },
        "entityState": {
          "mainEntity": {
            "entity": "FacilityLocation",
            "states": ["New", "Existing", "Modified", "Deleted"],
            "tracking": "IsDirty flag on form"
          },
          "relatedEntities": {
            "facilityStatuses": {
              "entity": "FacilityStatus",
              "collection": "grdStatus rows",
              "states": ["PendingInsert", "PendingUpdate", "PendingDelete", "Unchanged"],
              "persistence": "Saved with parent on btnSave_Click"
            },
            "facilityBerths": {
              "entity": "FacilityBerth",
              "collection": "grdBerths rows",
              "states": ["PendingInsert", "PendingUpdate", "PendingDelete", "Unchanged"],
              "persistence": "Saved with parent on btnSave_Click"
            }
          }
        },
        "conditionalVisibility": {
          "lockFields": {
            "controls": ["txtLockName", "txtLockNumber"],
            "condition": "cboFacilityType == Lock",
            "trigger": "cboFacilityType_ValueChanged"
          },
          "gaugeFields": {
            "controls": ["txtGaugeName"],
            "condition": "cboFacilityType == Gauge Location",
            "trigger": "cboFacilityType_ValueChanged"
          }
        },
        "tabState": {
          "detailsTab": {
            "enabled": "Always",
            "default": true
          },
          "statusTab": {
            "enabled": "LocationID > 0",
            "reason": "Parent must be saved first"
          },
          "berthsTab": {
            "enabled": "LocationID > 0",
            "reason": "Parent must be saved first"
          },
          "ndcTab": {
            "enabled": "Always",
            "default": false
          }
        },
        "validationState": {
          "formLevel": "AreFieldsValid() method validates all controls",
          "businessRules": "CheckBusinessRules() validates business logic",
          "triggerPoints": ["btnSave_Click", "Form closing with unsaved changes"]
        },
        "dirtyTracking": {
          "mechanism": "IsDirty flag",
          "triggers": [
            "Any control value changed",
            "Grid row added/modified/deleted",
            "Conditional field visibility changed"
          ],
          "resetOn": "Successful save or cancel confirmed"
        }
      },
      "modalDialogPatterns": {
        "statusModal": {
          "trigger": "btnAddStatus_Click or btnEditStatus_Click",
          "dialogType": "Modal form",
          "purpose": "Add or edit FacilityStatus record",
          "fields": [
            {
              "field": "StatusDate",
              "type": "DateTime",
              "required": true,
              "control": "DateTimePicker"
            },
            {
              "field": "StatusType",
              "type": "String",
              "required": true,
              "control": "Dropdown",
              "dataSource": "Status type lookup"
            },
            {
              "field": "StatusDescription",
              "type": "String",
              "required": false,
              "control": "TextBox"
            }
          ],
          "buttons": ["OK", "Cancel"],
          "validation": "Validate before accepting OK",
          "resultHandling": {
            "OK": "Add/update row in grdStatus, mark as dirty",
            "Cancel": "Discard changes, no grid update"
          }
        },
        "berthModal": {
          "trigger": "btnAddBerth_Click or btnEditBerth_Click",
          "dialogType": "Modal form",
          "purpose": "Add or edit FacilityBerth record",
          "fields": [
            {
              "field": "BerthName",
              "type": "String",
              "required": true,
              "control": "TextBox"
            },
            {
              "field": "BerthNumber",
              "type": "String",
              "required": false,
              "control": "TextBox"
            },
            {
              "field": "Capacity",
              "type": "Integer",
              "required": false,
              "control": "NumericUpDown"
            },
            {
              "field": "Length",
              "type": "Decimal",
              "required": false,
              "control": "NumericUpDown"
            },
            {
              "field": "IsActive",
              "type": "Boolean",
              "required": false,
              "control": "CheckBox",
              "defaultValue": true
            },
            {
              "field": "Notes",
              "type": "String",
              "required": false,
              "control": "TextBox (multiline)"
            }
          ],
          "buttons": ["OK", "Cancel"],
          "validation": "Validate before accepting OK",
          "resultHandling": {
            "OK": "Add/update row in grdBerths, mark as dirty",
            "Cancel": "Discard changes, no grid update"
          }
        },
        "confirmationDialogs": {
          "deleteConfirmation": {
            "trigger": "btnDelete_Click, btnDeleteStatus_Click, btnDeleteBerth_Click",
            "message": "Are you sure you want to delete this [entity]?",
            "dialogType": "YesNo",
            "icon": "Warning",
            "defaultButton": "No"
          },
          "unsavedChangesConfirmation": {
            "trigger": "Form closing or btnCancel_Click with unsaved changes",
            "message": "You have unsaved changes. Are you sure you want to cancel?",
            "dialogType": "YesNo",
            "icon": "Question",
            "defaultButton": "No"
          }
        }
      },
      "refreshTriggers": [
        {
          "trigger": "Successful save operation",
          "action": "Reload related entity grids if mode changed from Add to Edit",
          "affectedControls": ["grdStatus", "grdBerths"]
        },
        {
          "trigger": "Tab selection changed to Status or Berths",
          "action": "Load related entities if not already loaded",
          "condition": "First access after save"
        },
        {
          "trigger": "Modal dialog closed with OK result",
          "action": "Update corresponding grid row",
          "affectedControls": ["grdStatus", "grdBerths"]
        }
      ]
    }
  },
  "eventHandlerChains": {
    "formLoad": {
      "searchForm": [
        "Form_Load",
        "InitializeBase",
        "LoadRiverDropdown",
        "LoadFacilityTypeDropdown",
        "SetDefaultSearchCriteria",
        "CheckSecurity",
        "SetButtonType (multiple buttons)"
      ],
      "detailForm": [
        "Form_Load",
        "InitializeBase",
        "DetermineFormMode",
        "LoadRiverDropdown",
        "LoadBankDropdown",
        "LoadFacilityTypeDropdown",
        "LoadFacilityData (if Edit/View mode)",
        "BindDataToControls",
        "LoadRelatedEntities (if Edit mode)",
        "ApplyConditionalDisplay",
        "ConfigureTabAccess",
        "CheckSecurity",
        "SetReadOnlyMode (if applicable)"
      ]
    },
    "saveOperation": {
      "chain": [
        "btnSave_Click",
        "CheckSecurity",
        "AreFieldsValid",
        "CheckBusinessRules",
        "SaveFacilityRecord (Insert or Update)",
        "SaveFacilityStatuses (if changed)",
        "SaveFacilityBerths (if changed)",
        "ShowSuccessMessage",
        "UpdateFormState",
        "SetDialogResult"
      ]
    },
    "deleteOperation": {
      "chain": [
        "btnDelete_Click",
        "CheckSecurity",
        "CheckDeletionConstraints",
        "ConfirmDeletion",
        "DeleteFacility (soft delete)",
        "ShowSuccessMessage",
        "CloseForm"
      ]
    },
    "conditionalDisplay": {
      "chain": [
        "cboFacilityType_ValueChanged",
        "GetSelectedFacilityType",
        "ToggleLockFields",
        "ToggleGaugeFields",
        "ClearConditionalFields"
      ]
    },
    "childEntityAdd": {
      "status": [
        "btnAddStatus_Click",
        "CheckSecurity",
        "CheckParentSaved",
        "OpenStatusModal",
        "AddStatusRow (if OK)",
        "SetDirtyFlag"
      ],
      "berth": [
        "btnAddBerth_Click",
        "CheckSecurity",
        "CheckParentSaved",
        "OpenBerthModal",
        "AddBerthRow (if OK)",
        "SetDirtyFlag"
      ]
    },
    "childEntityEdit": {
      "status": [
        "btnEditStatus_Click",
        "CheckSecurity",
        "GetSelectedStatusRow",
        "OpenStatusModal",
        "UpdateStatusRow (if OK)",
        "SetDirtyFlag"
      ],
      "berth": [
        "btnEditBerth_Click",
        "CheckSecurity",
        "GetSelectedBerthRow",
        "OpenBerthModal",
        "UpdateBerthRow (if OK)",
        "SetDirtyFlag"
      ]
    },
    "childEntityDelete": {
      "status": [
        "btnDeleteStatus_Click",
        "CheckSecurity",
        "GetSelectedStatusRow",
        "ConfirmDeletion",
        "DeleteStatusRow (if Yes)",
        "SetDirtyFlag"
      ],
      "berth": [
        "btnDeleteBerth_Click",
        "CheckSecurity",
        "GetSelectedBerthRow",
        "ConfirmDeletion",
        "DeleteBerthRow (if Yes)",
        "SetDirtyFlag"
      ]
    }
  },
  "lifecycleMethods": {
    "initialization": {
      "Form_Load": {
        "purpose": "Initialize form controls and load data",
        "order": 1,
        "calls": ["InitializeBase", "LoadDropdowns", "LoadData", "SetDefaults", "CheckSecurity"]
      },
      "InitializeBase": {
        "purpose": "Initialize base form infrastructure",
        "order": 2,
        "parameters": ["subsystemName"],
        "inheritsFrom": "Base form class"
      }
    },
    "dataLoading": {
      "LoadDropdowns": {
        "purpose": "Populate all dropdown controls",
        "timing": "Form_Load",
        "dropdowns": ["River", "Bank", "FacilityType"]
      },
      "LoadFacilityData": {
        "purpose": "Load main facility entity",
        "timing": "Form_Load (Edit/View mode)",
        "storedProcedure": "sp_FacilityLocation_GetByID"
      },
      "LoadRelatedEntities": {
        "purpose": "Load child entity collections",
        "timing": "Form_Load (Edit mode) or after first save",
        "entities": ["FacilityStatus", "FacilityBerth"]
      }
    },
    "validation": {
      "AreFieldsValid": {
        "purpose": "Validate all form controls",
        "timing": "Before save or form close",
        "returns": "Boolean",
        "validationTypes": ["Required fields", "Format validation", "Conditional field validation"]
      },
      "CheckBusinessRules": {
        "purpose": "Validate business logic rules",
        "timing": "After AreFieldsValid, before save",
        "returns": "Boolean",
        "ruleTypes": ["Conditional requirements", "Cross-field validation", "Data integrity"]
      }
    },
    "persistence": {
      "Save": {
        "purpose": "Save all form data",
        "timing": "btnSave_Click",
        "order": ["Validate", "Save main entity", "Save child entities", "Update state"]
      },
      "SaveFacilityRecord": {
        "purpose": "Persist main facility entity",
        "storedProcedures": ["sp_FacilityLocation_Insert", "sp_FacilityLocation_Update"],
        "transactionScope": "Yes"
      },
      "SaveChildEntities": {
        "purpose": "Persist related entity changes",
        "entities": ["FacilityStatus", "FacilityBerth"],
        "operations": ["Insert", "Update", "Delete"],
        "transactionScope": "Yes"
      }
    },
    "cleanup": {
      "Form_Closing": {
        "purpose": "Handle form close event",
        "timing": "When form is closing",
        "checks": ["Unsaved changes", "Validation if saving"]
      },
      "Dispose": {
        "purpose": "Clean up resources",
        "timing": "After form closes",
        "actions": ["Release database connections", "Clear event handlers"]
      }
    }
  },
  "statePersistence": {
    "databasePersistence": {
      "mainEntity": {
        "entity": "FacilityLocation",
        "table": "FacilityLocation",
        "primaryKey": "LocationID",
        "insertProcedure": "sp_FacilityLocation_Insert",
        "updateProcedure": "sp_FacilityLocation_Update",
        "deleteProcedure": "sp_FacilityLocation_Delete (soft delete)",
        "auditFields": ["CreatedBy", "CreatedDate", "ModifiedBy", "ModifiedDate"]
      },
      "relatedEntities": [
        {
          "entity": "FacilityStatus",
          "table": "FacilityStatus",
          "primaryKey": "FacilityStatusID",
          "foreignKey": "LocationID",
          "relationship": "One-to-Many",
          "insertProcedure": "sp_FacilityStatus_Insert",
          "updateProcedure": "sp_FacilityStatus_Update",
          "deleteProcedure": "sp_FacilityStatus_Delete",
          "cascadeDelete": false,
          "auditFields": ["CreatedBy", "CreatedDate"]
        },
        {
          "entity": "FacilityBerth",
          "table": "FacilityBerth",
          "primaryKey": "FacilityBerthID",
          "foreignKey": "LocationID",
          "relationship": "One-to-Many",
          "insertProcedure": "sp_FacilityBerth_Insert",
          "updateProcedure": "sp_FacilityBerth_Update",
          "deleteProcedure": "sp_FacilityBerth_Delete",
          "cascadeDelete": false,
          "auditFields": ["CreatedBy", "CreatedDate", "ModifiedBy", "ModifiedDate"]
        }
      ]
    },
    "inMemoryState": {
      "formLevel": {
        "isDirty": "Tracks unsaved changes",
        "formMode": "Add, Edit, or View",
        "currentLocationID": "Primary key of loaded facility"
      },
      "searchCriteria": {
        "persistence": "Maintained during form session for refresh operations",
        "fields": ["Name", "ShortName", "BargeExCode", "RiverID", "FacilityTypeID", "StartMile", "EndMile", "ActiveOnly"]
      },
      "gridState": {
        "selectedRow": "Tracked for Edit/Delete operations",
        "sortColumn": "Preserved during refresh",
        "pendingChanges": "Tracks Insert/Update/Delete operations for child grids"
      }
    },
    "transactionManagement": {
      "saveOperation": {
        "scope": "Database transaction",
        "includes": [
          "Main facility insert/update",
          "All pending status inserts/updates/deletes",
          "All pending berth inserts/updates/deletes"
        ],
        "rollbackOn": "Any error",
        "commitOn": "All operations successful"
      }
    }
  },
  "modernWorkflowMapping": {
    "aspNetCoreMvc": {
      "searchPage": {
        "controller": "FacilitySearchController",
        "actions": [
          {
            "action": "Index",
            "httpMethod": "GET",
            "purpose": "Display search form",
            "authorization": "[Authorize(Policy = 'FacilityReadOnly')]"
          },
          {
            "action": "FacilityTable",
            "httpMethod": "POST",
            "purpose": "Server-side DataTables processing",
            "authorization": "[Authorize(Policy = 'FacilityReadOnly')]",
            "returns": "DataTableResponse<FacilityListDto>"
          }
        ],
        "clientSideScripts": [
          {
            "file": "facilitySearch.js",
            "features": ["DataTables initialization", "Search button handler", "Clear button handler", "Row selection"]
          }
        ]
      },
      "detailPage": {
        "controller": "FacilitySearchController",
        "actions": [
          {
            "action": "Create",
            "httpMethod": "GET",
            "purpose": "Display blank form",
            "authorization": "[Authorize(Policy = 'FacilityModify')]"
          },
          {
            "action": "Create",
            "httpMethod": "POST",
            "purpose": "Save new facility",
            "authorization": "[Authorize(Policy = 'FacilityModify')]",
            "validation": "ModelState validation",
            "returns": "RedirectToAction or View with errors"
          },
          {
            "action": "Edit",
            "httpMethod": "GET",
            "purpose": "Display populated form",
            "authorization": "[Authorize(Policy = 'FacilityReadOnly')]",
            "parameters": ["id"]
          },
          {
            "action": "Edit",
            "httpMethod": "POST",
            "purpose": "Update existing facility",
            "authorization": "[Authorize(Policy = 'FacilityModify')]",
            "validation": "ModelState validation",
            "returns": "RedirectToAction or View with errors"
          },
          {
            "action": "Delete",
            "httpMethod": "POST",
            "purpose": "Soft delete facility",
            "authorization": "[Authorize(Policy = 'FacilityModify')]",
            "returns": "JSON result"
          }
        ],
        "clientSideScripts": [
          {
            "file": "facilityDetail.js",
            "features": [
              "Tab navigation",
              "Conditional field visibility (Facility Type change)",
              "Status grid with modal CRUD",
              "Berth grid with modal CRUD",
              "Form validation",
              "Unsaved changes warning"
            ]
          }
        ]
      },
      "apiEndpoints": {
        "controller": "FacilityController",
        "baseRoute": "/api/facility",
        "endpoints": [
          {
            "route": "GET /api/facility/rivers",
            "purpose": "Get rivers for Select2 dropdown",
            "authorization": "[Authorize(Policy = 'FacilityReadOnly')]"
          },
          {
            "route": "GET /api/facility/facility-types",
            "purpose": "Get facility types for Select2 dropdown",
            "authorization": "[Authorize(Policy = 'FacilityReadOnly')]"
          },
          {
            "route": "GET /api/facility/{id}/statuses",
            "purpose": "Get facility statuses",
            "authorization": "[Authorize(Policy = 'FacilityReadOnly')]"
          },
          {
            "route": "POST /api/facility/{id}/statuses",
            "purpose": "Add facility status",
            "authorization": "[Authorize(Policy = 'FacilityModify')]"
          },
          {
            "route": "PUT /api/facility/{id}/statuses/{statusId}",
            "purpose": "Update facility status",
            "authorization": "[Authorize(Policy = 'FacilityModify')]"
          },
          {
            "route": "DELETE /api/facility/{id}/statuses/{statusId}",
            "purpose": "Delete facility status",
            "authorization": "[Authorize(Policy = 'FacilityModify')]"
          },
          {
            "route": "GET /api/facility/{id}/berths",
            "purpose": "Get facility berths",
            "authorization": "[Authorize(Policy = 'FacilityReadOnly')]"
          },
          {
            "route": "POST /api/facility/{id}/berths",
            "purpose": "Add facility berth",
            "authorization": "[Authorize(Policy = 'FacilityModify')]"
          },
          {
            "route": "PUT /api/facility/{id}/berths/{berthId}",
            "purpose": "Update facility berth",
            "authorization": "[Authorize(Policy = 'FacilityModify')]"
          },
          {
            "route": "DELETE /api/facility/{id}/berths/{berthId}",
            "purpose": "Delete facility berth",
            "authorization": "[Authorize(Policy = 'FacilityModify')]"
          }
        ]
      }
    },
    "modalDialogImplementation": {
      "bootstrapModals": {
        "statusModal": {
          "implementation": "Bootstrap modal or partial view",
          "trigger": "JavaScript function openStatusModal()",
          "partialView": "_StatusModal.cshtml",
          "fields": ["StatusDate (datepicker)", "StatusType (Select2)", "StatusDescription (textarea)"],
          "ajaxSubmit": true,
          "onSuccess": "Update DataTable row, close modal"
        },
        "berthModal": {
          "implementation": "Bootstrap modal or partial view",
          "trigger": "JavaScript function openBerthModal()",
          "partialView": "_BerthModal.cshtml",
          "fields": ["BerthName", "BerthNumber", "Capacity", "Length", "IsActive", "Notes"],
          "ajaxSubmit": true,
          "onSuccess": "Update DataTable row, close modal"
        }
      }
    },
    "stateManagementPatterns": {
      "clientSide": {
        "dirtyTracking": "JavaScript flag + beforeunload event",
        "validationState": "jQuery Validation plugin",
        "conditionalVisibility": "JavaScript toggle functions based on dropdown change"
      },
      "serverSide": {
        "viewModels": ["FacilitySearchViewModel", "FacilityEditViewModel"],
        "dtos": ["FacilityListDto", "FacilityStatusDto", "FacilityBerthDto"],
        "validation": "Data annotations + FluentValidation (optional)",
        "businessRules": "Service layer validation"
      }
    }
  },
  "migrationGuidance": {
    "criticalPatterns": [
      {
        "pattern": "Conditional field visibility based on Facility Type",
        "legacy": "cboFacilityType_ValueChanged toggles Lock/Gauge fields",
        "modern": "JavaScript event handler on Select2 change toggles Bootstrap form groups"
      },
      {
        "pattern": "Parent-child save transaction",
        "legacy": "Single Save button persists main entity and all child grid changes",
        "modern": "Controller action with transaction scope saves all related entities"
      },
      {
        "pattern": "Modal dialogs for child entity CRUD",
        "legacy": "WinForms modal dialogs for Status and Berth editing",
        "modern": "Bootstrap modals with partial views and AJAX submit"
      },
      {
        "pattern": "Tab access control based on parent save state",
        "legacy": "Status and Berths tabs disabled until LocationID > 0",
        "modern": "JavaScript disables Bootstrap tabs until parent saved, shows message on click"
      },
      {
        "pattern": "Unsaved changes warning",
        "legacy": "Form_Closing event checks IsDirty flag",
        "modern": "JavaScript beforeunload event checks dirty flag"
      }
    ],
    "dataFlowPatterns": [
      {
        "operation": "Search",
        "legacy": "Form -> FacilityLocationSearch class -> Stored procedure -> Grid binding",
        "modern": "View -> POST to FacilityTable -> Repository -> Dapper -> DataTables JSON response"
      },
      {
        "operation": "Load detail",
        "legacy": "Form_Load -> FacilityLocation.Fetch(id) -> Stored procedure -> Bind to controls",
        "modern": "GET Edit action -> Repository -> Dapper -> Map to ViewModel -> Render view"
      },
      {
        "operation": "Save",
        "legacy": "btnSave_Click -> FacilityLocation.Save() -> Multiple stored procedures in transaction",
        "modern": "POST Edit action -> Validate ModelState -> Service layer -> Repository -> Transaction scope -> Multiple Dapper calls"
      }
    ]
  }
}
