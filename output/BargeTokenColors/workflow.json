{
  "formName": "frmBargeTokenColors",
  "actualTableName": "ColorPair",
  "formType": "Master-Detail (Single Screen)",
  "description": "Manages barge token color pairs with live preview - master-detail pattern on single form",
  "primaryWorkflows": [
    {
      "name": "CreateNewColorPair",
      "description": "User creates a new barge token color pair",
      "steps": [
        {
          "step": 1,
          "action": "ClickAddButton",
          "trigger": "Toolbar 'Add' button click",
          "handler": "ToolbarColorPair_ToolClick -> ItemAdd()",
          "location": "frmBargeTokenColors.vb:110-111, 441-457",
          "businessLogic": "ColorPair.NewColorPair() called",
          "stateChange": "IsEditingChild = True"
        },
        {
          "step": 2,
          "action": "BeginEdit",
          "handler": "_ColorPair.BeginEdit()",
          "location": "frmBargeTokenColors.vb:447",
          "description": "Start tracking changes to new ColorPair object"
        },
        {
          "step": 3,
          "action": "LoadEmptyControls",
          "handler": "LoadControlsForColorPair()",
          "location": "frmBargeTokenColors.vb:450, 571-578",
          "description": "Initialize form controls with empty/default values"
        },
        {
          "step": 4,
          "action": "EnableEditMode",
          "handler": "EnableDisableControls(True)",
          "location": "frmBargeTokenColors.vb:453, 404-420",
          "controlChanges": [
            "grpDetail enabled",
            "ToolbarColorPair disabled",
            "All toolbar buttons disabled"
          ],
          "focusChange": "txtName.Focus()"
        },
        {
          "step": 5,
          "action": "EnterName",
          "control": "txtName",
          "maxLength": 50,
          "validation": "Required, max length 50",
          "onValidated": "txtName_Validated -> _ColorPair.Name = .Text",
          "location": "frmBargeTokenColors.vb:479-497"
        },
        {
          "step": 6,
          "action": "SelectTextColor",
          "control": "clrTextColor (ColorPicker)",
          "onColorChanged": "clrTextColor_ColorChanged -> lblSample.ForeColor updated",
          "onValidated": "clrTextColor_Validated -> _ColorPair.TextColor = .Color.Name",
          "location": "frmBargeTokenColors.vb:182-196, 500-518",
          "livePreview": "lblSample ForeColor updates in real-time"
        },
        {
          "step": 7,
          "action": "SelectBackColor",
          "control": "clrBackColor (ColorPicker)",
          "onColorChanged": "clrBackColor_ColorChanged -> lblSample.BackColor updated",
          "onValidated": "clrBackColor_Validated -> _ColorPair.BackColor = .Color.Name",
          "location": "frmBargeTokenColors.vb:198-212, 521-539",
          "livePreview": "lblSample BackColor updates in real-time"
        },
        {
          "step": 8,
          "action": "SubmitColorPair",
          "trigger": "btnDetailSubmit click",
          "handler": "btnDetailSubmit_Click -> SubmitNoRefreshClick()",
          "location": "frmBargeTokenColors.vb:130-145, 235-252",
          "businessLogic": [
            "Set FleetID if IsNew: _ColorPair.FleetID = _FleetID",
            "Call base SubmitNoRefreshClick()",
            "Validates business rules",
            "Saves to database via ColorPair.ApplyEdit()"
          ],
          "onSuccess": [
            "ClearControls()",
            "EnableDisableControls(False)",
            "RefreshList(False)"
          ],
          "location": "frmBargeTokenColors.vb:242-250"
        }
      ],
      "alternateFlow": {
        "name": "CancelCreate",
        "trigger": "btnDetailCancel click or btnClose click",
        "handler": "CancelClick()",
        "location": "frmBargeTokenColors.vb:148-163, 254-262",
        "businessLogic": "_ColorPair.CancelEdit()",
        "onCancel": [
          "ClearControls()",
          "EnableDisableControls(False)",
          "Grid selection unchanged"
        ]
      }
    },
    {
      "name": "EditExistingColorPair",
      "description": "User edits an existing color pair from the grid",
      "steps": [
        {
          "step": 1,
          "action": "SelectRowInGrid",
          "control": "grdColorPair",
          "trigger": "User clicks row in grid",
          "handler": "Grid AfterSelectChange event",
          "location": "Base form event handler",
          "stateChange": "SetToolState() called to enable/disable toolbar buttons"
        },
        {
          "step": 2,
          "action": "ClickModifyButton",
          "trigger": "Toolbar 'Modify' button click OR grid double-click",
          "handler": "ToolbarColorPair_ToolClick -> ItemModify() OR grid DoubleClick -> ItemModify()",
          "location": "frmBargeTokenColors.vb:112-113, 316-340",
          "prerequisite": "Row must be selected, IsEditingChild must be False"
        },
        {
          "step": 3,
          "action": "LoadColorPairFromDB",
          "handler": "_ColorPair = ColorPair.GetColorPair(GridControlIndex)",
          "location": "frmBargeTokenColors.vb:326",
          "description": "Fetch existing ColorPair by ID from selected row"
        },
        {
          "step": 4,
          "action": "BeginEdit",
          "handler": "_ColorPair.BeginEdit()",
          "location": "frmBargeTokenColors.vb:327",
          "description": "Start tracking changes to existing object"
        },
        {
          "step": 5,
          "action": "LoadControlsWithData",
          "handler": "LoadControlsForColorPair()",
          "location": "frmBargeTokenColors.vb:330, 571-578",
          "controlValues": [
            "txtName.Text = _ColorPair.Name",
            "clrTextColor.Color = Color.FromName(_ColorPair.TextColor)",
            "clrBackColor.Color = Color.FromName(_ColorPair.BackColor)"
          ],
          "livePreview": "lblSample displays existing color combination"
        },
        {
          "step": 6,
          "action": "EnableEditMode",
          "handler": "EnableDisableControls(True)",
          "location": "frmBargeTokenColors.vb:333, 404-420",
          "controlChanges": [
            "grpDetail enabled",
            "ToolbarColorPair disabled",
            "All toolbar buttons disabled"
          ],
          "focusChange": "txtName.Focus()"
        },
        {
          "step": 7,
          "action": "ModifyFields",
          "description": "User edits Name, TextColor, or BackColor",
          "controls": [
            "txtName - updates _ColorPair.Name on Validated event",
            "clrTextColor - updates lblSample.ForeColor on ColorChanged, _ColorPair.TextColor on Validated",
            "clrBackColor - updates lblSample.BackColor on ColorChanged, _ColorPair.BackColor on Validated"
          ],
          "livePreview": "lblSample updates in real-time as colors change"
        },
        {
          "step": 8,
          "action": "SubmitChanges",
          "trigger": "btnDetailSubmit click",
          "handler": "btnDetailSubmit_Click -> SubmitNoRefreshClick()",
          "location": "frmBargeTokenColors.vb:130-145, 235-252",
          "businessLogic": [
            "FleetID already set (existing record)",
            "Validates business rules",
            "Saves changes via ColorPair.ApplyEdit()",
            "Optimistic concurrency check via ModifyDateTime"
          ],
          "onSuccess": [
            "ClearControls()",
            "EnableDisableControls(False)",
            "RefreshList(False) - updates grid with new values"
          ]
        }
      ],
      "alternateFlow": {
        "name": "CancelEdit",
        "trigger": "btnDetailCancel click",
        "handler": "CancelClick()",
        "location": "frmBargeTokenColors.vb:148-163, 254-262",
        "businessLogic": "_ColorPair.CancelEdit() - discards all changes",
        "onCancel": [
          "ClearControls()",
          "EnableDisableControls(False)",
          "Grid selection unchanged",
          "Original values retained in database"
        ]
      }
    },
    {
      "name": "DeleteColorPair",
      "description": "User deletes a color pair from the grid",
      "steps": [
        {
          "step": 1,
          "action": "SelectRowInGrid",
          "control": "grdColorPair",
          "description": "User selects color pair to delete"
        },
        {
          "step": 2,
          "action": "ClickRemoveButton",
          "trigger": "Toolbar 'Remove' button click",
          "handler": "ToolbarColorPair_ToolClick -> ItemRemove()",
          "location": "frmBargeTokenColors.vb:114-115, 460-469",
          "prerequisite": "Row must be selected, IsEditingChild must be False"
        },
        {
          "step": 3,
          "action": "ConfirmDelete",
          "handler": "Main.ItemRemoveDialog('Color Pair')",
          "location": "frmBargeTokenColors.vb:462",
          "dialogType": "Modal confirmation dialog",
          "message": "Are you sure you want to delete this Color Pair?",
          "buttons": "Yes/No"
        },
        {
          "step": 4,
          "action": "DeleteFromDatabase",
          "condition": "User clicks 'Yes'",
          "handler": "ColorPair.DeleteColorPair(GridControlIndex)",
          "location": "frmBargeTokenColors.vb:465",
          "businessLogic": "Hard DELETE from database (no soft delete)",
          "stored_procedure": "ColorPairDelete"
        },
        {
          "step": 5,
          "action": "RefreshGrid",
          "handler": "RefreshList(False)",
          "location": "frmBargeTokenColors.vb:466",
          "result": "Grid refreshes without deleted record"
        }
      ],
      "alternateFlow": {
        "name": "CancelDelete",
        "condition": "User clicks 'No' in confirmation dialog",
        "result": "No action taken, dialog closes"
      }
    },
    {
      "name": "ExportColorPairs",
      "description": "User exports grid data to Excel",
      "steps": [
        {
          "step": 1,
          "action": "ClickExportButton",
          "trigger": "Toolbar 'Export' button click",
          "handler": "ToolbarColorPair_ToolClick -> Main.ExportGrid()",
          "location": "frmBargeTokenColors.vb:116-117",
          "prerequisite": "At least one row in grid, IsEditingChild must be False"
        },
        {
          "step": 2,
          "action": "ExportToFile",
          "handler": "Main.ExportGrid(grdColorPair, staStatus, Me.Text)",
          "description": "Common export utility exports grid to Excel file",
          "parameters": [
            "grdColorPair - grid control",
            "staStatus - status label for messages",
            "Me.Text - form title for filename"
          ]
        }
      ]
    },
    {
      "name": "ViewColorPairs",
      "description": "User views list of color pairs for fleet",
      "steps": [
        {
          "step": 1,
          "action": "FormLoad",
          "trigger": "frmBargeTokenColors_Load",
          "handler": "frmBargeTokenColors_Load",
          "location": "frmBargeTokenColors.vb:79-101",
          "sequence": [
            "FormatControls()",
            "RefreshList(True)"
          ]
        },
        {
          "step": 2,
          "action": "InitializeControls",
          "handler": "FormatControls()",
          "location": "frmBargeTokenColors.vb:382-402",
          "actions": [
            "Disable column chooser",
            "Set unique identifier column: ColorPairID",
            "Set initial sort: Name Ascending",
            "SetValidatorExtenderForColorPair()",
            "SetMaxLengthsForColorPair()",
            "EnableDisableControls(False) - start in view mode"
          ]
        },
        {
          "step": 3,
          "action": "LoadGridData",
          "handler": "RefreshList(True)",
          "location": "frmBargeTokenColors.vb:423-428",
          "businessLogic": "ColorPairList.GetList(_FleetID).List",
          "parameters": {
            "selectFirstRow": true,
            "FleetID": "_FleetID (passed to form on initialization)"
          },
          "result": "Grid populated with ColorPair records for fleet, first row selected"
        },
        {
          "step": 4,
          "action": "UpdateToolbarState",
          "handler": "SetToolState(grdColorPair)",
          "location": "frmBargeTokenColors.vb:342-376",
          "buttonLogic": [
            "Add: Enabled if not editing AND user has Add permission",
            "Modify: Enabled if row selected AND not editing AND user has Open permission",
            "Remove: Enabled if row selected AND not editing AND user has Remove permission",
            "Export: Enabled if at least one row AND not editing AND user has Open permission"
          ]
        }
      ]
    },
    {
      "name": "CloseForm",
      "description": "User closes the form",
      "steps": [
        {
          "step": 1,
          "action": "ClickCloseButton",
          "trigger": "btnClose click OR window close (X)",
          "handler": "btnClose_Click -> CancelClick() OR WndProc -> CancelClick()",
          "location": "frmBargeTokenColors.vb:166-180, 264-279"
        },
        {
          "step": 2,
          "action": "CheckForUnsavedChanges",
          "handler": "CancelClick() -> MyBase.CancelClick(DirectCast(_ColorPair, BusinessLogicBase), True)",
          "location": "frmBargeTokenColors.vb:278",
          "businessLogic": "Base form checks if _ColorPair has unsaved changes"
        },
        {
          "step": 3,
          "action": "PromptToSave",
          "condition": "Unsaved changes exist",
          "dialogType": "Modal confirmation dialog",
          "message": "You have unsaved changes. Do you want to save them?",
          "buttons": "Yes/No/Cancel",
          "handler": "Base form CancelClick logic"
        },
        {
          "step": 4,
          "action": "CloseForm",
          "condition": "User clicks 'No' OR no changes OR save successful",
          "result": "Form closes"
        }
      ],
      "alternateFlow": {
        "name": "SaveBeforeClose",
        "condition": "User clicks 'Yes' in unsaved changes dialog",
        "handler": "Base form saves changes before closing",
        "result": "Changes saved, form closes"
      }
    }
  ],
  "formStates": [
    {
      "state": "Initial",
      "description": "Form first loaded, displaying grid of color pairs",
      "detailSection": "Disabled (grpDetail)",
      "toolbar": "Enabled",
      "gridState": "Populated with ColorPairList for FleetID, first row selected",
      "enabledButtons": [
        "Add (if user has Add permission)",
        "Modify (if row selected and user has Open permission)",
        "Remove (if row selected and user has Remove permission)",
        "Export (if rows exist and user has Open permission)"
      ],
      "IsEditingChild": false,
      "businessObject": "_ColorPair = Nothing initially"
    },
    {
      "state": "Editing (New)",
      "description": "User creating new color pair",
      "detailSection": "Enabled (grpDetail)",
      "toolbar": "Disabled",
      "gridState": "Disabled for interaction",
      "enabledButtons": [
        "Submit (btnDetailSubmit)",
        "Cancel (btnDetailCancel)",
        "Close (btnClose)"
      ],
      "disabledButtons": [
        "Add",
        "Modify",
        "Remove",
        "Export"
      ],
      "IsEditingChild": true,
      "businessObject": "_ColorPair = ColorPair.NewColorPair(), BeginEdit() called",
      "focus": "txtName",
      "livePreview": "lblSample updates as colors selected"
    },
    {
      "state": "Editing (Existing)",
      "description": "User editing existing color pair",
      "detailSection": "Enabled (grpDetail)",
      "toolbar": "Disabled",
      "gridState": "Disabled for interaction",
      "enabledButtons": [
        "Submit (btnDetailSubmit)",
        "Cancel (btnDetailCancel)",
        "Close (btnClose)"
      ],
      "disabledButtons": [
        "Add",
        "Modify",
        "Remove",
        "Export"
      ],
      "IsEditingChild": true,
      "businessObject": "_ColorPair = ColorPair.GetColorPair(ID), BeginEdit() called",
      "focus": "txtName",
      "livePreview": "lblSample updates as colors selected"
    },
    {
      "state": "ConfirmingDelete",
      "description": "User confirming deletion of color pair",
      "modalDialog": "Main.ItemRemoveDialog('Color Pair')",
      "buttons": "Yes/No",
      "parentFormState": "Disabled (modal dialog)"
    }
  ],
  "eventHandlerChains": [
    {
      "trigger": "Form Load",
      "eventHandler": "frmBargeTokenColors_Load",
      "location": "frmBargeTokenColors.vb:79-101",
      "chain": [
        "FormatControls()",
        "  -> EnableDisableColumnChooser(grdColorPair, False)",
        "  -> GridControlUniqueIdentifierCol(grdColorPair) = 'ColorPairID'",
        "  -> AddToInitialColumnSortOrder(grdColorPair, 'Name', Ascending)",
        "  -> SetValidatorExtenderForColorPair()",
        "  -> SetMaxLengthsForColorPair()",
        "  -> EnableDisableControls(False)",
        "RefreshList(True)",
        "  -> RefreshListBase(grdColorPair, True, ColorPairList.GetList(_FleetID).List)",
        "  -> SetToolState(grdColorPair)"
      ]
    },
    {
      "trigger": "Toolbar Add Button Click",
      "eventHandler": "ToolbarColorPair_ToolClick",
      "location": "frmBargeTokenColors.vb:103-128",
      "chain": [
        "ItemAdd()",
        "  -> ColorPair.NewColorPair()",
        "  -> _ColorPair.BeginEdit()",
        "  -> LoadControlsForColorPair()",
        "  -> EnableDisableControls(True)",
        "    -> SetState(grpDetail, Enabled)",
        "    -> ToolbarColorPair.Enabled = False",
        "    -> SetIsEditingChild = True",
        "    -> SetToolState(grdColorPair) - disables all toolbar buttons",
        "  -> txtName.Focus()"
      ]
    },
    {
      "trigger": "Toolbar Modify Button Click OR Grid Double-Click",
      "eventHandler": "ToolbarColorPair_ToolClick OR grid DoubleClick",
      "location": "frmBargeTokenColors.vb:103-128, 316-340",
      "chain": [
        "ItemModify(grdColorPair)",
        "  -> Check IsEditingChild (exit if True)",
        "  -> Check HasRowSelected (exit if False)",
        "  -> _ColorPair = ColorPair.GetColorPair(GridControlIndex)",
        "  -> _ColorPair.BeginEdit()",
        "  -> LoadControlsForColorPair()",
        "    -> txtName.Text = _ColorPair.Name",
        "    -> clrTextColor.Color = Color.FromName(_ColorPair.TextColor)",
        "    -> clrBackColor.Color = Color.FromName(_ColorPair.BackColor)",
        "  -> EnableDisableControls(True)",
        "    -> SetState(grpDetail, Enabled)",
        "    -> ToolbarColorPair.Enabled = False",
        "    -> SetIsEditingChild = True",
        "    -> SetToolState(grdColorPair) - disables all toolbar buttons",
        "  -> txtName.Focus()"
      ]
    },
    {
      "trigger": "Toolbar Remove Button Click",
      "eventHandler": "ToolbarColorPair_ToolClick",
      "location": "frmBargeTokenColors.vb:103-128",
      "chain": [
        "ItemRemove()",
        "  -> Main.ItemRemoveDialog('Color Pair') - shows modal confirmation",
        "  -> If DialogResult.Yes:",
        "    -> ColorPair.DeleteColorPair(GridControlIndex)",
        "    -> RefreshList(False)",
        "      -> RefreshListBase(grdColorPair, False, ColorPairList.GetList(_FleetID).List)",
        "      -> SetToolState(grdColorPair)"
      ]
    },
    {
      "trigger": "Toolbar Export Button Click",
      "eventHandler": "ToolbarColorPair_ToolClick",
      "location": "frmBargeTokenColors.vb:103-128",
      "chain": [
        "Main.ExportGrid(grdColorPair, staStatus, Me.Text)",
        "  -> Common export utility handles Excel export"
      ]
    },
    {
      "trigger": "Submit Button Click",
      "eventHandler": "btnDetailSubmit_Click",
      "location": "frmBargeTokenColors.vb:130-145",
      "chain": [
        "SubmitNoRefreshClick(_ColorPair, False)",
        "  -> If _ColorPair.IsNew Then _ColorPair.FleetID = _FleetID",
        "  -> MyBase.SubmitNoRefreshClick(businessObject, False)",
        "    -> Validates business rules (_ColorPair.IsValid)",
        "    -> _ColorPair.ApplyEdit() - saves to database",
        "  -> If success:",
        "    -> ClearControls()",
        "      -> staStatus.Text = Empty",
        "      -> txtName.Text = Empty",
        "      -> clrTextColor.Color = Empty",
        "      -> clrBackColor.Color = Empty",
        "    -> EnableDisableControls(False)",
        "      -> SetState(grpDetail, Disabled)",
        "      -> ToolbarColorPair.Enabled = True",
        "      -> SetIsEditingChild = False",
        "      -> SetToolState(grdColorPair) - re-enables toolbar buttons",
        "    -> RefreshList(False)",
        "      -> RefreshListBase(grdColorPair, False, ColorPairList.GetList(_FleetID).List)",
        "      -> SetToolState(grdColorPair)"
      ]
    },
    {
      "trigger": "Cancel Button Click",
      "eventHandler": "btnDetailCancel_Click",
      "location": "frmBargeTokenColors.vb:148-163",
      "chain": [
        "CancelClick(_ColorPair, False)",
        "  -> MyBase.CancelClick(businessObject, False)",
        "    -> Prompts user if unsaved changes exist",
        "    -> _ColorPair.CancelEdit() - discards changes",
        "  -> If success:",
        "    -> ClearControls()",
        "    -> EnableDisableControls(False)",
        "      -> SetState(grpDetail, Disabled)",
        "      -> ToolbarColorPair.Enabled = True",
        "      -> SetIsEditingChild = False",
        "      -> SetToolState(grdColorPair) - re-enables toolbar buttons"
      ]
    },
    {
      "trigger": "Close Button Click OR Window Close (X)",
      "eventHandler": "btnClose_Click OR WndProc",
      "location": "frmBargeTokenColors.vb:166-180, 264-279",
      "chain": [
        "CancelClick() (parameterless override)",
        "  -> MyBase.CancelClick(DirectCast(_ColorPair, BusinessLogicBase), True)",
        "    -> Prompts user if unsaved changes exist",
        "    -> _ColorPair.CancelEdit() if changes discarded",
        "  -> Form closes if user confirms"
      ]
    },
    {
      "trigger": "TextColor ColorPicker Changed",
      "eventHandler": "clrTextColor_ColorChanged",
      "location": "frmBargeTokenColors.vb:182-196",
      "chain": [
        "lblSample.ForeColor = clrTextColor.Color",
        "  -> Live preview updates immediately"
      ],
      "notes": "Real-time visual feedback, does not update business object until Validated"
    },
    {
      "trigger": "TextColor ColorPicker Validated",
      "eventHandler": "clrTextColor_Validated",
      "location": "frmBargeTokenColors.vb:500-518",
      "chain": [
        "If enabled and not readonly:",
        "  -> _ColorPair.TextColor = clrTextColor.Color.Name",
        "  -> clrTextColor.Color = Color.FromName(_ColorPair.TextColor)",
        "    -> Ensures color roundtrips correctly through .Name property"
      ]
    },
    {
      "trigger": "BackColor ColorPicker Changed",
      "eventHandler": "clrBackColor_ColorChanged",
      "location": "frmBargeTokenColors.vb:198-212",
      "chain": [
        "lblSample.BackColor = clrBackColor.Color",
        "  -> Live preview updates immediately"
      ],
      "notes": "Real-time visual feedback, does not update business object until Validated"
    },
    {
      "trigger": "BackColor ColorPicker Validated",
      "eventHandler": "clrBackColor_Validated",
      "location": "frmBargeTokenColors.vb:521-539",
      "chain": [
        "If enabled and not readonly:",
        "  -> _ColorPair.BackColor = clrBackColor.Color.Name",
        "  -> clrBackColor.Color = Color.FromName(_ColorPair.BackColor)",
        "    -> Ensures color roundtrips correctly through .Name property"
      ]
    },
    {
      "trigger": "Name TextBox Validated",
      "eventHandler": "txtName_Validated",
      "location": "frmBargeTokenColors.vb:479-497",
      "chain": [
        "If enabled and not readonly:",
        "  -> _ColorPair.Name = txtName.Text",
        "  -> txtName.Text = _ColorPair.Name",
        "    -> Ensures any business logic transformations reflected in UI"
      ]
    },
    {
      "trigger": "Grid Selection Changed",
      "eventHandler": "Grid AfterSelectChange (base form)",
      "chain": [
        "SetToolState(grdColorPair)",
        "  -> Evaluates itemIsSelected = HasRowSelected(gridControl)",
        "  -> Evaluates atLeastOneRow = (Rows.Count > 0)",
        "  -> Updates toolbar button states:",
        "    -> Add: Enabled if not editing AND authorized",
        "    -> Modify: Enabled if row selected AND not editing AND authorized",
        "    -> Remove: Enabled if row selected AND not editing AND authorized",
        "    -> Export: Enabled if at least one row AND not editing AND authorized"
      ]
    }
  ],
  "stateManagement": {
    "formLevelState": {
      "IsEditingChild": {
        "type": "Boolean property inherited from base form",
        "purpose": "Tracks whether form is in edit mode",
        "setVia": "SetIsEditingChild property",
        "usedIn": [
          "ItemAdd() - set to True",
          "ItemModify() - check before editing",
          "EnableDisableControls() - toggles state",
          "SetToolState() - controls button enabling"
        ]
      },
      "_ColorPair": {
        "type": "BusinessLogic.ColorPair",
        "scope": "Private module-level variable",
        "lifecycle": [
          "Set to Nothing initially",
          "Set to NewColorPair() in ItemAdd()",
          "Set to GetColorPair(ID) in ItemModify()",
          "BeginEdit() called to start change tracking",
          "ApplyEdit() called on submit to save",
          "CancelEdit() called on cancel to discard changes"
        ]
      },
      "_FleetID": {
        "type": "Int32",
        "scope": "Private module-level variable",
        "purpose": "Scopes color pairs to specific fleet",
        "setVia": "Initialize(FleetID) method",
        "usedIn": [
          "RefreshList() - filters ColorPairList.GetList(_FleetID)",
          "SubmitNoRefreshClick() - sets _ColorPair.FleetID if IsNew"
        ]
      },
      "_ToolbarButtonTypes": {
        "type": "System.Collections.Hashtable",
        "purpose": "Maps toolbar button keys to ButtonType enum for authorization",
        "populatedIn": "SetButtonTypes()",
        "usedIn": "SetToolState() via ControlAuthorization.ToolbarButtonCanBeEnabled()"
      }
    },
    "gridState": {
      "grdColorPair": {
        "uniqueIdentifier": "ColorPairID",
        "dataSource": "ColorPairList.GetList(_FleetID).List",
        "defaultSort": "Name Ascending",
        "selectionMode": "Single row",
        "statePreservation": "Grid state saved via UserAppSettings (base form)",
        "refreshTriggers": [
          "Form Load - RefreshList(True) selects first row",
          "After Save - RefreshList(False) maintains selection",
          "After Delete - RefreshList(False) maintains selection if possible"
        ]
      }
    },
    "controlState": {
      "grpDetail": {
        "states": [
          "Disabled - when not editing (view mode)",
          "Enabled - when editing (add/modify mode)"
        ],
        "controlledBy": "EnableDisableControls(Boolean)"
      },
      "ToolbarColorPair": {
        "states": [
          "Enabled - when not editing",
          "Disabled - when editing"
        ],
        "controlledBy": "EnableDisableControls(Boolean)"
      },
      "toolbar buttons": {
        "Add": {
          "enabledWhen": "Not editing AND user has Add permission",
          "authorizedVia": "ButtonType.Add"
        },
        "Modify": {
          "enabledWhen": "Row selected AND not editing AND user has Open permission",
          "authorizedVia": "ButtonType.Open",
          "notes": "Uses ButtonType.Open instead of ButtonType.Modify"
        },
        "Remove": {
          "enabledWhen": "Row selected AND not editing AND user has Remove permission",
          "authorizedVia": "ButtonType.Remove"
        },
        "Export": {
          "enabledWhen": "At least one row AND not editing AND user has Open permission",
          "authorizedVia": "ButtonType.Open"
        }
      },
      "detail buttons": {
        "btnDetailSubmit": {
          "enabledWhen": "Always enabled when detail section enabled",
          "authorizedVia": "ButtonType.Submit"
        },
        "btnDetailCancel": {
          "enabledWhen": "Always enabled when detail section enabled",
          "authorizedVia": "ButtonType.CancelEdit"
        },
        "btnClose": {
          "enabledWhen": "Always enabled",
          "authorizedVia": "ButtonType.Cancel"
        }
      }
    },
    "livePreviewState": {
      "lblSample": {
        "purpose": "Real-time visual preview of color combination",
        "ForeColor": "Updated immediately when clrTextColor.ColorChanged fires",
        "BackColor": "Updated immediately when clrBackColor.ColorChanged fires",
        "updateTiming": "Before business object updated (provides instant feedback)"
      }
    }
  },
  "modalDialogPatterns": [
    {
      "dialogType": "Delete Confirmation",
      "trigger": "ItemRemove() when user clicks Remove button",
      "handler": "Main.ItemRemoveDialog('Color Pair')",
      "location": "frmBargeTokenColors.vb:462",
      "message": "Are you sure you want to delete this Color Pair?",
      "buttons": [
        {
          "button": "Yes",
          "result": "DialogResult.Yes",
          "action": "ColorPair.DeleteColorPair(ID) called, grid refreshed"
        },
        {
          "button": "No",
          "result": "DialogResult.No",
          "action": "No operation, dialog closes"
        }
      ],
      "modalBehavior": "Blocks parent form until user responds"
    },
    {
      "dialogType": "Unsaved Changes Confirmation",
      "trigger": "CancelClick() when _ColorPair has unsaved changes",
      "handler": "Base form CancelClick logic",
      "location": "Base form implementation",
      "message": "You have unsaved changes. Do you want to save them?",
      "buttons": [
        {
          "button": "Yes",
          "result": "Save changes before closing/canceling",
          "action": "ApplyEdit() called, then proceed with close/cancel"
        },
        {
          "button": "No",
          "result": "Discard changes",
          "action": "CancelEdit() called, changes discarded"
        },
        {
          "button": "Cancel",
          "result": "Stay on form",
          "action": "No operation, return to editing"
        }
      ],
      "modalBehavior": "Blocks parent form until user responds",
      "notes": "Only shown when _ColorPair.IsDirty = True"
    },
    {
      "dialogType": "Validation Error",
      "trigger": "SubmitNoRefreshClick() when business rules violated",
      "handler": "Base form validation logic via ValidatorExtender",
      "displayControl": "staStatus (status label)",
      "modalBehavior": "Non-modal - displays error message in status label",
      "commonErrors": [
        "Name is required",
        "Name cannot exceed 50 characters",
        "TextColor is required (or is '0')",
        "BackColor is required (or is '0')"
      ]
    }
  ],
  "refreshUpdateTriggers": [
    {
      "trigger": "Form Load",
      "handler": "frmBargeTokenColors_Load -> RefreshList(True)",
      "location": "frmBargeTokenColors.vb:85",
      "refreshTarget": "grdColorPair",
      "selectFirstRow": true,
      "businessLogic": "ColorPairList.GetList(_FleetID).List"
    },
    {
      "trigger": "After Save (Create or Edit)",
      "handler": "SubmitNoRefreshClick -> RefreshList(False)",
      "location": "frmBargeTokenColors.vb:249",
      "refreshTarget": "grdColorPair",
      "selectFirstRow": false,
      "preserveSelection": "Attempts to maintain previous selection",
      "businessLogic": "ColorPairList.GetList(_FleetID).List"
    },
    {
      "trigger": "After Delete",
      "handler": "ItemRemove -> RefreshList(False)",
      "location": "frmBargeTokenColors.vb:466",
      "refreshTarget": "grdColorPair",
      "selectFirstRow": false,
      "preserveSelection": "Attempts to select next row",
      "businessLogic": "ColorPairList.GetList(_FleetID).List"
    },
    {
      "trigger": "Grid Selection Changed",
      "handler": "Grid AfterSelectChange -> SetToolState(grdColorPair)",
      "location": "Base form event + frmBargeTokenColors.vb:342-376",
      "refreshTarget": "Toolbar button states",
      "businessLogic": "Evaluates security and selection state"
    },
    {
      "trigger": "Edit Mode Change",
      "handler": "EnableDisableControls -> SetToolState(grdColorPair)",
      "location": "frmBargeTokenColors.vb:419",
      "refreshTarget": "Toolbar button states",
      "businessLogic": "Disables all toolbar buttons when editing, re-enables when not editing"
    }
  ],
  "colorManagementPattern": {
    "description": "Critical pattern for color storage and display",
    "storageFormat": "System.Drawing.Color.Name (string)",
    "displayFormat": "System.Drawing.Color object",
    "conversion": {
      "toBusinessObject": ".Color.Name property extracts color name string",
      "toUI": "Color.FromName() converts string back to Color object"
    },
    "livePreview": {
      "control": "lblSample",
      "updateOn": "ColorChanged event (immediate)",
      "businessObjectUpdateOn": "Validated event (deferred)"
    },
    "eventSequence": [
      "1. User selects color in clrTextColor picker",
      "2. ColorChanged event fires -> lblSample.ForeColor updated immediately",
      "3. User tabs out or clicks elsewhere",
      "4. Validated event fires -> _ColorPair.TextColor = .Color.Name",
      "5. Business object updated with color name string"
    ],
    "modernConversionNotes": [
      "HTML5 color input uses hex (#RRGGBB) format",
      "Must convert between hex (web) and color names (database)",
      "Need bidirectional conversion helper",
      "DTO should include both colorName and colorHex fields"
    ]
  },
  "securityPatterns": {
    "authorization": {
      "subsystem": "SubSystem.None",
      "location": "frmBargeTokenColors.vb:33",
      "notes": "No subsystem-level authorization - form-level only"
    },
    "buttonSecurity": {
      "method": "ControlAuthorization.ToolbarButtonCanBeEnabled",
      "pattern": "Runtime check using ButtonType and hashtable lookup",
      "location": "frmBargeTokenColors.vb:357, 360, 363, 367",
      "buttonTypes": {
        "Add": "ButtonType.Add",
        "Modify": "ButtonType.Open (not Modify)",
        "Remove": "ButtonType.Remove",
        "Export": "ButtonType.Open",
        "Submit": "ButtonType.Submit",
        "Cancel": "ButtonType.CancelEdit",
        "Close": "ButtonType.Cancel"
      }
    }
  },
  "concurrencyControl": {
    "pattern": "Optimistic concurrency via ModifyDateTime",
    "implementation": "ColorPairUpdate stored procedure checks ModifyDateTime in WHERE clause",
    "location": "Database layer - ColorPairUpdate procedure",
    "errorHandling": "HandleNoRowsAffected throws error if concurrent update detected",
    "modernEquivalent": "Include ModifyDateTime in hidden field, validate on update"
  },
  "navigationPatterns": {
    "formInitialization": {
      "entry": "Form called with Initialize(FleetID)",
      "parameters": {
        "FleetID": "Scopes color pairs to specific fleet"
      },
      "noReturnUrl": "This is a master-detail form, not a search/edit form pair"
    },
    "internalNavigation": {
      "viewMode": "Grid visible, detail section disabled",
      "editMode": "Grid disabled for interaction, detail section enabled",
      "modalDialogs": "Delete confirmation, unsaved changes prompt"
    }
  },
  "validationPatterns": {
    "clientSide": {
      "validatorExtender": {
        "displayControl": "staStatus",
        "validatedControls": {
          "txtName": "ValidationTypeConstants.String"
        },
        "location": "frmBargeTokenColors.vb:546-554"
      },
      "maxLengths": {
        "txtName": "ColorPair.MaxLength.Name (50)"
      }
    },
    "serverSide": {
      "businessRules": "ColorPair.IsValid checks BrokenRules collection",
      "rules": [
        "Name required",
        "Name max length 50",
        "TextColor required and not '0'",
        "BackColor required and not '0'",
        "FleetID required"
      ]
    }
  },
  "userExperiencePatterns": {
    "defaultFocus": {
      "onAdd": "txtName after ItemAdd()",
      "onModify": "txtName after ItemModify()"
    },
    "livePreview": {
      "control": "lblSample",
      "updates": "Real-time as color pickers change",
      "text": "Static 'Sample' text",
      "styling": "ForeColor and BackColor updated immediately"
    },
    "gridInteraction": {
      "doubleClick": "Opens item for editing (ItemModify)",
      "singleClick": "Selects row, updates toolbar state",
      "defaultSort": "Name Ascending"
    },
    "toolbarLayout": {
      "buttons": [
        "Add",
        "Modify",
        "Remove",
        "Export"
      ],
      "enabledState": "Dynamic based on selection and security"
    },
    "cursorFeedback": {
      "pattern": "WaitCursor during all operations",
      "location": "Try-Finally blocks throughout form"
    }
  },
  "errorHandling": {
    "pattern": "Try-Catch-Finally with ExceptionManager.Publish",
    "location": "All event handlers",
    "cursorManagement": "Finally blocks ensure Cursor.Default restored",
    "formClosing": {
      "onLoadError": "Attempt to close form",
      "location": "frmBargeTokenColors.vb:89-94"
    }
  },
  "migrationConsiderations": {
    "formPattern": {
      "legacy": "Master-detail on single screen",
      "modern": "Separate Index (grid) and Edit (form) views",
      "challenge": "Need to split into two views while maintaining UX"
    },
    "colorPickers": {
      "legacy": "Windows Forms ColorPicker control",
      "modern": "HTML5 color input (hex format)",
      "challenge": "Database stores color names, web uses hex - need conversion layer"
    },
    "livePreview": {
      "legacy": "lblSample label updates via ColorChanged events",
      "modern": "Bootstrap card with JavaScript event handlers",
      "implementation": "updateColorPreview() JavaScript function"
    },
    "gridRefresh": {
      "legacy": "RefreshList() repopulates grid from database",
      "modern": "DataTables AJAX reload with server-side processing",
      "implementation": "dataTable.ajax.reload() after save/delete"
    },
    "modalDialogs": {
      "legacy": "Windows Forms MessageBox and custom dialogs",
      "modern": "JavaScript confirm() or Bootstrap modals",
      "implementation": "onclick='return confirm()' or modal dialog component"
    },
    "validation": {
      "legacy": "ValidatorExtender with status label display",
      "modern": "jQuery Validate + Unobtrusive Validation",
      "implementation": "asp-validation-for tag helpers + client-side validation"
    },
    "security": {
      "legacy": "ButtonType enum with runtime checks",
      "modern": "[Authorize(Policy)] attributes and Razor conditionals",
      "implementation": "@if (User.HasPermission()) for button visibility"
    },
    "fleetScoping": {
      "legacy": "_FleetID module-level variable",
      "modern": "User context or ViewBag/ViewModel property",
      "implementation": "Controller sets FleetID from user's business unit or session"
    }
  },
  "testingConsiderations": [
    {
      "area": "Color conversion accuracy",
      "test": "Verify color name to hex and hex to color name conversions",
      "validation": "Common colors (Red, Blue, Green) convert correctly both directions"
    },
    {
      "area": "Live preview updates",
      "test": "Color pickers update preview in real-time",
      "validation": "lblSample (modern: preview card) updates immediately on ColorChanged"
    },
    {
      "area": "State transitions",
      "test": "Verify form state changes correctly",
      "scenarios": [
        "View -> Add -> Cancel -> View",
        "View -> Modify -> Submit -> View",
        "View -> Modify -> Cancel -> View",
        "View -> Delete (confirm) -> View",
        "View -> Delete (cancel) -> View"
      ]
    },
    {
      "area": "Grid refresh",
      "test": "Grid updates after save/delete",
      "validation": "New/modified records appear in grid, deleted records removed"
    },
    {
      "area": "Toolbar state",
      "test": "Toolbar buttons enable/disable correctly",
      "validation": "Button state matches selection, edit mode, and security"
    },
    {
      "area": "Unsaved changes prompt",
      "test": "Prompt appears when closing/canceling with unsaved changes",
      "validation": "User can save, discard, or stay on form"
    },
    {
      "area": "Fleet scoping",
      "test": "Only color pairs for current fleet displayed",
      "validation": "ColorPairList.GetList(_FleetID) filters correctly"
    },
    {
      "area": "Optimistic concurrency",
      "test": "Concurrent updates detected",
      "validation": "ModifyDateTime mismatch prevents save, shows error"
    }
  ],
  "commonMistakes": [
    "❌ Not converting between hex (web) and color names (database)",
    "❌ Missing live preview update on color change",
    "❌ Not disabling toolbar when in edit mode",
    "❌ Forgetting to set FleetID on new records before save",
    "❌ Not refreshing grid after save/delete",
    "❌ Missing unsaved changes prompt on close/cancel",
    "❌ Not checking IsEditingChild before allowing add/modify/delete",
    "❌ Using ButtonType.Modify instead of ButtonType.Open for Modify button",
    "❌ Not preserving grid selection after refresh",
    "❌ Missing optimistic concurrency check with ModifyDateTime"
  ],
  "notes": [
    "Form uses master-detail pattern on single screen (not separate search/edit forms)",
    "Live preview is critical UX feature - must update on color change",
    "Colors stored as .NET color names in database, must convert to/from hex for web",
    "FleetID required but not set on NewColorPair - set before save in SubmitNoRefreshClick",
    "Hard delete operation (no soft delete/IsActive column)",
    "Grid refreshes after save/delete to show updated data",
    "Optimistic concurrency via ModifyDateTime in UPDATE procedure",
    "IsEditingChild property controls form state and toolbar enabling",
    "Toolbar disabled when editing, detail section disabled when viewing",
    "Grid selection triggers toolbar state update via SetToolState",
    "BaseDetailEdit interface requires Initialize and SetButtonTypes implementation",
    "SubSystem.None means no search-screen-level authorization",
    "Uses ButtonType.Open for both Modify and Export buttons (not ButtonType.Modify)",
    "Delete confirmation uses Main.ItemRemoveDialog utility",
    "Export uses Main.ExportGrid utility",
    "Form closes only when user confirms unsaved changes dialog (if changes exist)",
    "GridControlUniqueIdentifierCol = 'ColorPairID' enables row reselection after refresh",
    "Initial sort: Name Ascending via AddToInitialColumnSortOrder",
    "ValidatorExtender displays errors in staStatus label",
    "All event handlers use Try-Catch-Finally with WaitCursor pattern"
  ]
}
