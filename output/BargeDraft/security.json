{
  "entity": "BargeDraft",
  "businessObject": "Draft",
  "description": "Barge draft measurements and draft survey tonnage calculations. This is a business object (not a UI form) accessed through BargeEvent and TicketEvent entities.",
  "legacy": {
    "formName": null,
    "subsystem": "General",
    "note": "Draft is a business object (Draft.vb) with no direct UI form. Access controlled through parent entities (BargeEvent/TicketEvent) which have their own security.",
    "securityContext": "Draft records are accessed when users interact with BargeEvent or TicketEvent entities. Security is enforced at the parent event level.",
    "securityButtons": [],
    "licenseRestrictions": [
      {
        "license": "Freight",
        "feature": "DraftSurveyCalculations",
        "description": "Draft survey average draft and tonnage calculations require Freight license",
        "code": "_IsFreightActive OrElse _IsTowingActive",
        "businessRules": [
          "DraftAverageRangeValidation",
          "DraftAverageInchesRangeValidation"
        ]
      },
      {
        "license": "Towing",
        "feature": "DraftSurveyCalculations",
        "description": "Draft survey average draft and tonnage calculations require Towing license",
        "code": "_IsFreightActive OrElse _IsTowingActive",
        "businessRules": [
          "DraftAverageRangeValidation",
          "DraftAverageInchesRangeValidation"
        ]
      }
    ],
    "parentEntitySecurity": [
      {
        "entity": "BargeEvent",
        "relationship": "Draft measurements stored on BargeEvent",
        "securityInheritance": "Draft CRUD operations inherit BargeEvent permissions"
      },
      {
        "entity": "TicketEvent",
        "relationship": "Draft survey events use Draft object for calculations",
        "securityInheritance": "Draft CRUD operations inherit TicketEvent permissions"
      }
    ]
  },
  "modern": {
    "api": {
      "authentication": "ApiKey",
      "attributePattern": "[ApiKey]",
      "note": "Draft is not exposed as a standalone API endpoint. It is accessed as a nested property of BargeEvent or TicketEvent API endpoints.",
      "endpoints": [
        {
          "method": "GET",
          "route": "api/BargeEvent/{id}",
          "action": "GetBargeEvent",
          "requiredAuth": "ApiKey",
          "nestedAccess": "BargeEvent.Draft",
          "futurePermission": "BargeEventView",
          "description": "Access Draft data through BargeEvent endpoint"
        },
        {
          "method": "PUT",
          "route": "api/BargeEvent/{id}",
          "action": "UpdateBargeEvent",
          "requiredAuth": "ApiKey",
          "nestedAccess": "BargeEvent.Draft",
          "futurePermission": "BargeEventModify",
          "description": "Update Draft data through BargeEvent endpoint"
        },
        {
          "method": "GET",
          "route": "api/TicketEvent/{id}",
          "action": "GetTicketEvent",
          "requiredAuth": "ApiKey",
          "nestedAccess": "TicketEvent.Draft",
          "futurePermission": "TicketEventView",
          "description": "Access Draft data through TicketEvent endpoint (for draft survey events)"
        },
        {
          "method": "PUT",
          "route": "api/TicketEvent/{id}",
          "action": "UpdateTicketEvent",
          "requiredAuth": "ApiKey",
          "nestedAccess": "TicketEvent.Draft",
          "futurePermission": "TicketEventModify",
          "description": "Update Draft data through TicketEvent endpoint (for draft survey events)"
        }
      ]
    },
    "ui": {
      "authentication": "OIDC",
      "developmentAuth": "DevelopmentAutoSignInMiddleware",
      "attributePattern": "[Authorize]",
      "note": "Draft data is displayed and edited within BargeEvent and TicketEvent UI forms. No standalone Draft UI exists.",
      "permissions": [
        {
          "name": "BargeEventView",
          "enumValue": "AuthPermissions.BargeEventView",
          "description": "View barge events including draft measurements",
          "granularity": "ReadOnly",
          "requiredFor": ["View BargeEvent with Draft data"],
          "scope": "Parent entity permission - covers nested Draft access"
        },
        {
          "name": "BargeEventModify",
          "enumValue": "AuthPermissions.BargeEventModify",
          "description": "Create and modify barge events including draft measurements",
          "granularity": "Modify",
          "requiredFor": ["Edit BargeEvent Draft fields", "Create BargeEvent with Draft"],
          "scope": "Parent entity permission - covers nested Draft modifications"
        },
        {
          "name": "TicketEventView",
          "enumValue": "AuthPermissions.TicketEventView",
          "description": "View ticket events including draft survey data",
          "granularity": "ReadOnly",
          "requiredFor": ["View TicketEvent Draft Survey", "View Draft calculations"],
          "scope": "Parent entity permission - covers nested Draft access"
        },
        {
          "name": "TicketEventModify",
          "enumValue": "AuthPermissions.TicketEventModify",
          "description": "Create and modify ticket events including draft survey data",
          "granularity": "Modify",
          "requiredFor": ["Edit Draft Survey Event", "Update Draft measurements", "Modify tonnage calculations"],
          "scope": "Parent entity permission - covers nested Draft modifications"
        },
        {
          "name": "DraftSurveyCalculations",
          "enumValue": "AuthPermissions.DraftSurveyCalculations",
          "description": "Access draft survey tonnage calculation features (requires Freight or Towing license)",
          "granularity": "Feature",
          "requiredFor": ["Calculate average draft", "Calculate tonnage from draft", "Calculate draft from tonnage", "View EstimatedCargoDeadweight", "View LightshipCorrection"],
          "licenseRequirement": "Freight OR Towing",
          "scope": "Feature-level permission for advanced draft survey calculations",
          "note": "This permission is license-gated and only enforced when Freight or Towing license is active"
        }
      ]
    },
    "permissionEnum": {
      "file": "Enums/AuthPermissions.cs",
      "note": "Draft does not have standalone permissions. Access is controlled through parent entities (BargeEvent, TicketEvent).",
      "entries": [
        {
          "name": "BargeEventView",
          "description": "View barge events (includes draft data)"
        },
        {
          "name": "BargeEventModify",
          "description": "Modify barge events (includes draft data)"
        },
        {
          "name": "TicketEventView",
          "description": "View ticket events (includes draft survey data)"
        },
        {
          "name": "TicketEventModify",
          "description": "Modify ticket events (includes draft survey data)"
        },
        {
          "name": "DraftSurveyCalculations",
          "description": "Access draft survey tonnage calculation features (license-gated: Freight OR Towing)"
        }
      ]
    }
  },
  "modernImplementationPatterns": {
    "apiController": {
      "note": "Draft is not exposed as a standalone API. It is accessed through BargeEvent and TicketEvent controllers.",
      "example": "Draft data is serialized as part of BargeEvent or TicketEvent JSON response",
      "nestedEntityPattern": true
    },
    "uiController": {
      "note": "Draft data is displayed within BargeEvent and TicketEvent UI views. No standalone Draft controller exists.",
      "parentControllerPattern": "BargeEventController and TicketEventController control access to Draft data",
      "example": "Draft fields rendered in BargeEvent/TicketEvent edit forms"
    },
    "viewModelPattern": {
      "note": "Draft properties should be included in BargeEventViewModel and TicketEventViewModel",
      "nestedViewModel": "DraftViewModel as nested property",
      "properties": [
        "DraftPortBow",
        "DraftPortStern",
        "DraftStarboardBow",
        "DraftStarboardStern",
        "Draft (calculated max)",
        "DraftAverage (for Draft Survey events)",
        "EstimatedCargoDeadweight (for Draft Survey events)",
        "LightshipCorrection (for Draft Survey events)",
        "AdjustmentTons (for Draft Survey events)",
        "LoadUnloadTons (calculated tonnage)"
      ]
    },
    "licenseGating": {
      "pattern": "Feature flag check for draft survey calculations",
      "implementation": "if (licenseService.IsActive(LicenseComponent.Freight) || licenseService.IsActive(LicenseComponent.Towing))",
      "affectedFeatures": [
        "DraftAverage calculations",
        "EstimatedCargoDeadweight",
        "LightshipCorrection",
        "LoadUnloadTons calculations",
        "Draft-to-tonnage conversion",
        "Tonnage-to-draft conversion"
      ]
    }
  },
  "dataAccessPatterns": {
    "embeddedEntity": true,
    "accessPath": "BargeEvent.Draft or TicketEvent.Draft",
    "persistenceModel": "Draft table with foreign key to BargeEvent or TicketEvent",
    "securityEnforcement": "Security checked at parent entity level before allowing Draft access"
  },
  "businessLogicSecurity": {
    "readOnlyCalculations": [
      {
        "method": "CalculateAverageDraft",
        "license": "Freight OR Towing",
        "description": "Calculate average draft from four corners"
      },
      {
        "method": "CalculateTonnageFromAvgDraft",
        "license": "Freight OR Towing",
        "description": "Look up tonnage from draft using BargeSeries tables"
      },
      {
        "method": "CalculateDraftFromTonnage",
        "license": "Freight OR Towing",
        "description": "Calculate draft from tonnage (reverse lookup)"
      },
      {
        "method": "CalculateLoadUnloadTons",
        "license": "Freight OR Towing",
        "description": "Calculate final load/unload tonnage"
      },
      {
        "method": "CalculateEstimatedCargoDeadweightAndLightshipCorrection",
        "license": "Freight OR Towing",
        "description": "Calculate cargo and lightship tonnages"
      }
    ],
    "dataModificationMethods": [
      {
        "method": "Save",
        "permission": "BargeEventModify OR TicketEventModify",
        "description": "Save draft measurements (controlled by parent entity permission)"
      },
      {
        "method": "Delete",
        "permission": "BargeEventModify OR TicketEventModify",
        "description": "Delete draft record (controlled by parent entity permission)"
      }
    ]
  },
  "validationRules": {
    "note": "Validation rules enforce data integrity but do not represent security permissions",
    "businessRules": [
      {
        "rule": "DraftMaximumGreaterThanCorners",
        "security": false,
        "description": "Ensures overall draft >= highest corner draft"
      },
      {
        "rule": "DraftRangeValidation",
        "security": false,
        "description": "Draft must be 0-99.999 feet"
      },
      {
        "rule": "DraftInchesRangeValidation",
        "security": false,
        "description": "Inches must be 0-11"
      },
      {
        "rule": "DraftAverageRangeValidation",
        "security": false,
        "licenseGated": true,
        "description": "Average draft validation only applies when Freight or Towing license active"
      }
    ]
  },
  "securityRecommendations": {
    "apiSecurity": [
      "Apply [ApiKey] attribute to BargeEvent and TicketEvent API controllers",
      "Draft data automatically secured through parent entity authentication",
      "Consider adding future CSG Authorization checks for BargeEventView and BargeEventModify permissions"
    ],
    "uiSecurity": [
      "Apply [Authorize] attribute to BargeEvent and TicketEvent UI controllers",
      "Use [Authorize(Policy = \"BargeEventModify\")] for edit actions",
      "Use [Authorize(Policy = \"TicketEventModify\")] for draft survey edit actions",
      "Hide draft survey calculation fields when Freight and Towing licenses are both inactive",
      "Implement client-side permission checks to show/hide draft survey features based on DraftSurveyCalculations permission"
    ],
    "licenseEnforcement": [
      "Check Freight OR Towing license before enabling draft survey calculations",
      "Disable UI fields for EstimatedCargoDeadweight, LightshipCorrection, LoadUnloadTons when licenses inactive",
      "Return 403 Forbidden from API if draft survey calculations requested without proper license"
    ],
    "implementationNotes": [
      "Draft is not a standalone entity from security perspective",
      "All Draft access flows through BargeEvent or TicketEvent security boundaries",
      "No separate Draft permissions needed - inherit from parent entity",
      "Draft survey calculation features are license-gated, not permission-gated",
      "Consider adding audit logging for draft modifications as they affect financial calculations"
    ]
  },
  "migrationStrategy": {
    "phase1": "Implement API authentication with [ApiKey] on parent entities (BargeEvent, TicketEvent)",
    "phase2": "Implement UI authentication with OIDC and [Authorize] on parent entity controllers",
    "phase3": "Add CSG Authorization with parent entity permissions (BargeEventView, BargeEventModify, etc.)",
    "phase4": "Implement license-gating for draft survey calculations (DraftSurveyCalculations feature flag)",
    "phase5": "Add UI permission checks to show/hide draft survey features based on license and permissions"
  },
  "criticalSecurityNotes": [
    "Draft calculations affect financial/billing data - ensure proper authorization",
    "License checks must be enforced server-side, not just client-side",
    "Draft survey tonnage calculations are business-critical - audit all modifications",
    "Parent entity (BargeEvent/TicketEvent) security must be enforced before Draft access",
    "No direct Draft API endpoints should be created - always access through parent entities",
    "Draft modifications should be logged for audit trail purposes"
  ]
}
