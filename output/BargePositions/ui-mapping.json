{
  "entity": "BargePositions",
  "description": "UI component mapping for Barge Positions workspace - interactive drag-and-drop barge positioning system with tow diagrams and fleet management",
  "formType": "Interactive workspace with canvas-based positioning",
  "targetArchitecture": {
    "viewModels": "src/BargeOps.UI/Models/",
    "viewModelNamespace": "BargeOpsAdmin.ViewModels",
    "controllers": "src/BargeOps.UI/Controllers/",
    "controllerNamespace": "BargeOpsAdmin.Controllers",
    "baseController": "AppController",
    "views": "src/BargeOps.UI/Views/BargePositions/",
    "javascript": "src/BargeOps.UI/wwwroot/js/",
    "technologyStack": {
      "framework": "ASP.NET Core 8 MVC",
      "ui": "Bootstrap 5",
      "grid": "HTML5 Canvas or CSS Grid for barge positioning",
      "interactivity": "jQuery Draggable/Droppable or modern drag-and-drop API",
      "diagrams": "SVG or Canvas for tow diagrams",
      "realTime": "SignalR for position updates and conflict notifications",
      "dropdowns": "Select2",
      "validation": "jQuery Validate + Unobtrusive Validation"
    }
  },
  "controlMappings": [
    {
      "legacyControl": "UltraPanel (Main workspace)",
      "controlType": "Barge positioning canvas",
      "modernEquivalent": "Bootstrap Card with HTML5 Canvas or CSS Grid",
      "html": "<div class=\"card mb-3\" id=\"bargeWorkspace\">\n  <div class=\"card-header\">\n    <h5 class=\"card-title mb-0\">\n      <i class=\"fas fa-ship\"></i> Barge Positions\n      <span id=\"workspaceMode\" class=\"badge bg-info ms-2\"></span>\n    </h5>\n  </div>\n  <div class=\"card-body\">\n    <div id=\"bargeCanvas\" class=\"barge-canvas\" style=\"position: relative; min-height: 600px; border: 1px solid #dee2e6; background-color: #f8f9fa;\">\n      <!-- Barge tokens rendered here dynamically -->\n    </div>\n  </div>\n</div>",
      "javascript": {
        "file": "bargePositions.js",
        "initialization": "Initialize drag-and-drop, load barge positions via AJAX",
        "pattern": "Canvas-based or grid-based positioning system"
      },
      "usage": "Main interactive workspace for positioning barges",
      "features": [
        "Drag-and-drop barge tokens",
        "Visual tow arrangement",
        "Color-coded barge status",
        "Real-time position updates",
        "Conflict highlighting",
        "Grid snap for alignment"
      ]
    },
    {
      "legacyControl": "UltraComboEditor (Fleet/Location selector)",
      "controlType": "Dropdown",
      "modernEquivalent": "Select2 Dropdown",
      "html": "<div class=\"row mb-3\">\n  <div class=\"col-md-4\">\n    <label asp-for=\"FleetId\" class=\"form-label\">Fleet/Location</label>\n    <select asp-for=\"FleetId\" asp-items=\"Model.Fleets\" class=\"form-select\" data-select2=\"true\" id=\"FleetId\">\n      <option value=\"\">-- Select Fleet/Location --</option>\n    </select>\n  </div>\n  <div class=\"col-md-4\">\n    <label asp-for=\"ViewMode\" class=\"form-label\">View Mode</label>\n    <select asp-for=\"ViewMode\" class=\"form-select\" id=\"ViewMode\">\n      <option value=\"Workspace\">Workspace</option>\n      <option value=\"InFleet\">In Fleet</option>\n      <option value=\"AtFacility\">At Facility</option>\n      <option value=\"MidstreamIn\">Midstream In</option>\n      <option value=\"MidstreamOut\">Midstream Out</option>\n    </select>\n  </div>\n  <div class=\"col-md-4\">\n    <label class=\"form-label\">&nbsp;</label>\n    <button type=\"button\" id=\"btnRefresh\" class=\"btn btn-primary d-block w-100\">\n      <i class=\"fas fa-sync-alt\"></i> Refresh\n    </button>\n  </div>\n</div>",
      "javascript": {
        "initialization": "$('#FleetId').select2({ placeholder: 'Select fleet or location...', allowClear: true });",
        "eventHandler": "$('#FleetId, #ViewMode').on('change', function() { loadBargePositions(); });"
      },
      "usage": "Select fleet/location and view mode to load barge positions"
    },
    {
      "legacyControl": "BargeToken (Visual representation)",
      "controlType": "Draggable element",
      "modernEquivalent": "Div with draggable attribute and data attributes",
      "html": "<div class=\"barge-token\" \n     draggable=\"true\" \n     data-barge-id=\"{bargeId}\" \n     data-position-x=\"{x}\" \n     data-position-y=\"{y}\" \n     data-orientation=\"{orientation}\" \n     style=\"position: absolute; left: {x}px; top: {y}px; background-color: {backColor}; color: {textColor}; padding: 8px 12px; border: 2px solid #333; border-radius: 4px; cursor: move;\">\n  <div class=\"barge-token-name\">{bargeName}</div>\n  <div class=\"barge-token-note\" style=\"font-size: 0.85em; font-style: italic;\">{note}</div>\n</div>",
      "javascript": {
        "dragEvents": "dragstart, drag, dragend, dragover, drop",
        "functions": [
          "function enableBargeDragging() - Attach drag event handlers",
          "function onBargeTokenDragStart(event) - Start drag operation",
          "function onBargeTokenDrop(event) - Handle drop, update position",
          "function updateBargePosition(bargeId, x, y) - AJAX call to save position",
          "function flipBargeOrientation(bargeId) - Rotate token 180 degrees"
        ]
      },
      "usage": "Visual representation of individual barge in workspace",
      "colorCoding": {
        "source": "BargeTokenColors (ColorPair) table",
        "property": "TextColor and BackColor from barge status or user-defined",
        "dynamic": "Can be changed via 'Set Color' button"
      }
    },
    {
      "legacyControl": "UltraTabControl (Modes)",
      "controlType": "Mode selector",
      "modernEquivalent": "Bootstrap Nav Pills or Dropdown",
      "html": "<!-- Integrated into ViewMode dropdown above -->",
      "usage": "Switch between different operational modes",
      "modes": [
        {
          "mode": "Workspace",
          "description": "Normal workspace mode - barges can be moved freely",
          "badgeClass": "bg-primary"
        },
        {
          "mode": "InFleet",
          "description": "View barges in fleet",
          "badgeClass": "bg-info"
        },
        {
          "mode": "AtFacilityShip",
          "description": "View barges at facility or ship",
          "badgeClass": "bg-success"
        },
        {
          "mode": "MidstreamInUpdate",
          "description": "Midstream-in update mode",
          "badgeClass": "bg-warning"
        },
        {
          "mode": "MidstreamOutUpdate",
          "description": "Midstream-out update mode",
          "badgeClass": "bg-secondary"
        }
      ]
    },
    {
      "legacyControl": "Toolbar Buttons (Multiple actions)",
      "controlType": "Action buttons",
      "modernEquivalent": "Bootstrap Button Toolbar with Dropdowns",
      "html": "<div class=\"btn-toolbar mb-3\" role=\"toolbar\">\n  <div class=\"btn-group me-2\" role=\"group\">\n    <button type=\"button\" id=\"btnSetColor\" class=\"btn btn-outline-primary\" title=\"Set Color\" data-permission=\"BargePositionsModify\">\n      <i class=\"fas fa-palette\"></i> Set Color\n    </button>\n    <button type=\"button\" id=\"btnSetNote\" class=\"btn btn-outline-primary\" title=\"Set Note\" data-permission=\"BargePositionsModify\">\n      <i class=\"fas fa-sticky-note\"></i> Set Note\n    </button>\n    <button type=\"button\" id=\"btnDefineColorLegend\" class=\"btn btn-outline-secondary\" title=\"Define Color Legend\" data-permission=\"BargePositionsModify\">\n      <i class=\"fas fa-palette\"></i> Define Legend\n    </button>\n  </div>\n  <div class=\"btn-group me-2\" role=\"group\">\n    <button type=\"button\" id=\"btnFlipBarge\" class=\"btn btn-outline-info\" title=\"Flip Barge\" data-permission=\"BargePositionsModify\">\n      <i class=\"fas fa-sync\"></i> Flip Barge\n    </button>\n    <button type=\"button\" id=\"btnFlipTow\" class=\"btn btn-outline-info\" title=\"Flip Tow\" data-permission=\"BargePositionsModify\">\n      <i class=\"fas fa-sync-alt\"></i> Flip Tow\n    </button>\n    <button type=\"button\" id=\"btnDropTow\" class=\"btn btn-outline-warning\" title=\"Drop Tow\" data-permission=\"BargePositionsModify\">\n      <i class=\"fas fa-anchor\"></i> Drop Tow\n    </button>\n  </div>\n  <div class=\"btn-group me-2\" role=\"group\">\n    <button type=\"button\" id=\"btnShowTowDiagram\" class=\"btn btn-outline-success\" title=\"Show Tow Diagram\" data-permission=\"BargePositionsView\">\n      <i class=\"fas fa-diagram-project\"></i> Tow Diagram\n    </button>\n    <button type=\"button\" id=\"btnSendTowDiagram\" class=\"btn btn-outline-success\" title=\"Send Tow Diagram\" data-permission=\"BargePositionsModify\">\n      <i class=\"fas fa-paper-plane\"></i> Send Diagram\n    </button>\n  </div>\n  <div class=\"btn-group me-2\" role=\"group\">\n    <button type=\"button\" id=\"btnViewConflicts\" class=\"btn btn-outline-danger\" title=\"View Conflicts\" data-permission=\"BargePositionsView\">\n      <i class=\"fas fa-exclamation-triangle\"></i> Conflicts\n    </button>\n    <button type=\"button\" id=\"btnHistory\" class=\"btn btn-outline-secondary\" title=\"History\" data-permission=\"BargePositionsView\">\n      <i class=\"fas fa-history\"></i> History\n    </button>\n  </div>\n  <div class=\"btn-group\" role=\"group\">\n    <button type=\"button\" id=\"btnSetAnchorWire\" class=\"btn btn-outline-primary\" title=\"Set Anchor Wire\" data-permission=\"BargePositionsModify\">\n      <i class=\"fas fa-anchor\"></i> Anchor Wire\n    </button>\n    <button type=\"button\" id=\"btnArriveDepartShip\" class=\"btn btn-outline-info\" title=\"Arrive/Depart Ship\" data-permission=\"BargePositionsModify\">\n      <i class=\"fas fa-ship\"></i> Arrive/Depart\n    </button>\n  </div>\n</div>",
      "javascript": {
        "permissionChecking": "// Enable/disable buttons based on permissions and mode\nfunction updateToolbarButtonStates() {\n  var mode = $('#ViewMode').val();\n  var selectedBarge = getSelectedBarge();\n  var hasModifyPermission = $('#btnSetColor').data('has-permission');\n  \n  // Set Color and Set Note disabled in event mode\n  var inEventMode = mode === 'EventMode';\n  $('#btnSetColor, #btnSetNote').prop('disabled', inEventMode || !selectedBarge || !hasModifyPermission);\n  \n  // Flip/Drop require selected barge\n  $('#btnFlipBarge').prop('disabled', !selectedBarge || !hasModifyPermission);\n  $('#btnFlipTow').prop('disabled', !selectedBarge || !hasModifyPermission);\n  $('#btnDropTow').prop('disabled', !selectedBarge || !hasModifyPermission);\n  \n  // View permissions\n  var hasViewPermission = $('#btnShowTowDiagram').data('has-permission');\n  $('#btnShowTowDiagram').prop('disabled', !hasViewPermission);\n  $('#btnViewConflicts, #btnHistory').prop('disabled', !hasViewPermission);\n}",
        "eventHandlers": "Attach click handlers for each button, call appropriate API endpoints"
      },
      "security": {
        "pattern": "Permission-based button visibility and enabled state",
        "implementation": "data-permission attribute checked against user's permissions from ViewModel",
        "legacy": "ToolbarButtonCanBeEnabled method with mode and barge selection checks"
      },
      "notes": "Button enabled state depends on: 1) User permissions, 2) Current mode, 3) Selected barge, 4) Not in event mode (for some buttons)"
    },
    {
      "legacyControl": "ContextMenu (Right-click actions)",
      "controlType": "Context menu",
      "modernEquivalent": "Bootstrap Dropdown triggered on right-click",
      "html": "<div id=\"bargeContextMenu\" class=\"dropdown-menu\" style=\"display: none; position: absolute;\">\n  <a class=\"dropdown-item\" href=\"#\" data-action=\"setColor\">\n    <i class=\"fas fa-palette\"></i> Set Color\n  </a>\n  <a class=\"dropdown-item\" href=\"#\" data-action=\"setNote\">\n    <i class=\"fas fa-sticky-note\"></i> Set Note\n  </a>\n  <div class=\"dropdown-divider\"></div>\n  <a class=\"dropdown-item\" href=\"#\" data-action=\"flipBarge\">\n    <i class=\"fas fa-sync\"></i> Flip Barge\n  </a>\n  <a class=\"dropdown-item\" href=\"#\" data-action=\"viewDetails\">\n    <i class=\"fas fa-info-circle\"></i> View Details\n  </a>\n  <div class=\"dropdown-divider\"></div>\n  <a class=\"dropdown-item\" href=\"#\" data-action=\"towDiagram\">\n    <i class=\"fas fa-diagram-project\"></i> Show Tow Diagram\n  </a>\n</div>",
      "javascript": {
        "rightClickHandler": "// Show context menu on right-click\n$('#bargeCanvas').on('contextmenu', '.barge-token', function(e) {\n  e.preventDefault();\n  var $token = $(this);\n  var bargeId = $token.data('barge-id');\n  \n  // Position and show menu\n  $('#bargeContextMenu').css({\n    display: 'block',\n    left: e.pageX + 'px',\n    top: e.pageY + 'px'\n  }).data('barge-id', bargeId);\n});\n\n// Hide menu on outside click\n$(document).on('click', function() {\n  $('#bargeContextMenu').hide();\n});"
      },
      "usage": "Quick access to common barge actions via right-click"
    },
    {
      "legacyControl": "Timer (Auto-refresh)",
      "controlType": "Background refresh",
      "modernEquivalent": "SignalR Hub or setInterval polling",
      "javascript": {
        "signalRPattern": "// Preferred: Real-time updates via SignalR\nvar connection = new signalR.HubConnectionBuilder()\n  .withUrl('/hubs/bargePositions')\n  .build();\n\nconnection.on('PositionUpdated', function(bargeId, x, y, updatedBy) {\n  updateBargeTokenPosition(bargeId, x, y);\n  showNotification('Barge position updated by ' + updatedBy);\n});\n\nconnection.on('ConflictDetected', function(conflicts) {\n  showConflictAlert(conflicts);\n});\n\nconnection.start();",
        "pollingPattern": "// Fallback: Polling with setInterval\nsetInterval(function() {\n  refreshBargePositions();\n  checkConflicts();\n}, 30000); // 30 seconds",
        "conflictCheck": "// Check for conflicts every 60 seconds\nsetInterval(function() {\n  $.ajax({\n    url: '/BargePositions/GetConflicts',\n    type: 'GET',\n    data: { fleetId: $('#FleetId').val() },\n    success: function(conflicts) {\n      if (conflicts.length > 0) {\n        highlightConflicts(conflicts);\n        $('#btnViewConflicts').addClass('btn-danger').removeClass('btn-outline-danger');\n      }\n    }\n  });\n}, 60000);"
      },
      "legacy": {
        "tmrBargePositions": "30-second auto-refresh of positions",
        "tmrBargeConflicts": "60-second conflict monitoring"
      }
    },
    {
      "legacyControl": "Modal dialogs (Set Color, Set Note, etc.)",
      "controlType": "Modal forms",
      "modernEquivalent": "Bootstrap Modal",
      "html": {
        "setColorModal": "<div class=\"modal fade\" id=\"setColorModal\" tabindex=\"-1\">\n  <div class=\"modal-dialog\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n        <h5 class=\"modal-title\">Set Barge Color</h5>\n        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n      </div>\n      <div class=\"modal-body\">\n        <div class=\"mb-3\">\n          <label for=\"colorPairSelect\" class=\"form-label\">Color Pair</label>\n          <select id=\"colorPairSelect\" class=\"form-select\" data-select2=\"true\">\n            <option value=\"\">-- Select Color --</option>\n          </select>\n        </div>\n        <div id=\"colorPreview\" class=\"card text-center p-3\" style=\"min-height: 80px;\">\n          <span style=\"font-size: 1.2rem; font-weight: bold;\">Preview</span>\n        </div>\n      </div>\n      <div class=\"modal-footer\">\n        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancel</button>\n        <button type=\"button\" class=\"btn btn-primary\" id=\"btnSaveColor\">Save</button>\n      </div>\n    </div>\n  </div>\n</div>",
        "setNoteModal": "<div class=\"modal fade\" id=\"setNoteModal\" tabindex=\"-1\">\n  <div class=\"modal-dialog\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n        <h5 class=\"modal-title\">Set Barge Note</h5>\n        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n      </div>\n      <div class=\"modal-body\">\n        <div class=\"mb-3\">\n          <label for=\"bargeNote\" class=\"form-label\">Note</label>\n          <textarea id=\"bargeNote\" class=\"form-control\" rows=\"4\" maxlength=\"200\" placeholder=\"Enter note...\"></textarea>\n          <small class=\"form-text text-muted\">Maximum 200 characters</small>\n        </div>\n      </div>\n      <div class=\"modal-footer\">\n        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancel</button>\n        <button type=\"button\" class=\"btn btn-primary\" id=\"btnSaveNote\">Save</button>\n      </div>\n    </div>\n  </div>\n</div>",
        "towDiagramModal": "<div class=\"modal fade\" id=\"towDiagramModal\" tabindex=\"-1\">\n  <div class=\"modal-dialog modal-xl\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n        <h5 class=\"modal-title\">Tow Diagram</h5>\n        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\"></button>\n      </div>\n      <div class=\"modal-body\">\n        <div id=\"towDiagramCanvas\" style=\"min-height: 500px; overflow: auto;\">\n          <!-- SVG or Canvas rendering of tow diagram -->\n        </div>\n      </div>\n      <div class=\"modal-footer\">\n        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Close</button>\n        <button type=\"button\" class=\"btn btn-primary\" id=\"btnPrintDiagram\">\n          <i class=\"fas fa-print\"></i> Print\n        </button>\n        <button type=\"button\" class=\"btn btn-success\" id=\"btnSendDiagram\">\n          <i class=\"fas fa-paper-plane\"></i> Send\n        </button>\n      </div>\n    </div>\n  </div>\n</div>",
        "conflictsModal": "<div class=\"modal fade\" id=\"conflictsModal\" tabindex=\"-1\">\n  <div class=\"modal-dialog modal-lg\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header bg-danger text-white\">\n        <h5 class=\"modal-title\">\n          <i class=\"fas fa-exclamation-triangle\"></i> Barge Position Conflicts\n        </h5>\n        <button type=\"button\" class=\"btn-close btn-close-white\" data-bs-dismiss=\"modal\"></button>\n      </div>\n      <div class=\"modal-body\">\n        <table id=\"conflictsTable\" class=\"table table-striped\">\n          <thead>\n            <tr>\n              <th>Barge</th>\n              <th>Conflict Type</th>\n              <th>Description</th>\n              <th>Actions</th>\n            </tr>\n          </thead>\n          <tbody>\n            <!-- Populated via JavaScript -->\n          </tbody>\n        </table>\n      </div>\n      <div class=\"modal-footer\">\n        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Close</button>\n      </div>\n    </div>\n  </div>\n</div>"
      },
      "javascript": {
        "showModal": "// Show modal with data\nfunction showSetColorModal(bargeId) {\n  $.ajax({\n    url: '/BargePositions/GetBargeDetails',\n    type: 'GET',\n    data: { bargeId: bargeId },\n    success: function(barge) {\n      loadColorPairs();\n      $('#setColorModal').data('barge-id', bargeId).modal('show');\n    }\n  });\n}",
        "saveHandler": "$('#btnSaveColor').on('click', function() {\n  var bargeId = $('#setColorModal').data('barge-id');\n  var colorPairId = $('#colorPairSelect').val();\n  \n  $.ajax({\n    url: '/BargePositions/SetBargeColor',\n    type: 'PUT',\n    data: { bargeId: bargeId, colorPairId: colorPairId },\n    success: function() {\n      $('#setColorModal').modal('hide');\n      refreshBargeToken(bargeId);\n      showNotification('Color updated successfully');\n    }\n  });\n});"
      }
    },
    {
      "legacyControl": "BackgroundWorker (Data loading)",
      "controlType": "Async data loading",
      "modernEquivalent": "AJAX with loading indicators",
      "javascript": {
        "loadingIndicator": "// Show loading spinner during AJAX calls\nfunction loadBargePositions() {\n  $('#bargeCanvas').html('<div class=\"text-center p-5\"><i class=\"fas fa-spinner fa-spin fa-3x\"></i><p class=\"mt-3\">Loading barge positions...</p></div>');\n  \n  $.ajax({\n    url: '/BargePositions/GetBargePositions',\n    type: 'GET',\n    data: { \n      fleetId: $('#FleetId').val(),\n      viewMode: $('#ViewMode').val()\n    },\n    success: function(positions) {\n      renderBargePositions(positions);\n    },\n    error: function() {\n      $('#bargeCanvas').html('<div class=\"alert alert-danger\">Error loading barge positions</div>');\n    }\n  });\n}",
        "asyncPattern": "Use async/await with fetch API or jQuery AJAX for modern async operations"
      }
    },
    {
      "legacyControl": "CheckBox (Filter options)",
      "controlType": "Checkbox",
      "modernEquivalent": "Bootstrap Checkbox",
      "html": "<div class=\"form-check form-check-inline\">\n  <input type=\"checkbox\" class=\"form-check-input\" id=\"showEmptyPositions\" />\n  <label class=\"form-check-label\" for=\"showEmptyPositions\">Show Empty Positions</label>\n</div>\n<div class=\"form-check form-check-inline\">\n  <input type=\"checkbox\" class=\"form-check-input\" id=\"snapToGrid\" checked />\n  <label class=\"form-check-label\" for=\"snapToGrid\">Snap to Grid</label>\n</div>\n<div class=\"form-check form-check-inline\">\n  <input type=\"checkbox\" class=\"form-check-input\" id=\"showConflicts\" checked />\n  <label class=\"form-check-label\" for=\"showConflicts\">Highlight Conflicts</label>\n</div>",
      "usage": "Filter and display options for workspace"
    }
  ],
  "formPatterns": {
    "workspaceView": {
      "view": "Views/BargePositions/Index.cshtml",
      "viewModel": "BargePositionsViewModel",
      "layout": "Full-width workspace with toolbar and canvas",
      "sections": [
        {
          "name": "Fleet/Mode Selector",
          "controls": "Fleet dropdown (Select2), View Mode dropdown, Refresh button"
        },
        {
          "name": "Toolbar",
          "controls": "Button groups for color, movement, diagrams, conflicts, and ship operations"
        },
        {
          "name": "Workspace Options",
          "controls": "Checkboxes for display preferences (snap to grid, show conflicts, etc.)"
        },
        {
          "name": "Canvas",
          "controls": "Interactive drag-and-drop area with barge tokens"
        },
        {
          "name": "Status Bar",
          "controls": "Selected barge info, conflict count, last update time"
        }
      ]
    },
    "modals": {
      "setColor": {
        "trigger": "Toolbar button or context menu",
        "content": "Select2 dropdown for color pairs with live preview"
      },
      "setNote": {
        "trigger": "Toolbar button or context menu",
        "content": "Textarea for note input (max 200 chars)"
      },
      "towDiagram": {
        "trigger": "Toolbar button",
        "content": "SVG/Canvas rendering of tow configuration"
      },
      "conflicts": {
        "trigger": "Toolbar button or auto-show on conflicts",
        "content": "DataTable with conflict details and resolution actions"
      },
      "history": {
        "trigger": "Toolbar button",
        "content": "DataTable with barge position history"
      }
    }
  },
  "javascriptPatterns": {
    "dragAndDrop": {
      "file": "wwwroot/js/bargePositions.js",
      "functions": [
        {
          "name": "initializeDragAndDrop",
          "purpose": "Set up drag-and-drop event handlers for barge tokens",
          "code": "function initializeDragAndDrop() {\n  $('.barge-token').attr('draggable', true);\n  \n  $('.barge-token').on('dragstart', function(e) {\n    var bargeId = $(this).data('barge-id');\n    e.originalEvent.dataTransfer.setData('bargeId', bargeId);\n    $(this).addClass('dragging');\n  });\n  \n  $('.barge-token').on('dragend', function(e) {\n    $(this).removeClass('dragging');\n  });\n  \n  $('#bargeCanvas').on('dragover', function(e) {\n    e.preventDefault();\n  });\n  \n  $('#bargeCanvas').on('drop', function(e) {\n    e.preventDefault();\n    var bargeId = e.originalEvent.dataTransfer.getData('bargeId');\n    var canvasOffset = $(this).offset();\n    var x = e.pageX - canvasOffset.left;\n    var y = e.pageY - canvasOffset.top;\n    \n    if ($('#snapToGrid').is(':checked')) {\n      var gridSize = 20;\n      x = Math.round(x / gridSize) * gridSize;\n      y = Math.round(y / gridSize) * gridSize;\n    }\n    \n    updateBargePosition(bargeId, x, y);\n  });\n}"
        },
        {
          "name": "updateBargePosition",
          "purpose": "Save barge position to server and update UI",
          "code": "function updateBargePosition(bargeId, x, y) {\n  var $token = $('.barge-token[data-barge-id=\"' + bargeId + '\"]');\n  \n  $.ajax({\n    url: '/BargePositions/MoveBarges',\n    type: 'POST',\n    data: { \n      bargeId: bargeId, \n      positionX: x, \n      positionY: y,\n      fleetId: $('#FleetId').val()\n    },\n    success: function(result) {\n      $token.css({ left: x + 'px', top: y + 'px' });\n      $token.data('position-x', x).data('position-y', y);\n      showNotification('Position updated');\n      \n      if (result.conflicts && result.conflicts.length > 0) {\n        highlightConflicts(result.conflicts);\n      }\n    },\n    error: function() {\n      showNotification('Error updating position', 'error');\n    }\n  });\n}"
        },
        {
          "name": "loadBargePositions",
          "purpose": "Load barge positions for selected fleet/mode",
          "code": "function loadBargePositions() {\n  var fleetId = $('#FleetId').val();\n  var viewMode = $('#ViewMode').val();\n  \n  if (!fleetId) {\n    $('#bargeCanvas').html('<div class=\"alert alert-info\">Please select a fleet or location</div>');\n    return;\n  }\n  \n  $('#bargeCanvas').html('<div class=\"text-center p-5\"><i class=\"fas fa-spinner fa-spin fa-3x\"></i></div>');\n  \n  $.ajax({\n    url: '/BargePositions/GetBargePositions',\n    type: 'GET',\n    data: { fleetId: fleetId, viewMode: viewMode },\n    success: function(positions) {\n      renderBargePositions(positions);\n      initializeDragAndDrop();\n      updateToolbarButtonStates();\n    }\n  });\n}"
        },
        {
          "name": "renderBargePositions",
          "purpose": "Render barge tokens on canvas",
          "code": "function renderBargePositions(positions) {\n  $('#bargeCanvas').empty();\n  \n  positions.forEach(function(position) {\n    var $token = $('<div></div>')\n      .addClass('barge-token')\n      .attr('draggable', true)\n      .attr('data-barge-id', position.bargeId)\n      .attr('data-position-x', position.x)\n      .attr('data-position-y', position.y)\n      .attr('data-orientation', position.orientation || 0)\n      .css({\n        position: 'absolute',\n        left: position.x + 'px',\n        top: position.y + 'px',\n        backgroundColor: position.backColor,\n        color: position.textColor,\n        padding: '8px 12px',\n        border: '2px solid #333',\n        borderRadius: '4px',\n        cursor: 'move',\n        transform: 'rotate(' + (position.orientation || 0) + 'deg)',\n        minWidth: '120px',\n        textAlign: 'center'\n      });\n    \n    var $name = $('<div></div>')\n      .addClass('barge-token-name')\n      .css({ fontWeight: 'bold', fontSize: '0.9rem' })\n      .text(position.bargeName);\n    \n    $token.append($name);\n    \n    if (position.note) {\n      var $note = $('<div></div>')\n        .addClass('barge-token-note')\n        .css({ fontSize: '0.75rem', fontStyle: 'italic', marginTop: '4px' })\n        .text(position.note);\n      $token.append($note);\n    }\n    \n    if (position.hasConflict) {\n      $token.addClass('has-conflict').css('border-color', '#dc3545');\n    }\n    \n    $('#bargeCanvas').append($token);\n  });\n  \n  updateStatusBar(positions.length);\n}"
        },
        {
          "name": "flipBargeOrientation",
          "purpose": "Rotate barge token 180 degrees",
          "code": "function flipBargeOrientation(bargeId) {\n  var $token = $('.barge-token[data-barge-id=\"' + bargeId + '\"]');\n  var currentOrientation = parseInt($token.data('orientation') || 0);\n  var newOrientation = (currentOrientation + 180) % 360;\n  \n  $.ajax({\n    url: '/BargePositions/FlipBarge',\n    type: 'PUT',\n    data: { bargeId: bargeId },\n    success: function() {\n      $token.css('transform', 'rotate(' + newOrientation + 'deg)');\n      $token.data('orientation', newOrientation);\n      showNotification('Barge flipped');\n    }\n  });\n}"
        },
        {
          "name": "highlightConflicts",
          "purpose": "Visually highlight barges with position conflicts",
          "code": "function highlightConflicts(conflicts) {\n  $('.barge-token').removeClass('has-conflict');\n  \n  conflicts.forEach(function(conflict) {\n    var $token = $('.barge-token[data-barge-id=\"' + conflict.bargeId + '\"]');\n    $token.addClass('has-conflict')\n         .css('border-color', '#dc3545')\n         .attr('title', conflict.description);\n  });\n  \n  if (conflicts.length > 0) {\n    $('#btnViewConflicts').removeClass('btn-outline-danger').addClass('btn-danger');\n    updateStatusBar(null, conflicts.length);\n  }\n}"
        }
      ]
    },
    "modalHandlers": {
      "file": "wwwroot/js/bargePositions.js",
      "functions": [
        {
          "name": "showSetColorModal",
          "purpose": "Display color selection modal for selected barge",
          "implementation": "Load color pairs via AJAX, show modal with Select2"
        },
        {
          "name": "showSetNoteModal",
          "purpose": "Display note editor modal for selected barge",
          "implementation": "Load current note, show modal with textarea"
        },
        {
          "name": "showTowDiagram",
          "purpose": "Render and display tow diagram in modal",
          "implementation": "Generate SVG/Canvas diagram of tow configuration"
        },
        {
          "name": "showConflictsModal",
          "purpose": "Display conflict list in modal",
          "implementation": "Load conflicts via AJAX, render in DataTable"
        }
      ]
    },
    "signalR": {
      "file": "wwwroot/js/bargePositions.js",
      "hubConnection": "/hubs/bargePositions",
      "events": [
        {
          "event": "PositionUpdated",
          "handler": "Update barge token position in real-time",
          "parameters": "bargeId, x, y, updatedBy"
        },
        {
          "event": "ConflictDetected",
          "handler": "Show conflict alert and highlight affected barges",
          "parameters": "conflicts[]"
        },
        {
          "event": "BargeAdded",
          "handler": "Add new barge token to canvas",
          "parameters": "bargePosition"
        },
        {
          "event": "BargeRemoved",
          "handler": "Remove barge token from canvas",
          "parameters": "bargeId"
        }
      ]
    },
    "utilities": {
      "functions": [
        {
          "name": "getSelectedBarge",
          "purpose": "Get currently selected barge ID",
          "code": "function getSelectedBarge() {\n  return $('.barge-token.selected').data('barge-id') || null;\n}"
        },
        {
          "name": "updateStatusBar",
          "purpose": "Update status bar with barge count and conflicts",
          "code": "function updateStatusBar(bargeCount, conflictCount) {\n  if (bargeCount !== null && bargeCount !== undefined) {\n    $('#bargeCount').text(bargeCount + ' barges');\n  }\n  if (conflictCount !== null && conflictCount !== undefined) {\n    $('#conflictCount').text(conflictCount + ' conflicts').toggleClass('text-danger', conflictCount > 0);\n  }\n  $('#lastUpdate').text('Last updated: ' + new Date().toLocaleTimeString());\n}"
        },
        {
          "name": "showNotification",
          "purpose": "Show toast notification",
          "code": "function showNotification(message, type) {\n  type = type || 'success';\n  // Use Bootstrap Toast or similar notification system\n  var toastHtml = '<div class=\"toast\" role=\"alert\"><div class=\"toast-body bg-' + type + ' text-white\">' + message + '</div></div>';\n  $('#toastContainer').append(toastHtml);\n  $('.toast').toast('show');\n}"
        }
      ]
    }
  },
  "viewModels": {
    "main": {
      "name": "BargePositionsViewModel",
      "properties": [
        {
          "name": "FleetId",
          "type": "int?",
          "display": "Fleet/Location",
          "purpose": "Selected fleet or facility"
        },
        {
          "name": "Fleets",
          "type": "SelectList",
          "purpose": "Available fleets and facilities"
        },
        {
          "name": "ViewMode",
          "type": "string",
          "display": "View Mode",
          "purpose": "Current operational mode",
          "values": ["Workspace", "InFleet", "AtFacility", "MidstreamIn", "MidstreamOut"]
        },
        {
          "name": "UserPermissions",
          "type": "BargePositionsPermissions",
          "purpose": "User's permissions for button visibility"
        },
        {
          "name": "IsOnboardMode",
          "type": "bool",
          "purpose": "Feature flag for onboard-specific features"
        },
        {
          "name": "IsTerminalMode",
          "type": "bool",
          "purpose": "Feature flag for terminal-specific features"
        }
      ]
    },
    "bargePosition": {
      "name": "BargePositionDto",
      "properties": [
        {
          "name": "bargeId",
          "type": "int"
        },
        {
          "name": "bargeName",
          "type": "string"
        },
        {
          "name": "x",
          "type": "int",
          "purpose": "Canvas X coordinate"
        },
        {
          "name": "y",
          "type": "int",
          "purpose": "Canvas Y coordinate"
        },
        {
          "name": "orientation",
          "type": "int",
          "purpose": "Rotation angle in degrees (0, 90, 180, 270)"
        },
        {
          "name": "textColor",
          "type": "string",
          "purpose": "Hex color for text"
        },
        {
          "name": "backColor",
          "type": "string",
          "purpose": "Hex color for background"
        },
        {
          "name": "note",
          "type": "string",
          "purpose": "Optional note displayed on token"
        },
        {
          "name": "hasConflict",
          "type": "bool",
          "purpose": "Whether barge has position conflict"
        },
        {
          "name": "isSelected",
          "type": "bool",
          "purpose": "Whether barge is currently selected"
        }
      ]
    }
  },
  "cssPatterns": {
    "customStyles": {
      "file": "wwwroot/css/bargePositions.css",
      "styles": [
        {
          "selector": ".barge-canvas",
          "purpose": "Main workspace canvas",
          "css": ".barge-canvas {\n  position: relative;\n  min-height: 600px;\n  background-color: #f8f9fa;\n  background-image: \n    linear-gradient(rgba(0,0,0,.05) 1px, transparent 1px),\n    linear-gradient(90deg, rgba(0,0,0,.05) 1px, transparent 1px);\n  background-size: 20px 20px;\n  border: 1px solid #dee2e6;\n  overflow: hidden;\n  user-select: none;\n}"
        },
        {
          "selector": ".barge-token",
          "purpose": "Individual barge token styling",
          "css": ".barge-token {\n  position: absolute;\n  min-width: 120px;\n  padding: 8px 12px;\n  border: 2px solid #333;\n  border-radius: 4px;\n  cursor: move;\n  text-align: center;\n  box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n  transition: transform 0.3s ease, box-shadow 0.3s ease;\n  z-index: 1;\n}\n\n.barge-token:hover {\n  box-shadow: 0 4px 8px rgba(0,0,0,0.3);\n  z-index: 10;\n}\n\n.barge-token.selected {\n  border-width: 3px;\n  border-color: #0d6efd;\n  z-index: 100;\n}\n\n.barge-token.dragging {\n  opacity: 0.6;\n  cursor: grabbing;\n}\n\n.barge-token.has-conflict {\n  border-color: #dc3545 !important;\n  animation: pulse-conflict 2s infinite;\n}\n\n@keyframes pulse-conflict {\n  0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }\n  50% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }\n}"
        },
        {
          "selector": ".barge-token-name",
          "purpose": "Barge name text",
          "css": ".barge-token-name {\n  font-weight: bold;\n  font-size: 0.9rem;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}"
        },
        {
          "selector": ".barge-token-note",
          "purpose": "Barge note text",
          "css": ".barge-token-note {\n  font-size: 0.75rem;\n  font-style: italic;\n  margin-top: 4px;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}"
        },
        {
          "selector": "#bargeContextMenu",
          "purpose": "Context menu styling",
          "css": "#bargeContextMenu {\n  z-index: 9999;\n  box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n}"
        }
      ]
    }
  },
  "accessibilityFeatures": [
    {
      "feature": "Keyboard navigation",
      "implementation": "Arrow keys to move selected barge, Tab to select barges, Enter to open context menu",
      "aria": "role=\"application\" on canvas, aria-grabbed on draggable tokens"
    },
    {
      "feature": "Screen reader support",
      "implementation": "aria-label on barge tokens describing position and status",
      "example": "aria-label=\"Barge ABC123 at position row 3 column 5, status: in tow, has conflict\""
    },
    {
      "feature": "Focus management",
      "implementation": "tabindex on barge tokens, focus ring on selected token",
      "css": ".barge-token:focus { outline: 3px solid #0d6efd; outline-offset: 2px; }"
    },
    {
      "feature": "High contrast mode",
      "implementation": "CSS media query for prefers-contrast, increase border widths and colors",
      "css": "@media (prefers-contrast: high) { .barge-token { border-width: 3px; } }"
    }
  ],
  "migrationConsiderations": [
    {
      "challenge": "Complex canvas-based UI",
      "legacy": "Custom barge token rendering with Infragistics controls",
      "modern": "HTML5 Canvas, SVG, or CSS Grid with positioned div elements",
      "solution": "Use absolutely positioned div elements for simplicity and accessibility",
      "implementation": "CSS position: absolute with dynamic left/top values from database"
    },
    {
      "challenge": "Real-time updates and conflict detection",
      "legacy": "Timer-based polling every 30-60 seconds",
      "modern": "SignalR for real-time push notifications",
      "solution": "Implement SignalR hub for position updates and conflicts, fallback to polling",
      "implementation": "SignalR hub broadcasts PositionUpdated and ConflictDetected events"
    },
    {
      "challenge": "Event mode deferred save",
      "legacy": "When called from frmBargeEvent, some movements not saved until form closes",
      "modern": "Session-based or in-memory pending changes",
      "solution": "Track pending changes in session storage or server-side session",
      "implementation": "EventMode flag in ViewModel, controller tracks pending changes"
    },
    {
      "challenge": "Drag-and-drop with permissions",
      "legacy": "Toolbar button security controls drag ability",
      "modern": "Conditional draggable attribute based on permissions",
      "solution": "Set draggable=\"true\" only if user has Modify permission and not in restricted mode",
      "implementation": "Server sends canModify flag, JavaScript conditionally enables drag"
    },
    {
      "challenge": "Tow diagram rendering",
      "legacy": "Custom GDI+ drawing of tow configuration",
      "modern": "SVG or HTML5 Canvas rendering",
      "solution": "Use SVG for scalability and printability",
      "implementation": "Server generates SVG markup or client-side JavaScript renders from position data"
    },
    {
      "challenge": "Multiple modes with different behaviors",
      "legacy": "UltraTabControl with mode-specific logic",
      "modern": "ViewMode dropdown with conditional UI/logic",
      "solution": "ViewMode parameter controls available actions and drag behavior",
      "implementation": "Server sends mode-specific permissions, JavaScript enables/disables features"
    },
    {
      "challenge": "Background workers for async data loading",
      "legacy": "BackgroundWorker for retrieving barge and workspace data",
      "modern": "AJAX with loading spinners and async/await",
      "solution": "Use AJAX with visual loading indicators",
      "implementation": "Show spinner during AJAX calls, render on success"
    }
  ],
  "commonMistakes": [
    "❌ Not checking permissions before enabling drag-and-drop",
    "❌ Forgetting to disable Set Color/Set Note buttons in event mode",
    "❌ Not implementing snap-to-grid functionality",
    "❌ Missing conflict detection and highlighting",
    "❌ Not using SignalR for real-time updates (or polling fallback)",
    "❌ Forgetting to update toolbar button states when barge selected/deselected",
    "❌ Not handling concurrent position updates from multiple users",
    "❌ Missing keyboard accessibility for barge selection and movement",
    "❌ Not preserving position changes in event mode for deferred save",
    "❌ Forgetting to check mode before allowing certain actions (flip, drop, etc.)"
  ],
  "implementationFiles": {
    "views": [
      {
        "path": "src/BargeOps.UI/Views/BargePositions/Index.cshtml",
        "purpose": "Main workspace view",
        "sections": [
          "Fleet/Mode selector",
          "Toolbar with action buttons",
          "Workspace options (checkboxes)",
          "Canvas area for barge tokens",
          "Status bar"
        ]
      }
    ],
    "modals": [
      {
        "path": "src/BargeOps.UI/Views/BargePositions/_SetColorModal.cshtml",
        "purpose": "Set barge color partial"
      },
      {
        "path": "src/BargeOps.UI/Views/BargePositions/_SetNoteModal.cshtml",
        "purpose": "Set barge note partial"
      },
      {
        "path": "src/BargeOps.UI/Views/BargePositions/_TowDiagramModal.cshtml",
        "purpose": "Tow diagram display partial"
      },
      {
        "path": "src/BargeOps.UI/Views/BargePositions/_ConflictsModal.cshtml",
        "purpose": "Conflicts list partial"
      }
    ],
    "javascript": [
      {
        "path": "src/BargeOps.UI/wwwroot/js/bargePositions.js",
        "purpose": "Main workspace logic: drag-and-drop, AJAX, modals, SignalR",
        "size": "Large file (~500-800 lines)"
      }
    ],
    "css": [
      {
        "path": "src/BargeOps.UI/wwwroot/css/bargePositions.css",
        "purpose": "Custom styles for canvas, tokens, animations"
      }
    ],
    "controllers": [
      {
        "path": "src/BargeOps.UI/Controllers/BargePositionsController.cs",
        "namespace": "BargeOpsAdmin.Controllers",
        "baseClass": "AppController",
        "actions": [
          "Index (GET) - main view",
          "GetBargePositions (GET) - load positions for fleet/mode",
          "MoveBarges (POST) - update barge position",
          "SetBargeColor (PUT) - set barge color",
          "SetBargeNote (PUT) - set barge note",
          "FlipBarge (PUT) - flip barge orientation",
          "FlipTow (PUT) - flip entire tow",
          "DropTow (POST) - drop tow at location",
          "GetConflicts (GET) - get position conflicts",
          "ViewHistory (GET) - get position history",
          "ShowTowDiagram (GET) - generate tow diagram",
          "SendTowDiagram (POST) - send diagram to external system",
          "SetAnchorWire (PUT) - set anchor wire",
          "ArriveShip (POST) - record ship arrival",
          "DepartShip (POST) - record ship departure",
          "DefineColorLegend (GET) - color legend management"
        ]
      }
    ],
    "hubs": [
      {
        "path": "src/BargeOps.UI/Hubs/BargePositionsHub.cs",
        "purpose": "SignalR hub for real-time position updates",
        "methods": [
          "BroadcastPositionUpdate",
          "BroadcastConflictDetected",
          "BroadcastBargeAdded",
          "BroadcastBargeRemoved"
        ]
      }
    ],
    "viewModels": [
      {
        "path": "src/BargeOps.UI/Models/BargePositionsViewModel.cs",
        "namespace": "BargeOpsAdmin.ViewModels",
        "purpose": "Main workspace view model"
      },
      {
        "path": "src/BargeOps.UI/Models/BargePositionDto.cs",
        "namespace": "BargeOpsAdmin.ViewModels",
        "purpose": "Individual barge position data"
      }
    ]
  },
  "testingConsiderations": [
    {
      "area": "Drag-and-drop functionality",
      "test": "Verify barges can be dragged and position saved",
      "validation": "Position updates in database, UI reflects new position"
    },
    {
      "area": "Permission-based access",
      "test": "Verify toolbar buttons enabled/disabled based on permissions",
      "validation": "Users without Modify permission cannot move barges or set colors"
    },
    {
      "area": "Mode-specific behavior",
      "test": "Verify each mode (Workspace, InFleet, etc.) has correct features enabled",
      "validation": "Event mode prevents color/note changes, Workspace allows all"
    },
    {
      "area": "Conflict detection",
      "test": "Verify conflicts highlighted when barges overlap or violate rules",
      "validation": "Conflict alert shows, affected barges highlighted in red"
    },
    {
      "area": "Real-time updates",
      "test": "Verify SignalR updates when another user moves a barge",
      "validation": "Barge position updates in real-time without refresh"
    },
    {
      "area": "Snap to grid",
      "test": "Verify barges snap to grid when option enabled",
      "validation": "Dropped barges align to 20px grid"
    },
    {
      "area": "Keyboard accessibility",
      "test": "Verify barges can be selected and moved with keyboard",
      "validation": "Tab selects barges, arrow keys move, Enter opens context menu"
    },
    {
      "area": "Tow diagram generation",
      "test": "Verify tow diagram renders correctly",
      "validation": "SVG diagram shows barge arrangement, printable"
    }
  ],
  "securityNotes": [
    "All toolbar buttons have data-permission attribute for permission checking",
    "Set Color and Set Note buttons disabled in event mode even with permissions",
    "Drag-and-drop only enabled for users with BargePositionsModify permission",
    "Mode transitions validated server-side to prevent unauthorized access",
    "Concurrent position updates handled with optimistic concurrency or last-write-wins",
    "Event mode deferred save prevents conflicts with barge event processing"
  ],
  "performanceConsiderations": [
    "Use SignalR for real-time updates to reduce polling overhead",
    "Implement debouncing on drag events to reduce AJAX calls during movement",
    "Load only visible barges for large fleets (pagination or viewport-based loading)",
    "Use CSS transforms for orientation changes (faster than re-rendering)",
    "Cache color pair lookups to avoid repeated database queries",
    "Consider canvas rendering for 100+ barges (better performance than DOM elements)"
  ],
  "notes": [
    "BargePositions is the most complex UI in the system - interactive workspace with drag-and-drop",
    "Multiple modes affect available actions: Workspace, InFleet, AtFacility, MidstreamIn/Out, EventMode",
    "Event mode has special deferred save behavior - some changes not persisted until form closes",
    "Real-time updates critical for multi-user scenarios - SignalR strongly recommended",
    "Conflict detection runs every 60 seconds (legacy) - consider real-time with SignalR",
    "Toolbar buttons have complex enabled state logic: permissions + mode + barge selection",
    "Color pairs from BargeTokenColors table - need color name to hex conversion",
    "Tow diagram is key feature - SVG recommended for scalability and print quality",
    "Snap to grid improves usability - 20px grid size is standard",
    "Keyboard accessibility essential for power users - implement arrow key navigation",
    "Feature flags for Onboard and Terminal modes affect available buttons and labels",
    "Context menu on right-click provides quick access to common actions",
    "Status bar shows barge count, conflict count, last update time",
    "Background refresh every 30 seconds (legacy) - replace with SignalR or user-initiated refresh"
  ]
}
