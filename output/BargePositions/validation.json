{
  "entity": "BargePosition",
  "description": "Validation rules for barge positioning system including tier, berth, tow, rake, and anchor wire positions",
  "formValidation": {
    "method": "Implicit in drag-drop operations and UI state",
    "rules": [
      {
        "field": "BargeID",
        "rule": "Required",
        "condition": "BargeID must be > 0",
        "message": "A valid barge must be selected",
        "severity": "Error",
        "validationType": "Client"
      },
      {
        "field": "FleetID",
        "rule": "Required",
        "condition": "FleetID must be set for position updates",
        "message": "Fleet must be specified",
        "severity": "Error",
        "validationType": "Client"
      },
      {
        "field": "PositionType",
        "rule": "RequiredEnum",
        "condition": "Must be one of: 'tier', 'berth', 'tow', 'rake', 'anchor'",
        "message": "Position type must be specified",
        "severity": "Error",
        "validationType": "Both",
        "allowedValues": ["tier", "berth", "tow", "rake", "anchor"]
      },
      {
        "field": "TierID",
        "rule": "ConditionalRequired",
        "condition": "Required when PositionType = 'tier'",
        "message": "Tier must be selected for tier positions",
        "severity": "Error",
        "validationType": "Both",
        "appliesWhen": "PositionType = 'tier'"
      },
      {
        "field": "TierX",
        "rule": "ConditionalRequired",
        "condition": "Required when PositionType = 'tier' and TierX >= 0",
        "message": "Tier X coordinate must be specified",
        "severity": "Error",
        "validationType": "Both",
        "appliesWhen": "PositionType = 'tier'"
      },
      {
        "field": "TierY",
        "rule": "ConditionalRequired",
        "condition": "Required when PositionType = 'tier' and TierY >= 0",
        "message": "Tier Y coordinate must be specified",
        "severity": "Error",
        "validationType": "Both",
        "appliesWhen": "PositionType = 'tier'"
      },
      {
        "field": "FacilityBerthID",
        "rule": "ConditionalRequired",
        "condition": "Required when PositionType = 'berth'",
        "message": "Berth must be selected for berth positions",
        "severity": "Error",
        "validationType": "Both",
        "appliesWhen": "PositionType = 'berth'"
      },
      {
        "field": "FacilityBerthX",
        "rule": "ConditionalRequired",
        "condition": "Required when PositionType = 'berth' and FacilityBerthX >= 0",
        "message": "Berth X coordinate must be specified",
        "severity": "Error",
        "validationType": "Both",
        "appliesWhen": "PositionType = 'berth'"
      },
      {
        "field": "FacilityBerthY",
        "rule": "ConditionalRequired",
        "condition": "Required when PositionType = 'berth' and FacilityBerthY >= 0",
        "message": "Berth Y coordinate must be specified",
        "severity": "Error",
        "validationType": "Both",
        "appliesWhen": "PositionType = 'berth'"
      },
      {
        "field": "RakeDirection",
        "rule": "ConditionalEnum",
        "condition": "Optional for 'rake' position type",
        "message": "Rake direction must be valid",
        "severity": "Warning",
        "validationType": "Both",
        "appliesWhen": "PositionType = 'rake'",
        "allowedValues": ["N", "S", "E", "W", null]
      },
      {
        "field": "HasAnchorWire",
        "rule": "ConditionalBoolean",
        "condition": "Only applies when PositionType = 'anchor'",
        "message": "Anchor wire flag is only applicable for anchor positions",
        "severity": "Warning",
        "validationType": "Both",
        "appliesWhen": "PositionType = 'anchor'"
      }
    ]
  },
  "businessValidation": {
    "method": "BargePositionUpdate stored procedure",
    "location": "C:\\Dev\\BargeOps.Admin.Mono\\OnShore\\database\\Onboard\\procs\\dbo.BargePositionUpdate.StoredProcedure.sql",
    "rules": [
      {
        "ruleName": "PositionNotAlreadyTaken_Tier",
        "property": "TierID, TierX, TierY",
        "condition": "PositionType = 'tier' AND CanOverlap = 0 AND position already occupied by different barge in same fleet",
        "message": "Position already taken",
        "severity": "Error",
        "alwaysApplies": false,
        "appliesWhen": "PositionType = 'tier' and not doing group move",
        "resultCode": -1,
        "storedProcedureLogic": "Lines 109-123: Checks if another barge (b.BargeID <> @BargeID) in the same fleet occupies the same TierID and coordinates (TierX, TierY)"
      },
      {
        "ruleName": "PositionNotAlreadyTaken_Berth",
        "property": "FacilityBerthID, FacilityBerthX, FacilityBerthY",
        "condition": "PositionType = 'berth' AND CanOverlap = 0 AND position already occupied by different barge",
        "message": "Position already taken",
        "severity": "Error",
        "alwaysApplies": false,
        "appliesWhen": "PositionType = 'berth' and not doing group move",
        "resultCode": -1,
        "storedProcedureLogic": "Lines 125-138: Checks if another barge occupies the same FacilityBerthID and coordinates (FacilityBerthX, FacilityBerthY)"
      },
      {
        "ruleName": "PositionNotAlreadyTaken_Tow",
        "property": "LocationID, TowCut, TowString",
        "condition": "PositionType = 'tow' AND position already occupied by different barge in same fleet",
        "message": "Position already taken",
        "severity": "Error",
        "alwaysApplies": false,
        "appliesWhen": "PositionType = 'tow'",
        "resultCode": -1,
        "storedProcedureLogic": "Lines 140-154: Checks if another barge in the same fleet occupies the same location with same TowCut and TowString coordinates"
      },
      {
        "ruleName": "BargeInExpectedPremovePosition_Tier",
        "property": "PremoveTierID, PremoveTierX, PremoveTierY",
        "condition": "PositionType = 'tier' AND PremoveTierID <> -1 AND barge not in expected premove position",
        "message": "Barge not in expected position",
        "severity": "Error",
        "alwaysApplies": false,
        "appliesWhen": "PositionType = 'tier' and not coming from workspace (PremoveTierID <> -1)",
        "resultCode": 0,
        "storedProcedureLogic": "Lines 182-185: WHERE clause checks that current TierID, TierX, TierY match the expected premove coordinates, returns 0 rows if mismatch"
      },
      {
        "ruleName": "BargeInExpectedPremovePosition_Berth",
        "property": "PremoveFacilityBerthID, PremoveFacilityBerthX, PremoveFacilityBerthY",
        "condition": "PositionType = 'berth' AND PremoveFacilityBerthID <> -1 AND barge not in expected premove position",
        "message": "Barge not in expected position",
        "severity": "Error",
        "alwaysApplies": false,
        "appliesWhen": "PositionType = 'berth' and not coming from workspace (PremoveFacilityBerthID <> -1)",
        "resultCode": 0,
        "storedProcedureLogic": "Lines 215-218: WHERE clause checks that current FacilityBerthID, FacilityBerthX, FacilityBerthY match expected premove coordinates"
      },
      {
        "ruleName": "SingleAnchorWirePerTier",
        "property": "HasAnchorWire, TierID",
        "condition": "PositionType = 'anchor' AND HasAnchorWire = 1",
        "message": "Only one barge per tier can have anchor wire set",
        "severity": "Warning",
        "alwaysApplies": false,
        "appliesWhen": "PositionType = 'anchor' and HasAnchorWire = 1",
        "resultCode": 1,
        "storedProcedureLogic": "Lines 74-97: When setting HasAnchorWire=1, automatically clears HasAnchorWire on any other barge in the same tier"
      },
      {
        "ruleName": "RakeDirectionUpdate",
        "property": "RakeDirection",
        "condition": "PositionType = 'rake'",
        "message": "Rake direction updated successfully",
        "severity": "Info",
        "alwaysApplies": false,
        "appliesWhen": "PositionType = 'rake'",
        "resultCode": 1,
        "storedProcedureLogic": "Lines 59-68: Only updates RakeDirection field, no position validation needed"
      },
      {
        "ruleName": "LocationDateTimeSet",
        "property": "LocationDateTime",
        "condition": "Always set to current date without time component",
        "message": "Location date/time must be recorded",
        "severity": "Info",
        "alwaysApplies": true,
        "storedProcedureLogic": "Line 47: SET @LocationDateTime = (SELECT CAST(CONVERT(CHAR(20), @ModifyDateTime,113) AS datetime))"
      },
      {
        "ruleName": "FleetBoatIDAutoSet",
        "property": "FleetBoatID",
        "condition": "Always set from FleetBoatIdentifier table",
        "message": "Fleet boat ID automatically set",
        "severity": "Info",
        "alwaysApplies": true,
        "storedProcedureLogic": "Lines 172, 207, 242: [FleetBoatID] = (SELECT [BoatLocationID] FROM [FleetBoatIdentifier])"
      },
      {
        "ruleName": "MutuallyExclusivePositions_TierAndBerth",
        "property": "TierID, FacilityBerthID, TowCut",
        "condition": "Only one position type can be set at a time",
        "message": "Barge can only have one active position type",
        "severity": "Error",
        "alwaysApplies": true,
        "storedProcedureLogic": "Lines 158-254: Each position type update (tier/berth/tow) explicitly NULLs the other position fields"
      },
      {
        "ruleName": "RakeDirectionPreserved",
        "property": "RakeDirection",
        "condition": "RakeDirection preserved unless explicitly changed",
        "message": "Rake direction maintained across position changes",
        "severity": "Info",
        "alwaysApplies": false,
        "appliesWhen": "RakeDirection not explicitly provided in update",
        "storedProcedureLogic": "Lines 176-179, 211-213, 246-249: CASE statement preserves existing RakeDirection if not provided, or clears if 'none'"
      },
      {
        "ruleName": "AnchorWireClearedOnTierMove",
        "property": "HasAnchorWire",
        "condition": "HasAnchorWire automatically set to 0 when moving to tier position",
        "message": "Anchor wire cleared when moving to tier",
        "severity": "Info",
        "alwaysApplies": false,
        "appliesWhen": "PositionType = 'tier'",
        "storedProcedureLogic": "Line 180: [HasAnchorWire] = 0 in tier UPDATE statement"
      }
    ]
  },
  "collectionValidation": {
    "method": "BargePositions.Update",
    "location": "C:\\Dev\\BargeOps.Admin.Mono\\OnShore\\apps\\Onshore.BusinessLogic\\Business Objects\\BargePositions.vb:235-253",
    "rules": [
      {
        "ruleName": "CollectUpdateResults",
        "property": "UpdateResult",
        "condition": "Aggregates all child update results with bitwise flags",
        "message": "One or more position updates failed",
        "severity": "Error",
        "alwaysApplies": true,
        "bitwiseFlags": [
          {
            "bit": 1,
            "meaning": "Position was already taken",
            "childResultCode": -1
          },
          {
            "bit": 2,
            "meaning": "Barge not in expected premove position",
            "childResultCode": 0
          }
        ],
        "storedProcedureLogic": "Lines 242-250: Iterates through all BargePosition children, checks Result property, sets bitwise flags in p_UpdateResult"
      }
    ]
  },
  "validationPatterns": {
    "positionConflictDetection": {
      "pattern": "Check if target position already occupied",
      "applicability": "tier, berth, tow positions",
      "implementation": "Database query counting barges at same coordinates",
      "bypassCondition": "@CanOverlap = 1 (group move operations)"
    },
    "premoveValidation": {
      "pattern": "Verify barge is where UI thinks it is before moving",
      "applicability": "tier and berth positions when not from workspace",
      "implementation": "WHERE clause with premove coordinates in UPDATE statement",
      "bypassCondition": "PremoveTierID = -1 or PremoveFacilityBerthID = -1 (coming from workspace)"
    },
    "coordinateValidation": {
      "pattern": "Negative or NULL coordinates represent no position",
      "applicability": "All position types",
      "implementation": "CASE WHEN ISNULL(@Coord,0) <= 0 THEN NULL ELSE @Coord END",
      "note": "Coordinates < 0 or NULL indicate barge in workspace/no position"
    },
    "positionTypeMutex": {
      "pattern": "Setting one position type clears all others",
      "applicability": "All position updates",
      "implementation": "Each UPDATE explicitly sets other position fields to NULL",
      "note": "Ensures barge can only be in one position at a time"
    },
    "singleAnchorWire": {
      "pattern": "Only one barge per tier can have anchor wire",
      "applicability": "Anchor wire operations",
      "implementation": "Find other barge with anchor wire in same tier, clear it before setting new one",
      "note": "Automatic enforcement, no error returned to user"
    }
  },
  "modernValidationMapping": {
    "dataAnnotations": [
      {
        "property": "FleetID",
        "annotation": "[Required(ErrorMessage = \"Fleet must be specified\")]"
      },
      {
        "property": "BargeID",
        "annotation": "[Required(ErrorMessage = \"A valid barge must be selected\")]"
      },
      {
        "property": "PositionType",
        "annotation": "[Required(ErrorMessage = \"Position type must be specified\")]"
      }
    ],
    "fluentValidation": [
      {
        "ruleName": "PositionTypeValidation",
        "code": "RuleFor(x => x.PositionType)\n    .NotEmpty()\n    .WithMessage(\"Position type must be specified\")\n    .Must(t => new[] { \"tier\", \"berth\", \"tow\", \"rake\", \"anchor\" }.Contains(t))\n    .WithMessage(\"Position type must be tier, berth, tow, rake, or anchor\");"
      },
      {
        "ruleName": "TierPositionValidation",
        "code": "When(x => x.PositionType == \"tier\", () => {\n    RuleFor(x => x.TierID)\n        .GreaterThan(0)\n        .WithMessage(\"Tier must be selected for tier positions\");\n    RuleFor(x => x.TierX)\n        .GreaterThanOrEqualTo(0)\n        .WithMessage(\"Tier X coordinate must be specified\");\n    RuleFor(x => x.TierY)\n        .GreaterThanOrEqualTo(0)\n        .WithMessage(\"Tier Y coordinate must be specified\");\n});"
      },
      {
        "ruleName": "BerthPositionValidation",
        "code": "When(x => x.PositionType == \"berth\", () => {\n    RuleFor(x => x.FacilityBerthID)\n        .GreaterThan(0)\n        .WithMessage(\"Berth must be selected for berth positions\");\n    RuleFor(x => x.FacilityBerthX)\n        .GreaterThanOrEqualTo(0)\n        .WithMessage(\"Berth X coordinate must be specified\");\n    RuleFor(x => x.FacilityBerthY)\n        .GreaterThanOrEqualTo(0)\n        .WithMessage(\"Berth Y coordinate must be specified\");\n});"
      },
      {
        "ruleName": "PositionConflictValidation",
        "code": "RuleFor(x => x)\n    .MustAsync(async (position, cancellation) => {\n        return await _repository.IsPositionAvailableAsync(\n            position.BargeID,\n            position.PositionType,\n            position.TierID,\n            position.TierX,\n            position.TierY,\n            position.FacilityBerthID,\n            position.FacilityBerthX,\n            position.FacilityBerthY,\n            position.FleetID\n        );\n    })\n    .WithMessage(\"Position already taken\")\n    .When(x => x.PositionType is \"tier\" or \"berth\" or \"tow\" && !x.CanOverlap);"
      },
      {
        "ruleName": "PremovePositionValidation",
        "code": "RuleFor(x => x)\n    .MustAsync(async (position, cancellation) => {\n        if (position.PositionType == \"tier\" && position.PremoveTierID > 0) {\n            return await _repository.VerifyBargeLocationAsync(\n                position.BargeID,\n                position.PremoveTierID,\n                position.PremoveTierX,\n                position.PremoveTierY\n            );\n        }\n        if (position.PositionType == \"berth\" && position.PremoveFacilityBerthID > 0) {\n            return await _repository.VerifyBargeBerthLocationAsync(\n                position.BargeID,\n                position.PremoveFacilityBerthID,\n                position.PremoveFacilityBerthX,\n                position.PremoveFacilityBerthY\n            );\n        }\n        return true;\n    })\n    .WithMessage(\"Barge not in expected position\");"
      }
    ],
    "clientSideValidation": [
      {
        "library": "jquery.validate",
        "ruleName": "PositionTypeRequired",
        "code": "rules: {\n    PositionType: {\n        required: true\n    }\n}"
      },
      {
        "library": "jquery.validate",
        "ruleName": "ConditionalTierFields",
        "code": "rules: {\n    TierID: {\n        required: function() {\n            return $('#PositionType').val() === 'tier';\n        }\n    },\n    TierX: {\n        required: function() {\n            return $('#PositionType').val() === 'tier';\n        },\n        min: 0\n    },\n    TierY: {\n        required: function() {\n            return $('#PositionType').val() === 'tier';\n        },\n        min: 0\n    }\n}"
      },
      {
        "library": "Custom AJAX",
        "ruleName": "AsyncPositionConflictCheck",
        "code": "// On drag-drop or coordinate change\n$.ajax({\n    url: '/api/bargeposition/check-conflict',\n    method: 'POST',\n    data: {\n        bargeId: bargeId,\n        positionType: positionType,\n        tierId: tierId,\n        tierX: tierX,\n        tierY: tierY,\n        fleetId: fleetId\n    },\n    success: function(result) {\n        if (result.conflict) {\n            showError('Position already taken');\n            revertDrop();\n        }\n    }\n});"
      }
    ]
  },
  "resultCodes": {
    "description": "Result codes returned from BargePositionUpdate stored procedure",
    "codes": [
      {
        "value": 1,
        "meaning": "Success - position updated",
        "action": "Continue processing"
      },
      {
        "value": 0,
        "meaning": "Barge not in expected premove position",
        "action": "Refresh UI and notify user that barge was already moved"
      },
      {
        "value": -1,
        "meaning": "Position already taken by another barge",
        "action": "Prevent drop, show error message, return barge to original position"
      }
    ],
    "collectionResultBits": {
      "bit1": "At least one position was already taken (result = -1)",
      "bit2": "At least one barge was not in expected position (result = 0)"
    }
  },
  "specialCases": {
    "workspacePositions": {
      "description": "Barges in workspace have no tier/berth/tow position",
      "validation": "All position IDs and coordinates are -1 or NULL",
      "premoveCheck": "Bypassed when PremoveTierID = -1 or PremoveFacilityBerthID = -1"
    },
    "groupMoves": {
      "description": "Multiple barges moved simultaneously",
      "validation": "Position conflict check bypassed with @CanOverlap = 1",
      "note": "Used when shifting entire tiers or reorganizing positions"
    },
    "rakeOperations": {
      "description": "Only updates RakeDirection, no position change",
      "validation": "No position conflict or premove validation needed",
      "positionType": "rake"
    },
    "anchorWireOperations": {
      "description": "Sets or clears HasAnchorWire flag",
      "validation": "Automatically enforces single anchor wire per tier",
      "positionType": "anchor",
      "sideEffect": "Clears HasAnchorWire on other barge in same tier if setting to true"
    },
    "towDiagrams": {
      "description": "Barges positioned in tow configuration",
      "validation": "Uses TowCut (X) and TowString (Y) coordinates",
      "positionType": "tow",
      "conflictCheck": "Prevents barges in same fleet from occupying same tow position"
    }
  },
  "errorMessages": {
    "positionTaken": "Position already taken",
    "bargeNotInPosition": "Barge not in expected position",
    "invalidPositionType": "Position type must be tier, berth, tow, rake, or anchor",
    "tierRequired": "Tier must be selected for tier positions",
    "berthRequired": "Berth must be selected for berth positions",
    "coordinatesRequired": "Position coordinates must be specified",
    "fleetRequired": "Fleet must be specified",
    "bargeRequired": "A valid barge must be selected"
  },
  "implementationNotes": {
    "validationLocation": "Primary validation occurs in database stored procedure",
    "clientSideValidation": "Minimal - mostly UI state validation for drag-drop operations",
    "concurrencyHandling": "Premove validation handles concurrent edits by checking current position matches expected",
    "transactionSupport": "All position updates occur within SQL transaction",
    "auditTrail": "ModifyDateTime and ModifyUser tracked on every update",
    "syncSupport": "TransactionOutboxInsert called for successful updates to support synchronization"
  }
}
