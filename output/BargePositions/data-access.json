{
  "entity": "BargePosition",
  "softDelete": false,
  "hasIsActive": false,
  "analysis": {
    "notes": [
      "BargePosition is not a traditional CRUD entity - it manages barge position updates within fleet workspaces",
      "Primary operation is position update validation and execution (move barges between tiers/berths)",
      "Uses a single stored procedure (BargePositionUpdate) for all modifications",
      "Complex querying system with dispatcher pattern - BargePositionList routes to multiple specialized SPs",
      "No traditional GetById - positions are queried by fleet context and location type",
      "Position validation checks: position already taken, barge in expected location",
      "Result codes: -1 = position taken, 0 = barge not in expected location, 1 = success"
    ]
  },
  "storedProcedures": [
    {
      "name": "BargePositionList",
      "operation": "Search/List (Dispatcher)",
      "parameters": [
        {
          "name": "@GridType",
          "type": "varchar(25)",
          "required": true,
          "description": "workspace, tiergroup, berth, or towdiagram"
        },
        {
          "name": "@FleetID",
          "type": "int",
          "required": true
        },
        {
          "name": "@Mode",
          "type": "varchar(25)",
          "required": true,
          "description": "workspace, midstream-in, midstream-out, etc."
        },
        {
          "name": "@TierGroupID",
          "type": "int",
          "required": false
        },
        {
          "name": "@LocationID",
          "type": "int",
          "required": false
        },
        {
          "name": "@UserFleetViewID",
          "type": "int",
          "required": true
        },
        {
          "name": "@IsEvent",
          "type": "bit",
          "required": true
        }
      ],
      "resultColumns": [
        {
          "column": "BargeID",
          "property": "BargeID",
          "type": "int"
        },
        {
          "column": "BargeNum",
          "property": "BargeNum",
          "type": "string"
        },
        {
          "column": "TierID",
          "property": "TierID",
          "type": "int"
        },
        {
          "column": "GridX",
          "property": "GridX",
          "type": "short"
        },
        {
          "column": "TierY",
          "property": "TierY",
          "type": "short"
        },
        {
          "column": "EquipmentType",
          "property": "EquipmentType",
          "type": "string"
        },
        {
          "column": "TrText",
          "property": "TrText",
          "type": "string",
          "description": "Top-right cell text"
        },
        {
          "column": "TrTextColor",
          "property": "TrTextColor",
          "type": "string"
        },
        {
          "column": "TrBackColor",
          "property": "TrBackColor",
          "type": "string"
        },
        {
          "column": "TrPicture",
          "property": "TrPicture",
          "type": "byte[]",
          "description": "Binary image data converted to System.Drawing.Image"
        },
        {
          "column": "BlText",
          "property": "BlText",
          "type": "string",
          "description": "Bottom-left cell text"
        },
        {
          "column": "BlTextColor",
          "property": "BlTextColor",
          "type": "string"
        },
        {
          "column": "BlBackColor",
          "property": "BlBackColor",
          "type": "string"
        },
        {
          "column": "BmText",
          "property": "BmText",
          "type": "string",
          "description": "Bottom-middle cell text"
        },
        {
          "column": "BmTextColor",
          "property": "BmTextColor",
          "type": "string"
        },
        {
          "column": "BmBackColor",
          "property": "BmBackColor",
          "type": "string"
        },
        {
          "column": "BrText",
          "property": "BrText",
          "type": "string",
          "description": "Bottom-right cell text"
        },
        {
          "column": "BrTextColor",
          "property": "BrTextColor",
          "type": "string"
        },
        {
          "column": "BrBackColor",
          "property": "BrBackColor",
          "type": "string"
        },
        {
          "column": "TextColor",
          "property": "TextColor",
          "type": "string"
        },
        {
          "column": "BackColor",
          "property": "BackColor",
          "type": "string"
        },
        {
          "column": "ViewFleetBackColor",
          "property": "ViewFleetBackColor",
          "type": "string"
        },
        {
          "column": "CanMoveToEvent",
          "property": "CanMoveToEvent",
          "type": "bool"
        },
        {
          "column": "EventFleetLocationID",
          "property": "EventFleetLocationID",
          "type": "string"
        },
        {
          "column": "CleanStatus",
          "property": "CleanStatus",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "CommodityName",
          "property": "CommodityName",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "ConsignTo",
          "property": "ConsignTo",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "CoverConfig",
          "property": "CoverConfig",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "CoverType",
          "property": "CoverType",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "CustomerName",
          "property": "CustomerName",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "DamageLevel",
          "property": "DamageLevel",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "DestinationIn",
          "property": "DestinationIn",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "DestinationOut",
          "property": "DestinationOut",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "HasInsufficientFreeboard",
          "property": "HasInsufficientFreeboard",
          "type": "bool",
          "description": "Tooltip field"
        },
        {
          "column": "HullType",
          "property": "HullType",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "InspectionStatus",
          "property": "InspectionStatus",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "IsCargoDamaged",
          "property": "IsCargoDamaged",
          "type": "bool",
          "description": "Tooltip field"
        },
        {
          "column": "IsDamageNoted",
          "property": "IsDamageNoted",
          "type": "bool",
          "description": "Tooltip field"
        },
        {
          "column": "IsLeaker",
          "property": "IsLeaker",
          "type": "bool",
          "description": "Tooltip field"
        },
        {
          "column": "IsOnHold",
          "property": "IsOnHold",
          "type": "bool",
          "description": "Tooltip field"
        },
        {
          "column": "IsOnOrder",
          "property": "IsOnOrder",
          "type": "bool",
          "description": "Tooltip field"
        },
        {
          "column": "OnOrderTripNumber",
          "property": "OnOrderTripNumber",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "IsRepairScheduled",
          "property": "IsRepairScheduled",
          "type": "bool",
          "description": "Tooltip field"
        },
        {
          "column": "LoadFirst",
          "property": "LoadFirst",
          "type": "bool",
          "description": "Tooltip field"
        },
        {
          "column": "LoadLast",
          "property": "LoadLast",
          "type": "bool",
          "description": "Tooltip field"
        },
        {
          "column": "LoadMultipleLots",
          "property": "LoadMultipleLots",
          "type": "bool",
          "description": "Tooltip field"
        },
        {
          "column": "LoadStatus",
          "property": "LoadStatus",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "RepairStatus",
          "property": "RepairStatus",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "ScheduledOut",
          "property": "ScheduledOut",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "FleetFacility",
          "property": "FleetFacility",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "CurLocation",
          "property": "CurLocation",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "CargoHandlingStatus",
          "property": "CargoHandlingStatus",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "CargoCustomer",
          "property": "CargoCustomer",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "Cargo",
          "property": "Cargo",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "SampleFlag",
          "property": "SampleFlag",
          "type": "bool",
          "description": "Tooltip field"
        },
        {
          "column": "DraftFlag",
          "property": "DraftFlag",
          "type": "bool",
          "description": "Tooltip field"
        },
        {
          "column": "ReleasedDateTime",
          "property": "ReleasedDateTime",
          "type": "DateTime",
          "description": "Tooltip field"
        },
        {
          "column": "RakeDirection",
          "property": "RakeDirection",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "RakeColor",
          "property": "RakeColor",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "HasAnchorWire",
          "property": "HasAnchorWire",
          "type": "bool",
          "description": "Tooltip field"
        },
        {
          "column": "AnchorWireBackColor",
          "property": "AnchorWireBackColor",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "AnchorWireTextColor",
          "property": "AnchorWireTextColor",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "DraftRequested",
          "property": "DraftRequested",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "SizeCategory",
          "property": "SizeCategory",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "ShipHold",
          "property": "ShipHold",
          "type": "string",
          "description": "Tooltip field"
        },
        {
          "column": "ViewFleetNote",
          "property": "ViewFleetNote",
          "type": "string",
          "description": "Tooltip field"
        }
      ],
      "notes": [
        "Dispatcher pattern - routes to specialized stored procedures based on GridType and Mode",
        "Calls: BargePositionWorkspace, BargePositionTierGroup, BargePositionBerth, BargePositionTowDiagram, etc.",
        "Extremely complex result set with UI-specific fields (colors, pictures, tooltip data)",
        "Legacy grid control pattern with quadrant text fields (Tr, Bl, Bm, Br)"
      ]
    },
    {
      "name": "BargePositionUpdate",
      "operation": "Update",
      "parameters": [
        {
          "name": "@FleetID",
          "type": "int",
          "required": true
        },
        {
          "name": "@BargeID",
          "type": "int",
          "required": true
        },
        {
          "name": "@BargeLocationID",
          "type": "int",
          "required": true
        },
        {
          "name": "@TierID",
          "type": "int",
          "required": true
        },
        {
          "name": "@FacilityBerthID",
          "type": "int",
          "required": true
        },
        {
          "name": "@PremoveTierID",
          "type": "int",
          "required": true,
          "description": "-1 if coming from workspace"
        },
        {
          "name": "@PremoveFacilityBerthID",
          "type": "int",
          "required": true,
          "description": "-1 if coming from workspace"
        },
        {
          "name": "@LocationX",
          "type": "int",
          "required": true
        },
        {
          "name": "@LocationY",
          "type": "int",
          "required": true
        },
        {
          "name": "@PremoveLocationX",
          "type": "int",
          "required": true
        },
        {
          "name": "@PremoveLocationY",
          "type": "int",
          "required": true
        },
        {
          "name": "@ValidateOnly",
          "type": "bit",
          "required": true,
          "description": "When true, only validates position without updating"
        },
        {
          "name": "@FleetBoatID",
          "type": "int",
          "required": true
        },
        {
          "name": "@PositionType",
          "type": "varchar(6)",
          "required": true,
          "description": "tier, berth, rake, or anchor"
        },
        {
          "name": "@RakeDirection",
          "type": "varchar(5)",
          "required": false
        },
        {
          "name": "@HasAnchorWire",
          "type": "bit",
          "required": true,
          "description": "Only applies when PositionType is 'anchor'"
        },
        {
          "name": "@Result",
          "type": "int",
          "direction": "OUTPUT",
          "description": "-1 = position already taken; 0 = barge not where expected; 1 = success"
        },
        {
          "name": "@ModifyDateTime",
          "type": "datetime",
          "direction": "OUTPUT"
        },
        {
          "name": "@ModifyUser",
          "type": "varchar(50)",
          "required": true
        }
      ],
      "businessLogic": [
        "Validates position not already taken by another barge with open ticket in same fleet",
        "Checks barge is in expected pre-move position (unless coming from workspace)",
        "Handles multiple position types: tier (fleet position), berth (facility position), rake (direction only), anchor (wire flag)",
        "When PositionType='rake', only updates RakeDirection field",
        "When PositionType='anchor' and HasAnchorWire=1, sets current barge as anchor and clears all others in same tier",
        "When moving to tier position, clears FacilityBerth fields and sets Tier fields",
        "When moving to berth position, clears Tier fields and sets FacilityBerth fields",
        "Updates FleetBoatID and FleetBoatActivityDateTime when boat assignment changes",
        "Clears HasAnchorWire when moving barges (unless PositionType='anchor')",
        "Only updates if barge in expected pre-move location (optimistic concurrency)"
      ],
      "notes": [
        "Multi-purpose update procedure handling position moves, validations, rake changes, anchor wire assignment",
        "Not a traditional Update - more of a state transition manager",
        "Used for Insert, Update, and Delete operations in legacy framework"
      ]
    },
    {
      "name": "BargePositionDuplicateSearch",
      "operation": "Search",
      "parameters": [
        {
          "name": "@SelectedFleetID",
          "type": "int",
          "required": true
        }
      ],
      "resultColumns": [
        {
          "column": "TierGroup",
          "property": "TierGroup",
          "type": "string"
        },
        {
          "column": "TierPosition",
          "property": "TierPosition",
          "type": "string",
          "description": "Formatted as 'Name (X,Y)'"
        },
        {
          "column": "Barges",
          "property": "Barges",
          "type": "string",
          "description": "Comma-separated list of barge numbers"
        }
      ],
      "notes": [
        "Finds tier positions with multiple barges at same coordinates",
        "Used for validation/reporting of position conflicts",
        "Returns aggregated list of barges per duplicate position"
      ]
    }
  ],
  "sqlFiles": [
    {
      "fileName": "BargePosition_Search.sql",
      "operation": "Search",
      "description": "Search barge positions by fleet, mode, and grid type - replaces BargePositionList dispatcher"
    },
    {
      "fileName": "BargePosition_SearchWorkspace.sql",
      "operation": "Search",
      "description": "Workspace grid view - called when GridType='workspace'"
    },
    {
      "fileName": "BargePosition_SearchTierGroup.sql",
      "operation": "Search",
      "description": "Tier group grid view - called when GridType='tiergroup'"
    },
    {
      "fileName": "BargePosition_SearchBerth.sql",
      "operation": "Search",
      "description": "Berth grid view - called when GridType='berth'"
    },
    {
      "fileName": "BargePosition_SearchTowDiagram.sql",
      "operation": "Search",
      "description": "Tow diagram view - called when GridType='towdiagram'"
    },
    {
      "fileName": "BargePosition_UpdatePosition.sql",
      "operation": "Update",
      "description": "Move barge to new tier or berth position with validation"
    },
    {
      "fileName": "BargePosition_ValidatePosition.sql",
      "operation": "Validate",
      "description": "Check if position move is valid without executing"
    },
    {
      "fileName": "BargePosition_UpdateRakeDirection.sql",
      "operation": "Update",
      "description": "Update rake direction only"
    },
    {
      "fileName": "BargePosition_SetAnchorWire.sql",
      "operation": "Update",
      "description": "Set anchor wire flag (clears all other barges in tier)"
    },
    {
      "fileName": "BargePosition_SearchDuplicates.sql",
      "operation": "Search",
      "description": "Find tier positions with multiple barges at same coordinates"
    }
  ],
  "repositoryInterface": {
    "name": "IBargePositionRepository",
    "namespace": "Admin.Infrastructure.Abstractions",
    "methods": [
      {
        "name": "SearchPositionsAsync",
        "returnType": "Task<IEnumerable<BargePositionDto>>",
        "parameters": [
          "string gridType",
          "int fleetId",
          "string mode",
          "int? tierGroupId",
          "int? locationId",
          "int userFleetViewId",
          "bool isEvent"
        ]
      },
      {
        "name": "UpdatePositionAsync",
        "returnType": "Task<BargePositionUpdateResult>",
        "parameters": ["BargePositionUpdateRequest request"]
      },
      {
        "name": "ValidatePositionAsync",
        "returnType": "Task<BargePositionValidationResult>",
        "parameters": ["BargePositionUpdateRequest request"]
      },
      {
        "name": "UpdateRakeDirectionAsync",
        "returnType": "Task<bool>",
        "parameters": ["int bargeId", "string rakeDirection"]
      },
      {
        "name": "SetAnchorWireAsync",
        "returnType": "Task<bool>",
        "parameters": ["int bargeId", "bool hasAnchorWire"]
      },
      {
        "name": "SearchDuplicatePositionsAsync",
        "returnType": "Task<IEnumerable<BargePositionDuplicateDto>>",
        "parameters": ["int fleetId"]
      }
    ]
  },
  "dtoClasses": [
    {
      "name": "BargePositionDto",
      "namespace": "BargeOps.Shared.Dto",
      "properties": [
        "int BargeId",
        "string BargeNum",
        "int TierId",
        "short GridX",
        "short TierY",
        "string EquipmentType",
        "BargePositionCellDto TopRight",
        "BargePositionCellDto BottomLeft",
        "BargePositionCellDto BottomMiddle",
        "BargePositionCellDto BottomRight",
        "string TextColor",
        "string BackColor",
        "string ViewFleetBackColor",
        "bool CanMoveToEvent",
        "string EventFleetLocationId",
        "BargePositionTooltipDto Tooltip"
      ],
      "notes": [
        "Nested DTOs for cell data (text, color, picture) and tooltip data",
        "Picture data as Base64 string instead of binary"
      ]
    },
    {
      "name": "BargePositionCellDto",
      "namespace": "BargeOps.Shared.Dto",
      "properties": [
        "string Text",
        "string TextColor",
        "string BackColor",
        "string PictureBase64"
      ]
    },
    {
      "name": "BargePositionTooltipDto",
      "namespace": "BargeOps.Shared.Dto",
      "properties": [
        "string CleanStatus",
        "string CommodityName",
        "string ConsignTo",
        "string CoverConfig",
        "string CoverType",
        "string CustomerName",
        "string DamageLevel",
        "string DestinationIn",
        "string DestinationOut",
        "bool HasInsufficientFreeboard",
        "string HullType",
        "string InspectionStatus",
        "bool IsCargoDamaged",
        "bool IsDamageNoted",
        "bool IsLeaker",
        "bool IsOnHold",
        "bool IsOnOrder",
        "string OnOrderTripNumber",
        "bool IsRepairScheduled",
        "bool LoadFirst",
        "bool LoadLast",
        "bool LoadMultipleLots",
        "string LoadStatus",
        "string RepairStatus",
        "string ScheduledOut",
        "string FleetFacility",
        "string CurLocation",
        "string CargoHandlingStatus",
        "string CargoCustomer",
        "string Cargo",
        "bool SampleFlag",
        "bool DraftFlag",
        "DateTime? ReleasedDateTime",
        "string RakeDirection",
        "string RakeColor",
        "bool HasAnchorWire",
        "string AnchorWireBackColor",
        "string AnchorWireTextColor",
        "string DraftRequested",
        "string SizeCategory",
        "string ShipHold",
        "string ViewFleetNote"
      ]
    },
    {
      "name": "BargePositionUpdateRequest",
      "namespace": "BargeOps.Shared.Dto",
      "properties": [
        "int FleetId",
        "int BargeId",
        "int BargeLocationId",
        "int TierId",
        "int FacilityBerthId",
        "int PremoveTierId",
        "int PremoveFacilityBerthId",
        "int LocationX",
        "int LocationY",
        "int PremoveLocationX",
        "int PremoveLocationY",
        "bool ValidateOnly",
        "int FleetBoatId",
        "string PositionType",
        "string RakeDirection",
        "bool HasAnchorWire"
      ]
    },
    {
      "name": "BargePositionUpdateResult",
      "namespace": "BargeOps.Shared.Dto",
      "properties": [
        "int ResultCode",
        "string ResultMessage",
        "DateTime ModifyDateTime"
      ],
      "notes": [
        "ResultCode: -1 = position already taken, 0 = barge not where expected, 1 = success"
      ]
    },
    {
      "name": "BargePositionValidationResult",
      "namespace": "BargeOps.Shared.Dto",
      "properties": [
        "bool IsValid",
        "string ValidationMessage"
      ]
    },
    {
      "name": "BargePositionDuplicateDto",
      "namespace": "BargeOps.Shared.Dto",
      "properties": [
        "string TierGroup",
        "string TierPosition",
        "string Barges"
      ]
    }
  ],
  "listQueryFields": {
    "filterable": [
      "BargeNum",
      "EquipmentType",
      "CleanStatus",
      "LoadStatus",
      "CustomerName",
      "CommodityName",
      "FleetFacility",
      "CurLocation"
    ],
    "sortable": [
      "BargeNum",
      "TierGroup",
      "TierPosition",
      "CleanStatus",
      "LoadStatus"
    ],
    "defaultSort": "BargeNum ASC",
    "notes": [
      "ListQuery may not apply to grid-based position views",
      "More applicable to duplicate search and reporting queries"
    ]
  },
  "dataTransformations": [
    {
      "field": "TrPicture",
      "from": "byte[]",
      "to": "System.Drawing.Image",
      "logic": "Binary data from database converted to Image via MemoryStream"
    },
    {
      "field": "TierPosition (Duplicates)",
      "from": "Name, TierX, TierY",
      "to": "string",
      "logic": "Formatted as 'Name (X,Y)'"
    },
    {
      "field": "Barges (Duplicates)",
      "from": "Multiple BargeNum",
      "to": "string",
      "logic": "XML PATH aggregation to comma-separated list"
    }
  ],
  "specializedSqlFiles": {
    "notes": [
      "Legacy system uses 15+ specialized stored procedures for different grid views",
      "Modern approach should consolidate with query parameters or separate repository methods",
      "Key specialized SPs to consider: BargePositionWorkspace, BargePositionTierGroup, BargePositionBerth, BargePositionTowDiagram, BargePositionFacilities, BargePositionTows, BargePositionInTransitList"
    ],
    "procedures": [
      "BargePositionWorkspace",
      "BargePositionTierGroup",
      "BargePositionBerth",
      "BargePositionTowDiagram",
      "BargePositionTowDiagramFleet",
      "BargePositionTowDiagramLine",
      "BargePositionFacilities",
      "BargePositionTows",
      "BargePositionInTransitList",
      "BargePositionFleetBoatTowWorkspaceList",
      "BargePositionFleetBoatTowDiagramList",
      "BargePositionMyTowWorkspaceList",
      "BargePositionMyTowDiagramList",
      "BargePositionExternalBoatList",
      "rptBargePositionsCurrent",
      "rptBargePositionsAsOf7am"
    ]
  },
  "implementationNotes": [
    "BargePosition is NOT a traditional entity - it's a workspace state manager",
    "No Insert/Delete operations in traditional sense - only position updates",
    "Complex validation logic around position conflicts and barge location verification",
    "Highly UI-coupled with grid quadrant fields and color coding",
    "Consider separating concerns: BargePositionQuery (read-only grid data) vs BargePositionCommand (updates)",
    "May benefit from CQRS pattern due to complex read requirements vs simple update commands",
    "Image handling will need modernization (Base64 encoding for web vs binary streams)",
    "Dispatcher pattern in BargePositionList SP should be replaced with explicit repository methods",
    "Result codes from update should be converted to proper exceptions or result objects",
    "Consider event sourcing for position history/audit trail"
  ]
}
