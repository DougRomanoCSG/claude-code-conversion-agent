{
  "formName": "frmBargePositions",
  "implements": ["IBaseDetailEdit"],
  "title": "BargeOps Onshore - Fleet",
  "formType": "DetailEdit",
  "baseClass": "frmBaseDetailEdit",
  "description": "Complex drag-and-drop interface for managing barge positions across workspace, tier groups, and berths. Supports multiple operational modes: In Fleet, At Facility/Ship, Midstream updates, and Tow Diagrams.",
  "operationalModes": [
    {
      "name": "In Fleet",
      "value": "In Fleet",
      "description": "Standard fleet workspace view showing all barges in fleet"
    },
    {
      "name": "At Facility/Ship",
      "value": "At Facility/Ship",
      "description": "View barges positioned at specific facilities or ships"
    },
    {
      "name": "Midstream-In Update",
      "value": "Midstream-In Update",
      "description": "Update barges coming into midstream positions"
    },
    {
      "name": "Midstream-Out Update",
      "value": "Midstream-Out Update",
      "description": "Update barges going out of midstream positions"
    },
    {
      "name": "Tow Diagram",
      "value": "Tow Diagram",
      "description": "Visual tow diagram view for arranging barges in tow configuration"
    }
  ],
  "customControls": [
    {
      "name": "ctlWorkspace",
      "type": "CsgContainerGrid",
      "category": "WorkspaceGrid",
      "description": "Main drag-and-drop grid for workspace barge positioning",
      "properties": {
        "AllowDrop": true,
        "AutoScroll": true,
        "CellSize": "90x24",
        "Dimensions": "3x3",
        "DragMode": "Move",
        "ShowHeaders": false,
        "MultiSelectMode": "Single",
        "Origin": "TopLeft"
      },
      "dock": "Top",
      "events": [
        "BeforeControlDropped",
        "ControlDropped",
        "SelectionChanged",
        "Click"
      ],
      "modernEquivalent": "Custom HTML5 Canvas or SVG-based drag-drop grid with server-side state management"
    },
    {
      "name": "ctlTierGroup",
      "type": "CsgContainerGrid",
      "category": "TierGroupGrid",
      "description": "Drag-and-drop grid for tier group barge positioning",
      "properties": {
        "AllowDrop": true,
        "AutoScroll": true,
        "CellSize": "90x24",
        "Dimensions": "4x4",
        "DragMode": "Move",
        "MultiSelectMode": "Single",
        "Origin": "Bottom"
      },
      "dock": "Fill",
      "events": [
        "BeforeControlDropped",
        "ControlDropped",
        "GridCellClicked",
        "SelectionChanged"
      ],
      "modernEquivalent": "Custom HTML5 Canvas or SVG-based drag-drop grid with server-side state management"
    }
  ],
  "toolbars": [
    {
      "name": "MainToolbarManager",
      "type": "UltraToolbarsManager",
      "toolbarName": "UltraToolbar1",
      "description": "Main toolbar for fleet/facility selection and mode switching",
      "tools": [
        {
          "key": "Mode Combo",
          "type": "ComboBoxTool",
          "caption": "Mode:",
          "width": 196,
          "values": [
            "In Fleet",
            "At Facility/Ship",
            "Midstream-In Update",
            "Midstream-Out Update",
            "Tow Diagram"
          ],
          "required": true,
          "handler": "MainToolbarManager_ToolValueChanged"
        },
        {
          "key": "Boat Combo",
          "type": "ComboBoxTool",
          "caption": "Boat:",
          "width": 160,
          "visible": false,
          "populationMethod": "LoadBoatList",
          "handler": "MainToolbarManager_ToolValueChanged"
        },
        {
          "key": "Facility Combo",
          "type": "ComboBoxTool",
          "caption": "Facility:",
          "width": 160,
          "visible": false,
          "populationMethod": "LoadFacilityList",
          "handler": "MainToolbarManager_ToolValueChanged"
        },
        {
          "key": "Refresh",
          "type": "ButtonTool",
          "caption": "Re&fresh",
          "displayStyle": "ImageAndText",
          "image": "Refresh icon",
          "isFirstInGroup": true,
          "handler": "MainToolbarManager_ToolClick"
        },
        {
          "key": "History",
          "type": "ButtonTool",
          "caption": "&History",
          "displayStyle": "ImageAndText",
          "image": "History icon",
          "handler": "MainToolbarManager_ToolClick"
        },
        {
          "key": "Define Color Legend",
          "type": "ButtonTool",
          "caption": "D&efine Color Legend",
          "displayStyle": "ImageAndText",
          "image": "ColorList icon",
          "isFirstInGroup": true,
          "handler": "MainToolbarManager_ToolClick",
          "security": "Modify"
        },
        {
          "key": "Close",
          "type": "ButtonTool",
          "caption": "&Close",
          "displayStyle": "ImageAndText",
          "image": "Close icon",
          "isFirstInGroup": true,
          "handler": "MainToolbarManager_ToolClick"
        }
      ]
    },
    {
      "name": "MainToolbarManager",
      "type": "UltraToolbarsManager",
      "toolbarName": "UltraToolbar2",
      "description": "Secondary toolbar for barge manipulation operations",
      "tools": [
        {
          "key": "Servicing Boat Combo",
          "type": "ComboBoxTool",
          "caption": "Servicing Boat:",
          "displayStyle": "ImageAndText",
          "populationMethod": "LoadFleetBoatList",
          "handler": "MainToolbarManager_ToolValueChanged"
        },
        {
          "key": "Flip Barge",
          "type": "ButtonTool",
          "caption": "Flip &Barge",
          "displayStyle": "ImageAndText",
          "image": "FlipHorizontal icon",
          "isFirstInGroup": true,
          "handler": "MainToolbarManager_ToolClick"
        },
        {
          "key": "Show Tow Diagram",
          "type": "StateButtonTool",
          "caption": "Show T&ow Diagram",
          "displayStyle": "ImageAndText",
          "image": "TowDiagram icon",
          "isFirstInGroup": true,
          "handler": "MainToolbarManager_ToolClick"
        },
        {
          "key": "Flip Tow",
          "type": "ButtonTool",
          "caption": "&Flip Tow",
          "displayStyle": "ImageAndText",
          "image": "FlipHorizontal icon",
          "handler": "MainToolbarManager_ToolClick"
        },
        {
          "key": "Drop Tow",
          "type": "StateButtonTool",
          "caption": "&Drop Tow",
          "displayStyle": "ImageAndText",
          "image": "DownArrow icon",
          "handler": "MainToolbarManager_ToolClick"
        },
        {
          "key": "Set Color",
          "type": "PopupMenuTool",
          "caption": "Set Co&lor",
          "displayStyle": "ImageAndText",
          "image": "ColorPalette icon",
          "dynamicMenu": true,
          "populationMethod": "DynamicallyAddToolbarButtons",
          "handler": "MainToolbarManager_ToolClick",
          "security": "Modify"
        },
        {
          "key": "Set Note",
          "type": "ButtonTool",
          "caption": "Set &Note",
          "displayStyle": "ImageAndText",
          "image": "Modify icon",
          "handler": "MainToolbarManager_ToolClick",
          "security": "Modify"
        }
      ]
    },
    {
      "name": "TierGroupToolbarManager",
      "type": "UltraToolbarsManager",
      "toolbarName": "TierGroupToolbar",
      "description": "Toolbar for tier group and berth operations",
      "tools": [
        {
          "key": "Tier Group Combo",
          "type": "ComboBoxTool",
          "caption": "Tier Group:",
          "width": 234,
          "visible": false,
          "populationMethod": "LoadTierGroupList",
          "handler": "TierGroupToolbarManager_ToolValueChanged"
        },
        {
          "key": "Berth Combo",
          "type": "ComboBoxTool",
          "caption": "Berth:",
          "width": 234,
          "visible": false,
          "populationMethod": "LoadBerthList",
          "handler": "TierGroupToolbarManager_ToolValueChanged"
        },
        {
          "key": "Arrive/Depart Ship",
          "type": "ButtonTool",
          "caption": "Arrive Ship",
          "displayStyle": "ImageAndText",
          "visible": false,
          "handler": "TierGroupToolbarManager_ToolClick"
        },
        {
          "key": "Flip Barge",
          "type": "ButtonTool",
          "caption": "Flip &Barge",
          "displayStyle": "ImageAndText",
          "image": "FlipHorizontal icon",
          "isFirstInGroup": true,
          "handler": "TierGroupToolbarManager_ToolClick"
        },
        {
          "key": "Send Tow Diagram",
          "type": "ButtonTool",
          "caption": "Send &Tow Diagram",
          "displayStyle": "ImageAndText",
          "image": "SendTowDiagram icon",
          "handler": "TierGroupToolbarManager_ToolClick"
        },
        {
          "key": "Set Anchor Wire",
          "type": "ButtonTool",
          "caption": "&Set Anchor Wire",
          "displayStyle": "ImageAndText",
          "image": "Anchor icon",
          "handler": "TierGroupToolbarManager_ToolClick"
        },
        {
          "key": "View Conflicts",
          "type": "ButtonTool",
          "caption": "&View Conflicts",
          "displayStyle": "ImageAndText",
          "image": "Warning icon",
          "foreColor": "Red",
          "fontBold": true,
          "handler": "TierGroupToolbarManager_ToolClick"
        },
        {
          "key": "Set Color",
          "type": "PopupMenuTool",
          "caption": "Set Co&lor",
          "displayStyle": "ImageAndText",
          "image": "ColorPalette icon",
          "dynamicMenu": true,
          "populationMethod": "DynamicallyAddToolbarButtons",
          "handler": "TierGroupToolbarManager_ToolClick",
          "security": "Modify"
        },
        {
          "key": "Set Note",
          "type": "ButtonTool",
          "caption": "Set &Note",
          "displayStyle": "ImageAndText",
          "image": "Modify icon",
          "handler": "TierGroupToolbarManager_ToolClick",
          "security": "Modify"
        }
      ]
    }
  ],
  "buttons": [
    {
      "name": "btnRefresh",
      "text": "&Refresh",
      "type": "Action",
      "category": "EventModeActions",
      "location": "grpSubmitCancel",
      "handler": "btnRefresh_Click",
      "enabled": true,
      "visible": "EventModeOnly",
      "modernEquivalent": "Bootstrap button with refresh icon"
    },
    {
      "name": "btnSet",
      "text": "&Set",
      "type": "CancelEdit",
      "category": "EventModeActions",
      "location": "grpSubmitCancel",
      "handler": "btnSet_Click",
      "enabled": true,
      "visible": "EventModeOnly",
      "modernEquivalent": "Bootstrap primary button"
    },
    {
      "name": "btnClose",
      "text": "&Close",
      "type": "CancelEdit",
      "category": "EventModeActions",
      "location": "grpSubmitCancel",
      "handler": "btnClose_Click",
      "enabled": true,
      "visible": "EventModeOnly",
      "modernEquivalent": "Bootstrap secondary button"
    }
  ],
  "panels": [
    {
      "name": "pnlMain",
      "type": "UltraPanel",
      "dock": "Fill",
      "description": "Main container panel for all grids and controls",
      "controls": [
        "ctlWorkspace",
        "splGridSplitter",
        "pnlTierGroup",
        "ctlTierGroup",
        "grpSubmitCancel"
      ]
    },
    {
      "name": "pnlTierGroup",
      "type": "UltraPanel",
      "dock": "Top",
      "description": "Container for tier group toolbar",
      "contains": "TierGroupToolbarManager dock areas"
    },
    {
      "name": "grpSubmitCancel",
      "type": "UltraGroupBox",
      "dock": "Bottom",
      "description": "Action buttons group (visible only in Event Mode)",
      "visible": "EventModeOnly",
      "controls": [
        "btnRefresh",
        "btnSet",
        "btnClose"
      ]
    }
  ],
  "splitters": [
    {
      "name": "splGridSplitter",
      "type": "UltraSplitter",
      "dock": "Top",
      "description": "Resizable splitter between workspace and tier group grids",
      "restoreExtent": 6,
      "modernEquivalent": "CSS flexbox or grid with draggable divider"
    }
  ],
  "statusBar": {
    "name": "staStatus",
    "type": "UltraStatusBar",
    "dock": "Bottom",
    "sizeGripVisible": true,
    "description": "Status bar showing current selection and operation status",
    "modernEquivalent": "Bootstrap fixed-bottom status bar"
  },
  "timers": [
    {
      "name": "tmrBargePositions",
      "interval": 30000,
      "description": "Auto-refresh timer for barge positions (interval from GlobalSettings)",
      "handler": "tmrBargePositions_Tick"
    },
    {
      "name": "tmrBargeConflicts",
      "interval": 60000,
      "description": "Timer to check for barge location conflicts (30 min production, 30 sec debug)",
      "handler": "tmrBargeConflicts_Tick"
    }
  ],
  "backgroundWorkers": [
    {
      "name": "bckRetrieveBarges",
      "description": "Background worker for async barge data retrieval (tier group)",
      "doWorkHandler": "bckRetrieveBarges_DoWork",
      "completedHandler": "bckRetrieveBarges_RunWorkerCompleted"
    },
    {
      "name": "bckRetrieveWorkspace",
      "description": "Background worker for async workspace data retrieval",
      "doWorkHandler": "bckRetrieveBarges_DoWork",
      "completedHandler": "bckRetrieveBarges_RunWorkerCompleted"
    }
  ],
  "eventHandlers": {
    "frmBargePositions_Load": "Initialize form, restore settings, build toolbars, start timers",
    "frmBargePositions_Activated": "Refresh data when form is reopened (not just focused)",
    "frmBargePositions_Disposed": "Clear notifiers, save form settings",
    "frmBargePositions_KeyPress": "Handle ESC key to exit Drop Tow mode",
    "_FleetChangeNotifier_FleetChanged": "Handle fleet switch, warn if unsaved changes, reload data",
    "_Notifier_BerthsChanged": "Reload berth list and refresh berth grid",
    "_Notifier_TierGroupsChanged": "Reload tier group list and refresh tier group grid",
    "ctlWorkspace_BeforeControlDropped": "Validate workspace drop operation before allowing",
    "ctlWorkspace_ControlDropped": "Process workspace barge drop, save position",
    "ctlWorkspace_SelectionChanged": "Update status text when selection changes",
    "ctlWorkspace_Click": "Update status text on click",
    "ctlTierGroup_BeforeControlDropped": "Validate tier group drop operation before allowing",
    "ctlTierGroup_ControlDropped": "Process tier group barge drop, save position",
    "ctlTierGroup_GridCellClicked": "Handle tier group grid cell clicks",
    "ctlTierGroup_SelectionChanged": "Update status text when tier selection changes",
    "tmrBargePositions_Tick": "Auto-refresh barge positions if not in event mode",
    "tmrBargeConflicts_Tick": "Check for barge location conflicts",
    "bckRetrieveBarges_DoWork": "Retrieve barge position data in background",
    "bckRetrieveBarges_RunWorkerCompleted": "Load grid with retrieved barge data",
    "btnRefresh_Click": "Refresh all grids from toolbar (event mode)",
    "btnSet_Click": "Save deferred barge movements and close form (event mode)",
    "btnClose_Click": "Close form without saving deferred movements (event mode)",
    "MainToolbarManager_ToolValueChanged": "Handle mode/facility/boat combo changes, refresh grids",
    "MainToolbarManager_ToolClick": "Handle main toolbar button clicks (refresh, history, flip, etc.)",
    "TierGroupToolbarManager_ToolValueChanged": "Handle tier group/berth combo changes, refresh grid",
    "TierGroupToolbarManager_ToolClick": "Handle tier toolbar buttons (flip, send diagram, anchor, etc.)"
  },
  "businessLogic": {
    "entityClass": "Fleet",
    "bargePositionsClass": "BargePositions",
    "tierGroupClass": "TierGroup",
    "eventTypeEnum": "BargePositions.EventType",
    "saveMethod": "RecordBargeMove",
    "refreshMethods": [
      "RefreshWorkspaceGrid",
      "RefreshTierGroupGrid",
      "RefreshBerthGrid",
      "RefreshTowDiagramGrid"
    ],
    "dataRetrievalMethod": "RetrieveBargePositions"
  },
  "validation": {
    "dropValidation": [
      "ctlWorkspaceBeforeControlDrop: Validates workspace drop rules",
      "IsEnoughSpaceForDropTow: Validates tow diagram drop space requirements"
    ],
    "bargeConflictCheck": "CheckForBargeConflicts: Checks for barges in conflicting locations"
  },
  "modes": {
    "eventMode": {
      "description": "Modal form called from Barge Event or Barge Detail. Defers save until user clicks Set.",
      "flag": "_InEventMode",
      "visibleControls": ["grpSubmitCancel"],
      "hiddenControls": ["MainToolbar (UltraToolbar1)"],
      "deferredSave": true
    },
    "workspaceMode": {
      "description": "Non-modal form from main menu. Auto-saves barge movements immediately.",
      "flag": "!_InEventMode",
      "autoRefresh": true,
      "deferredSave": false
    },
    "dropTowMode": {
      "description": "Special mode for dropping entire tow configuration onto grid",
      "flag": "IsDropTow",
      "escapeToCancel": true
    }
  },
  "dataStructures": {
    "_BargePositions": "Collection of BargePosition objects for moved barges",
    "_MovedBargeTokens": "ArrayList of token objects corresponding to moved barges",
    "_DeferredSaveBarges": "ArrayList of barges not saved until form closes (event mode)",
    "_NoDropBarges": "ArrayList of BargeIDs that cannot be moved",
    "_TierGroup": "Current tier group object",
    "_Fleet": "Current fleet object"
  },
  "notifiers": [
    {
      "name": "_FleetChangeNotifier",
      "type": "Main.FleetChangeNotifier",
      "description": "Notifies when user switches fleet/terminal"
    },
    {
      "name": "_Notifier",
      "type": "EventNotifier",
      "description": "Notifies of berth and tier group changes"
    }
  ],
  "constants": {
    "positionTypes": ["berth", "tier", "workspace", "rake", "anchor"],
    "gridTypes": ["berth", "tier", "workspace", "towdiagram"],
    "hullTypes": ["R (Rake)", "B (Box)"],
    "rakeDirections": ["Up", "Down", "Left", "Right"],
    "defaultColors": {
      "foreColor": "Black",
      "backColor": "White"
    }
  },
  "securityIntegration": {
    "interface": "ControlAuthorizationBase",
    "buttonTypes": {
      "btnRefresh": "Action",
      "btnSet": "CancelEdit",
      "btnClose": "CancelEdit",
      "Define Color Legend": "Modify",
      "Set Color": "Modify",
      "Set Note": "Modify"
    },
    "method": "ToolbarButtonCanBeEnabled"
  },
  "modernizationNotes": {
    "complexity": "VERY HIGH - Complex drag-drop interface with multiple grid types and real-time updates",
    "customControls": "CsgContainerGrid controls need complete reimplementation as HTML5 Canvas/SVG or modern grid library",
    "recommendedApproach": "React/Vue with HTML5 Canvas or SVG for drag-drop grids, SignalR for real-time updates",
    "keyFeatures": [
      "Drag-and-drop barge positioning across multiple grid types",
      "Visual tow diagram builder",
      "Real-time conflict detection",
      "Dynamic color-coding system",
      "Multi-mode operation (Fleet/Facility/Midstream/Tow)",
      "Deferred save vs immediate save modes",
      "Background data loading for performance",
      "Auto-refresh with configurable intervals",
      "Complex validation rules for barge movements"
    ],
    "technicalChallenges": [
      "Custom grid control (CsgContainerGrid) has no direct HTML equivalent",
      "Complex drag-drop logic with inter-grid moves",
      "Token-based barge representation system",
      "Real-time position synchronization",
      "Dynamic toolbar generation based on fleet configuration",
      "Rake direction management for specialized barges",
      "Tow diagram visual builder",
      "Berth/Tier/Workspace coordinate mapping"
    ],
    "suggestedModernStack": {
      "frontend": "React with Konva.js (Canvas) or D3.js (SVG) for drag-drop grids",
      "stateManagement": "Redux for complex state management",
      "realtime": "SignalR for position updates and conflict notifications",
      "backend": "ASP.NET Core Web API with dedicated endpoints for each grid type",
      "validation": "FluentValidation for drop rules and business logic"
    }
  }
}
