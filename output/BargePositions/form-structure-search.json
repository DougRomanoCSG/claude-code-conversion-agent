{
  "formName": "frmBargePositions",
  "formTitle": "BargeOps Onshore - Fleet",
  "inherits": "frmBaseDetailEdit",
  "implements": ["IBaseDetailEdit"],
  "description": "Complex barge fleet positioning interface with drag-and-drop capability, supporting multiple modes (In Fleet, At Facility/Ship, Midstream operations, Tow Diagram). Manages barge positions across workspace and tier group grids with real-time updates.",

  "controls": [
    {
      "name": "staStatus",
      "type": "UltraStatusBar",
      "category": "StatusDisplay",
      "label": null,
      "dataBinding": null,
      "validation": [],
      "events": [],
      "properties": {
        "location": "Bottom dock",
        "sizeGripVisible": true
      }
    }
  ],

  "customControls": [
    {
      "name": "ctlWorkspace",
      "type": "CsgContainerGrid",
      "category": "PrimaryInterface",
      "label": "Workspace Grid",
      "description": "Main drag-and-drop grid for barge positioning, supports tow diagrams and fleet visualization",
      "dataBinding": null,
      "validation": [],
      "events": [
        "BeforeControlDropped",
        "ControlDropped",
        "Click",
        "SelectionChanged"
      ],
      "properties": {
        "allowDrop": true,
        "autoScroll": true,
        "cellSize": "90x24",
        "dimensions": "3x3",
        "dock": "Top",
        "dragMode": "Move",
        "multiSelectMode": "Single",
        "showHeaders": false,
        "gridLineColor": "ControlDark",
        "origin": "Default"
      },
      "modernEquivalent": "Canvas-based drag-and-drop interface with DataTables for list view alternative"
    },
    {
      "name": "ctlTierGroup",
      "type": "CsgContainerGrid",
      "category": "SecondaryInterface",
      "label": "Tier Group Grid",
      "description": "Secondary grid for tier-based barge positioning (berths, tiers, anchor positions)",
      "dataBinding": null,
      "validation": [],
      "events": [
        "BeforeControlDropped",
        "ControlDropped",
        "GridCellClicked",
        "SelectionChanged"
      ],
      "properties": {
        "allowDrop": true,
        "autoScroll": true,
        "cellSize": "90x24",
        "dimensions": "4x4",
        "dock": "Fill",
        "dragMode": "Move",
        "multiSelectMode": "Single",
        "origin": "Bottom",
        "gridLineColor": "ControlDark"
      },
      "modernEquivalent": "Canvas-based drag-and-drop interface with berth/tier visualization"
    }
  ],

  "toolbars": [
    {
      "name": "MainToolbarManager",
      "type": "UltraToolbarsManager",
      "category": "MainNavigation",
      "toolbarName": "UltraToolbar1",
      "description": "Primary toolbar for mode selection, filtering, and workspace operations",
      "tools": [
        {
          "key": "Mode Combo",
          "type": "ComboBoxTool",
          "caption": "Mode:",
          "width": 196,
          "required": true,
          "options": [
            "In Fleet",
            "At Facility/Ship",
            "Midstream-In Update",
            "Midstream-Out Update",
            "Tow Diagram"
          ],
          "defaultValue": "In Fleet",
          "handler": "MainToolbarManager_ToolValueChanged",
          "modernEquivalent": "select.form-select with Select2"
        },
        {
          "key": "Boat Combo",
          "type": "ComboBoxTool",
          "caption": "Boat:",
          "width": 160,
          "visible": false,
          "dynamic": true,
          "populationMethod": "LoadBoatList",
          "handler": "MainToolbarManager_ToolValueChanged",
          "modernEquivalent": "select.form-select with Select2"
        },
        {
          "key": "Facility Combo",
          "type": "ComboBoxTool",
          "caption": "Facility:",
          "width": 160,
          "visible": false,
          "dynamic": true,
          "populationMethod": "LoadFacilityList",
          "handler": "MainToolbarManager_ToolValueChanged",
          "modernEquivalent": "select.form-select with Select2"
        },
        {
          "key": "Refresh",
          "type": "ButtonTool",
          "caption": "Re&fresh",
          "displayStyle": "ImageAndText",
          "image": "Refresh",
          "isFirstInGroup": true,
          "handler": "MainToolbarManager_ToolClick",
          "modernEquivalent": "button.btn.btn-secondary"
        },
        {
          "key": "History",
          "type": "ButtonTool",
          "caption": "&History",
          "displayStyle": "ImageAndText",
          "image": "History",
          "handler": "MainToolbarManager_ToolClick",
          "modernEquivalent": "button.btn.btn-secondary"
        },
        {
          "key": "Define Color Legend",
          "type": "ButtonTool",
          "caption": "D&efine Color Legend",
          "displayStyle": "ImageAndText",
          "image": "ColorList",
          "isFirstInGroup": true,
          "handler": "MainToolbarManager_ToolClick",
          "security": "Modify",
          "modernEquivalent": "button.btn.btn-secondary"
        },
        {
          "key": "Close",
          "type": "ButtonTool",
          "caption": "&Close",
          "displayStyle": "ImageAndText",
          "image": "Close",
          "isFirstInGroup": true,
          "handler": "MainToolbarManager_ToolClick",
          "modernEquivalent": "button.btn.btn-secondary"
        }
      ]
    },
    {
      "name": "MainToolbarManager",
      "type": "UltraToolbarsManager",
      "category": "WorkspaceOperations",
      "toolbarName": "UltraToolbar2",
      "description": "Secondary toolbar for workspace-specific operations (servicing, tow operations)",
      "tools": [
        {
          "key": "Servicing Boat Combo",
          "type": "ComboBoxTool",
          "caption": "Servicing Boat:",
          "displayStyle": "ImageAndText",
          "dynamic": true,
          "populationMethod": "LoadServicingBoatList",
          "handler": "MainToolbarManager_ToolValueChanged",
          "modernEquivalent": "select.form-select with Select2"
        },
        {
          "key": "Flip Barge",
          "type": "ButtonTool",
          "caption": "Flip &Barge",
          "displayStyle": "ImageAndText",
          "image": "FlipHorizontal",
          "isFirstInGroup": true,
          "handler": "MainToolbarManager_ToolClick",
          "modernEquivalent": "button.btn.btn-secondary"
        },
        {
          "key": "Show Tow Diagram",
          "type": "StateButtonTool",
          "caption": "Show T&ow Diagram",
          "displayStyle": "ImageAndText",
          "image": "TowDiagram",
          "isFirstInGroup": true,
          "toggleable": true,
          "handler": "MainToolbarManager_ToolClick",
          "modernEquivalent": "button.btn.btn-toggle or checkbox styled as button"
        },
        {
          "key": "Flip Tow",
          "type": "ButtonTool",
          "caption": "&Flip Tow",
          "displayStyle": "ImageAndText",
          "image": "FlipHorizontal",
          "handler": "MainToolbarManager_ToolClick",
          "modernEquivalent": "button.btn.btn-secondary"
        },
        {
          "key": "Drop Tow",
          "type": "StateButtonTool",
          "caption": "&Drop Tow",
          "displayStyle": "ImageAndText",
          "image": "DownArrow",
          "toggleable": true,
          "handler": "MainToolbarManager_ToolClick",
          "modernEquivalent": "button.btn.btn-toggle"
        },
        {
          "key": "Set Color",
          "type": "PopupMenuTool",
          "caption": "Set Co&lor",
          "displayStyle": "ImageAndText",
          "image": "ColorPalette",
          "dynamic": true,
          "dynamicMethod": "DynamicallyAddToolbarButtons",
          "handler": "MainToolbarManager_ToolClick",
          "security": "Modify",
          "modernEquivalent": "dropdown button with color picker"
        },
        {
          "key": "Set Note",
          "type": "ButtonTool",
          "caption": "Set &Note",
          "displayStyle": "ImageAndText",
          "image": "Modify",
          "handler": "MainToolbarManager_ToolClick",
          "security": "Modify",
          "modernEquivalent": "button.btn.btn-secondary with modal"
        }
      ]
    },
    {
      "name": "TierGroupToolbarManager",
      "type": "UltraToolbarsManager",
      "category": "TierOperations",
      "toolbarName": "TierGroupToolbar",
      "description": "Toolbar for tier group and berth operations",
      "tools": [
        {
          "key": "Tier Group Combo",
          "type": "ComboBoxTool",
          "caption": "Tier Group:",
          "width": 234,
          "displayStyle": "ImageAndText",
          "visible": false,
          "dynamic": true,
          "sortStyle": "Ascending",
          "populationMethod": "LoadTierGroupList",
          "handler": "TierGroupToolbarManager_ToolValueChanged",
          "modernEquivalent": "select.form-select with Select2"
        },
        {
          "key": "Berth Combo",
          "type": "ComboBoxTool",
          "caption": "Berth:",
          "width": 234,
          "displayStyle": "ImageAndText",
          "visible": false,
          "dynamic": true,
          "sortStyle": "Ascending",
          "populationMethod": "LoadBerthList",
          "handler": "TierGroupToolbarManager_ToolValueChanged",
          "modernEquivalent": "select.form-select with Select2"
        },
        {
          "key": "Arrive/Depart Ship",
          "type": "ButtonTool",
          "caption": "Arrive Ship",
          "displayStyle": "ImageAndText",
          "visible": false,
          "handler": "TierGroupToolbarManager_ToolClick",
          "note": "Caption changes dynamically to 'Arrive Ship' or 'Depart Ship'",
          "modernEquivalent": "button.btn.btn-primary"
        },
        {
          "key": "Flip Barge",
          "type": "ButtonTool",
          "caption": "Flip &Barge",
          "displayStyle": "ImageAndText",
          "image": "FlipHorizontal",
          "isFirstInGroup": true,
          "handler": "TierGroupToolbarManager_ToolClick",
          "modernEquivalent": "button.btn.btn-secondary"
        },
        {
          "key": "Send Tow Diagram",
          "type": "ButtonTool",
          "caption": "Send &Tow Diagram",
          "displayStyle": "ImageAndText",
          "image": "SendTowDiagram",
          "handler": "TierGroupToolbarManager_ToolClick",
          "modernEquivalent": "button.btn.btn-secondary"
        },
        {
          "key": "Set Anchor Wire",
          "type": "ButtonTool",
          "caption": "&Set Anchor Wire",
          "displayStyle": "ImageAndText",
          "image": "Anchor",
          "handler": "TierGroupToolbarManager_ToolClick",
          "note": "Caption toggles between 'Set Anchor Wire' and 'Clear Anchor Wire'",
          "modernEquivalent": "button.btn.btn-secondary"
        },
        {
          "key": "View Conflicts",
          "type": "ButtonTool",
          "caption": "&View Conflicts",
          "displayStyle": "ImageAndText",
          "image": "Warning",
          "appearanceOnToolbar": {
            "fontBold": true,
            "foreColor": "Red"
          },
          "handler": "TierGroupToolbarManager_ToolClick",
          "modernEquivalent": "button.btn.btn-warning or btn-danger"
        },
        {
          "key": "Set Color",
          "type": "PopupMenuTool",
          "caption": "Set Co&lor",
          "displayStyle": "ImageAndText",
          "image": "ColorPalette",
          "dynamic": true,
          "dynamicMethod": "DynamicallyAddToolbarButtons",
          "handler": "TierGroupToolbarManager_ToolClick",
          "security": "Modify",
          "modernEquivalent": "dropdown button with color picker"
        },
        {
          "key": "Set Note",
          "type": "ButtonTool",
          "caption": "Set &Note",
          "displayStyle": "ImageAndText",
          "image": "Modify",
          "handler": "TierGroupToolbarManager_ToolClick",
          "security": "Modify",
          "modernEquivalent": "button.btn.btn-secondary"
        }
      ]
    }
  ],

  "panels": [
    {
      "name": "pnlMain",
      "type": "UltraPanel",
      "dock": "Fill",
      "description": "Main container panel",
      "controls": [
        "ctlWorkspace",
        "splGridSplitter",
        "pnlTierGroup",
        "ctlTierGroup",
        "grpSubmitCancel"
      ]
    },
    {
      "name": "pnlTierGroup",
      "type": "UltraPanel",
      "dock": "Top",
      "description": "Container for tier group toolbar",
      "controls": [
        "TierGroupToolbarManager dock areas"
      ]
    },
    {
      "name": "grpSubmitCancel",
      "type": "UltraGroupBox",
      "dock": "Bottom",
      "borderStyle": "Header3D",
      "description": "Action button group (only visible in Event Mode)",
      "visibility": "Hidden in normal mode, shown in Event Mode",
      "controls": [
        "btnRefresh",
        "btnSet",
        "btnClose"
      ]
    }
  ],

  "buttons": [
    {
      "name": "btnRefresh",
      "text": "&Refresh",
      "type": "Action",
      "enabled": true,
      "visible": true,
      "anchor": "Top, Right",
      "handler": "btnRefresh_Click",
      "location": "grpSubmitCancel",
      "modernEquivalent": "button.btn.btn-secondary"
    },
    {
      "name": "btnSet",
      "text": "&Set",
      "type": "CancelEdit",
      "enabled": true,
      "visible": true,
      "anchor": "Top, Right",
      "handler": "btnSet_Click",
      "location": "grpSubmitCancel",
      "description": "Commits barge position changes in Event Mode",
      "modernEquivalent": "button.btn.btn-primary"
    },
    {
      "name": "btnClose",
      "text": "&Close",
      "type": "CancelEdit",
      "enabled": true,
      "visible": true,
      "anchor": "Top, Right",
      "causesValidation": false,
      "handler": "btnClose_Click",
      "location": "grpSubmitCancel",
      "modernEquivalent": "button.btn.btn-secondary"
    }
  ],

  "splitters": [
    {
      "name": "splGridSplitter",
      "type": "UltraSplitter",
      "dock": "Top",
      "description": "Resizable splitter between workspace and tier group grids",
      "restoreExtent": 6,
      "modernEquivalent": "CSS Grid or Flexbox with resize handle"
    }
  ],

  "timers": [
    {
      "name": "tmrBargePositions",
      "interval": "30000ms (configurable via GlobalSettingList.BargePositionsIntervalMinutes)",
      "description": "Auto-refresh timer for barge positions (disabled in Event Mode)",
      "handler": "tmrBargePositions_Tick"
    },
    {
      "name": "tmrBargeConflicts",
      "interval": "1800000ms (30 minutes, 30s in DEBUG)",
      "description": "Timer for checking barge position conflicts",
      "handler": "tmrBargeConflicts_Tick"
    }
  ],

  "backgroundWorkers": [
    {
      "name": "bckRetrieveBarges",
      "description": "Background worker for retrieving barge data asynchronously",
      "doWorkHandler": "bckRetrieveBarges_DoWork",
      "completedHandler": "bckRetrieveBarges_RunWorkerCompleted"
    },
    {
      "name": "bckRetrieveWorkspace",
      "description": "Background worker for retrieving workspace data asynchronously",
      "doWorkHandler": "bckRetrieveBarges_DoWork",
      "completedHandler": "bckRetrieveBarges_RunWorkerCompleted"
    }
  ],

  "eventHandlers": {
    "frmBargePositions_Load": "Initialize form, restore settings, build dynamic toolbars, start timers",
    "frmBargePositions_Activated": "Refresh data when form is reopened (not just refocused)",
    "frmBargePositions_Disposed": "Clean up notifiers and save form settings",
    "frmBargePositions_KeyPress": "Handle Escape key to cancel Drop Tow mode",
    "WndProc": "Intercept close button to hide instead of close (unless in Event Mode)",
    "btnRefresh_Click": "Refresh all grids and data",
    "btnSet_Click": "Save barge position changes (Event Mode only)",
    "btnClose_Click": "Close or hide form based on mode",
    "ctlWorkspace_BeforeControlDropped": "Validate barge drop operation before allowing",
    "ctlWorkspace_ControlDropped": "Handle barge drop, save position changes",
    "ctlWorkspace_SelectionChanged": "Update status and UI based on selected barge",
    "ctlWorkspace_Click": "Update status text",
    "ctlTierGroup_BeforeControlDropped": "Validate tier group drop operation",
    "ctlTierGroup_ControlDropped": "Handle barge drop in tier group",
    "ctlTierGroup_GridCellClicked": "Handle tier grid cell interactions",
    "ctlTierGroup_SelectionChanged": "Update status and UI based on tier selection",
    "MainToolbarManager_ToolValueChanged": "Handle mode/filter combo changes, refresh grids",
    "MainToolbarManager_ToolClick": "Handle toolbar button clicks (Refresh, History, Flip, Set Color, etc.)",
    "TierGroupToolbarManager_ToolValueChanged": "Handle tier group/berth combo changes",
    "TierGroupToolbarManager_ToolClick": "Handle tier toolbar actions (Flip, Send Diagram, Set Anchor, View Conflicts)",
    "tmrBargePositions_Tick": "Auto-refresh grids at configured interval",
    "tmrBargeConflicts_Tick": "Check for and alert on barge position conflicts",
    "bckRetrieveBarges_DoWork": "Asynchronously retrieve barge data",
    "bckRetrieveBarges_RunWorkerCompleted": "Update UI with retrieved data",
    "_FleetChangeNotifier_FleetChanged": "Handle fleet change notifications, refresh data",
    "_Notifier_BerthsChanged": "Reload berth list when berths are modified",
    "_Notifier_TierGroupsChanged": "Reload tier group list when tier groups are modified"
  },

  "businessLogic": {
    "primaryClass": "BargePositions",
    "supportingClasses": [
      "Fleet",
      "TierGroup",
      "BargePosition",
      "BargePositionList",
      "Barge"
    ],
    "eventNotifiers": [
      "EventNotifier",
      "FleetChangeNotifier"
    ]
  },

  "modes": [
    {
      "name": "Workspace",
      "value": "In Fleet",
      "description": "Non-modal mode for general fleet positioning, auto-refresh enabled, changes saved immediately",
      "visibleControls": {
        "MainToolbarManager.UltraToolbar1": true,
        "MainToolbarManager.UltraToolbar2": true,
        "grpSubmitCancel": false,
        "ctlWorkspace": true,
        "ctlTierGroup": false
      }
    },
    {
      "name": "At Facility/Ship",
      "value": "At Facility/Ship",
      "description": "View barges at a specific facility or ship location",
      "visibleControls": {
        "FacilityCombo": true,
        "BoatCombo": true
      }
    },
    {
      "name": "Midstream-In Update",
      "value": "Midstream-In Update",
      "description": "Update barge positions for midstream-in operations",
      "visibleControls": {
        "BoatCombo": true,
        "TierGroupCombo": true
      }
    },
    {
      "name": "Midstream-Out Update",
      "value": "Midstream-Out Update",
      "description": "Update barge positions for midstream-out operations",
      "visibleControls": {
        "BoatCombo": true,
        "TierGroupCombo": true
      }
    },
    {
      "name": "Tow Diagram",
      "value": "Tow Diagram",
      "description": "Visual tow diagram mode for managing barge configurations",
      "visibleControls": {
        "ShowTowDiagram": true,
        "FlipTow": true,
        "DropTow": true
      }
    },
    {
      "name": "Event Mode",
      "description": "Modal mode called from Barge Events or Barge Detail forms, deferred save, auto-refresh disabled",
      "visibleControls": {
        "MainToolbarManager.UltraToolbar1": false,
        "grpSubmitCancel": true
      }
    }
  ],

  "validation": {
    "dropValidation": {
      "method": "ctlWorkspaceBeforeControlDrop",
      "rules": [
        {
          "rule": "No-drop barges cannot be moved in certain modes",
          "enforced": "BeforeControlDropped events"
        },
        {
          "rule": "Workspace/tier-specific drop rules based on mode",
          "enforced": "BeforeControlDropped events"
        },
        {
          "rule": "Conflict detection for overlapping positions",
          "enforced": "CheckForBargeConflicts method"
        }
      ]
    },
    "conflictDetection": {
      "method": "CheckForBargeConflicts",
      "interval": "Every 30 minutes via tmrBargeConflicts",
      "message": "There are barges with conflicting locations. Press the View Conflicts button for more information."
    }
  },

  "dataFlow": {
    "load": [
      "frmBargePositions_Load",
      "Initialize (IBaseDetailEdit)",
      "FormatControls",
      "LoadTierGroupList / LoadBerthList / LoadBoatList / LoadFacilityList (dynamic)",
      "RefreshWorkspaceGrid / RefreshTierGroupGrid / RefreshTowDiagramGrid",
      "CheckForBargeConflicts"
    ],
    "refresh": [
      "btnRefresh_Click or tmrBargePositions_Tick",
      "RefreshFromToolbar",
      "Background workers retrieve data",
      "Update grids with current positions"
    ],
    "save": [
      "ctlWorkspace_ControlDropped or ctlTierGroup_ControlDropped",
      "UpdateBargePosition (immediate save in Workspace mode)",
      "Add to _BargePositions collection (deferred save in Event Mode)",
      "btnSet_Click to commit deferred changes"
    ]
  },

  "security": {
    "implementation": "ControlAuthorizationBase",
    "buttonTypes": {
      "btnRefresh": "Action",
      "btnSet": "CancelEdit",
      "btnClose": "CancelEdit",
      "DefineColorLegend": "Modify",
      "SetColor": "Modify",
      "SetNote": "Modify"
    },
    "authorizationMethod": "SetButtonTypes (IBaseDetailEdit)",
    "toolbarAuthorization": "ToolbarButtonCanBeEnabled method checks _ToolbarButtonTypes hashtable"
  },

  "constants": {
    "positionTypes": [
      "berth",
      "tier",
      "workspace",
      "rake",
      "anchor"
    ],
    "gridTypes": [
      "berth",
      "tier",
      "workspace",
      "towdiagram"
    ],
    "hullTypes": [
      "R (Rake)",
      "B (Box)"
    ],
    "rakeDirections": [
      "Up",
      "Down",
      "Left",
      "Right"
    ],
    "setColorDefaults": {
      "foreColor": "Black",
      "backColor": "White"
    }
  },

  "modernizationNotes": {
    "architecture": "ASP.NET Core MVC with SignalR for real-time updates",
    "primaryView": "Single-page application with canvas-based drag-and-drop interface",
    "gridReplacement": "HTML5 Canvas or SVG for drag-and-drop visualization, DataTables for alternative list view",
    "realTimeUpdates": "SignalR hubs for fleet change notifications, barge position updates, conflict alerts",
    "responsiveDesign": "Bootstrap 5 grid layout with responsive toolbars",
    "stateManagement": "Client-side state for drag operations, server-side session for deferred saves in Event Mode",
    "apiEndpoints": [
      "GET /api/bargepositions/workspace?mode={mode}&fleetId={id}",
      "GET /api/bargepositions/tiergroup?tierGroupId={id}",
      "GET /api/bargepositions/berth?berthId={id}",
      "POST /api/bargepositions/move - Save barge position change",
      "POST /api/bargepositions/flip - Flip barge orientation",
      "GET /api/bargepositions/conflicts - Get conflict list",
      "POST /api/bargepositions/setcolor - Set barge color",
      "POST /api/bargepositions/setnote - Set barge note",
      "GET /api/bargepositions/towdiagram?servicingBoatId={id}",
      "POST /api/bargepositions/droptow - Drop tow operation"
    ],
    "criticalFeatures": [
      "Drag-and-drop barge positioning with visual feedback",
      "Real-time conflict detection and alerts",
      "Multiple operational modes with dynamic UI",
      "Deferred save capability for Event Mode",
      "Auto-refresh with configurable intervals (disabled in Event Mode)",
      "Dynamic color coding for barge status",
      "Tow diagram visualization",
      "Anchor wire management",
      "Ship arrive/depart operations"
    ],
    "complexityFactors": [
      "Dual-grid interface with synchronized state",
      "Mode-dependent UI visibility and behavior",
      "Drag-and-drop validation across multiple contexts",
      "Real-time notifications from multiple sources",
      "Background workers for async data retrieval",
      "Complex event handler chaining",
      "Dynamic toolbar population based on fleet/mode",
      "Deferred vs immediate save logic",
      "Form state persistence across hide/show cycles"
    ]
  }
}
