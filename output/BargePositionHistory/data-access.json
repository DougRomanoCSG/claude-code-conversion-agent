{
  "entity": "BargePositionHistory",
  "description": "Fleet Position History tracking - records historical positions of barges in fleets and tiers",
  "softDelete": false,
  "hasIsActive": false,
  "deleteType": "hard",
  "storedProcedures": [
    {
      "name": "FleetPositionHistorySearch",
      "operation": "Search",
      "description": "Search fleet position history with filtering by fleet, date, tier group, and barge number",
      "parameters": [
        {
          "name": "@FleetID",
          "type": "int",
          "required": false,
          "description": "Filter by fleet ID"
        },
        {
          "name": "@PositionStartDate",
          "type": "datetime",
          "required": false,
          "description": "Filter by position start date (includes entire day)"
        },
        {
          "name": "@TierGroupID",
          "type": "int",
          "required": false,
          "description": "Filter by tier group"
        },
        {
          "name": "@BargeNum",
          "type": "varchar(50)",
          "required": false,
          "description": "Filter by barge number (LIKE pattern)"
        },
        {
          "name": "@IncludeBlankTierPos",
          "type": "bit",
          "required": true,
          "description": "Include records without tier positions"
        }
      ],
      "resultColumns": [
        {
          "column": "FleetPositionHistoryID",
          "property": "FleetPositionHistoryID",
          "type": "int",
          "isPrimaryKey": true
        },
        {
          "column": "FleetID",
          "property": "FleetID",
          "type": "int"
        },
        {
          "column": "BargeID",
          "property": "BargeID",
          "type": "int"
        },
        {
          "column": "TierID",
          "property": "TierID",
          "type": "int",
          "nullable": true
        },
        {
          "column": "TierX",
          "property": "TierX",
          "type": "smallint",
          "nullable": true
        },
        {
          "column": "TierY",
          "property": "TierY",
          "type": "smallint",
          "nullable": true
        },
        {
          "column": "PositionStartDateTime",
          "property": "PositionStartDateTime",
          "type": "datetime"
        },
        {
          "column": "LeftFleet",
          "property": "LeftFleet",
          "type": "bit"
        },
        {
          "column": "CreateDateTime",
          "property": "CreateDateTime",
          "type": "datetime"
        },
        {
          "column": "ModifyDateTime",
          "property": "ModifyDateTime",
          "type": "datetime",
          "nullable": true
        },
        {
          "column": "CreateUser",
          "property": "CreateUser",
          "type": "varchar(50)"
        },
        {
          "column": "ModifyUser",
          "property": "ModifyUser",
          "type": "varchar(50)"
        },
        {
          "column": "BargeNum",
          "property": "BargeNum",
          "type": "varchar(50)",
          "description": "From Barge table join"
        },
        {
          "column": "TierName",
          "property": "TierName",
          "type": "varchar",
          "description": "From Tier table join"
        },
        {
          "column": "TierPos",
          "property": "TierPos",
          "type": "varchar",
          "description": "Computed as '(TierX,TierY)'"
        }
      ],
      "joins": [
        "INNER JOIN Barge ON Barge.BargeID = FleetPositionHistory.BargeID",
        "LEFT JOIN Tier ON Tier.TierID = FleetPositionHistory.TierID"
      ]
    },
    {
      "name": "FleetPositionHistorySelect",
      "operation": "GetById",
      "description": "Fetch single fleet position history record by ID",
      "parameters": [
        {
          "name": "@FleetPositionHistoryID",
          "type": "int",
          "required": true
        }
      ],
      "resultColumns": [
        {
          "column": "FleetPositionHistoryID",
          "property": "FleetPositionHistoryID",
          "type": "int",
          "isPrimaryKey": true
        },
        {
          "column": "FleetID",
          "property": "FleetID",
          "type": "int"
        },
        {
          "column": "BargeID",
          "property": "BargeID",
          "type": "int"
        },
        {
          "column": "TierID",
          "property": "TierID",
          "type": "int",
          "nullable": true
        },
        {
          "column": "TierX",
          "property": "TierX",
          "type": "smallint",
          "nullable": true
        },
        {
          "column": "TierY",
          "property": "TierY",
          "type": "smallint",
          "nullable": true
        },
        {
          "column": "PositionStartDateTime",
          "property": "PositionStartDateTime",
          "type": "datetime"
        },
        {
          "column": "LeftFleet",
          "property": "LeftFleet",
          "type": "bit"
        },
        {
          "column": "ModifyDateTime",
          "property": "ModifyDateTime",
          "type": "datetime",
          "nullable": true
        },
        {
          "column": "BargeNum",
          "property": "BargeNum",
          "type": "varchar(50)",
          "description": "From Barge table join"
        }
      ],
      "joins": [
        "INNER JOIN Barge ON Barge.BargeID = FleetPositionHistory.BargeID"
      ]
    },
    {
      "name": "FleetPositionHistoryInsert",
      "operation": "Insert",
      "description": "Create new fleet position history record with validation",
      "parameters": [
        {
          "name": "@FleetID",
          "type": "int",
          "required": true
        },
        {
          "name": "@BargeID",
          "type": "int",
          "required": true
        },
        {
          "name": "@TierID",
          "type": "int",
          "required": false,
          "nullable": true
        },
        {
          "name": "@TierX",
          "type": "smallint",
          "required": false,
          "nullable": true
        },
        {
          "name": "@TierY",
          "type": "smallint",
          "required": false,
          "nullable": true
        },
        {
          "name": "@PositionStartDateTime",
          "type": "datetime",
          "required": true
        },
        {
          "name": "@LeftFleet",
          "type": "bit",
          "required": true
        },
        {
          "name": "@ModifyDateTime",
          "type": "datetime",
          "direction": "output"
        },
        {
          "name": "@ModifyUser",
          "type": "varchar(50)",
          "required": true
        },
        {
          "name": "@FleetPositionHistoryID",
          "type": "int",
          "direction": "output"
        }
      ],
      "businessLogic": [
        "Calls FleetPositionHistoryCheck stored proc to validate TierX and TierY when TierID is provided",
        "Sets ModifyDateTime to dbo.GetTenantDate()",
        "Sets CreateDateTime = ModifyDateTime",
        "Sets CreateUser = ModifyUser",
        "Returns new FleetPositionHistoryID via SCOPE_IDENTITY()"
      ]
    },
    {
      "name": "FleetPositionHistoryUpdate",
      "operation": "Update",
      "description": "Update existing fleet position history record with validation and optimistic concurrency",
      "parameters": [
        {
          "name": "@FleetPositionHistoryID",
          "type": "int",
          "required": true
        },
        {
          "name": "@FleetID",
          "type": "int",
          "required": true
        },
        {
          "name": "@BargeID",
          "type": "int",
          "required": true
        },
        {
          "name": "@TierID",
          "type": "int",
          "required": false,
          "nullable": true
        },
        {
          "name": "@TierX",
          "type": "smallint",
          "required": false,
          "nullable": true
        },
        {
          "name": "@TierY",
          "type": "smallint",
          "required": false,
          "nullable": true
        },
        {
          "name": "@PositionStartDateTime",
          "type": "datetime",
          "required": true
        },
        {
          "name": "@LeftFleet",
          "type": "bit",
          "required": true
        },
        {
          "name": "@ModifyDateTime",
          "type": "datetime",
          "direction": "inputoutput",
          "description": "Used for optimistic concurrency check"
        },
        {
          "name": "@ModifyUser",
          "type": "varchar(50)",
          "required": true
        }
      ],
      "businessLogic": [
        "Calls FleetPositionHistoryCheck stored proc to validate TierX and TierY when TierID is provided",
        "Uses optimistic concurrency: WHERE ModifyDateTime = @ModifyDateTime OR ModifyDateTime IS NULL",
        "Calls HandleNoRowsAffected if update fails",
        "Returns updated ModifyDateTime"
      ]
    },
    {
      "name": "FleetPositionHistoryDelete",
      "operation": "Delete",
      "description": "Hard delete fleet position history record (no soft delete)",
      "parameters": [
        {
          "name": "@FleetPositionHistoryID",
          "type": "int",
          "required": true
        }
      ],
      "businessLogic": [
        "Performs hard delete - removes record permanently"
      ]
    },
    {
      "name": "FleetPositionHistoryCheck",
      "operation": "Validation",
      "description": "Validates TierX and TierY coordinates are within tier boundaries",
      "referenced": true
    }
  ],
  "sqlFiles": [
    {
      "fileName": "BargePositionHistory_Search.sql",
      "operation": "Search",
      "description": "Search fleet position history with filtering by fleet, date, tier group, and barge number",
      "source": "FleetPositionHistorySearch stored procedure",
      "modernization": [
        "Convert to parameterized SQL query",
        "Use ListQuery for filtering and pagination",
        "Return BargePositionHistoryDto collection"
      ]
    },
    {
      "fileName": "BargePositionHistory_GetById.sql",
      "operation": "GetById",
      "description": "Fetch single record by FleetPositionHistoryID",
      "source": "FleetPositionHistorySelect stored procedure",
      "modernization": [
        "Convert to parameterized SQL query",
        "Return single BargePositionHistoryDto"
      ]
    },
    {
      "fileName": "BargePositionHistory_Insert.sql",
      "operation": "Insert",
      "description": "Create new fleet position history record",
      "source": "FleetPositionHistoryInsert stored procedure",
      "modernization": [
        "Move validation logic to application layer or separate validation query",
        "Use OUTPUT clause for SCOPE_IDENTITY()",
        "Return newly created ID"
      ]
    },
    {
      "fileName": "BargePositionHistory_Update.sql",
      "operation": "Update",
      "description": "Update existing fleet position history record with optimistic concurrency",
      "source": "FleetPositionHistoryUpdate stored procedure",
      "modernization": [
        "Move validation logic to application layer",
        "Implement optimistic concurrency with ModifyDateTime check",
        "Throw exception if no rows affected"
      ]
    },
    {
      "fileName": "BargePositionHistory_Delete.sql",
      "operation": "Delete",
      "description": "Hard delete fleet position history record",
      "source": "FleetPositionHistoryDelete stored procedure",
      "modernization": [
        "Simple DELETE statement by ID",
        "No soft delete - this is historical data cleanup"
      ]
    },
    {
      "fileName": "BargePositionHistory_ValidateTierCoordinates.sql",
      "operation": "Validation",
      "description": "Validate TierX and TierY coordinates are within tier boundaries",
      "source": "FleetPositionHistoryCheck stored procedure",
      "modernization": [
        "Separate validation query called before Insert/Update",
        "Returns validation errors if coordinates invalid"
      ]
    }
  ],
  "repositoryInterface": {
    "name": "IBargePositionHistoryRepository",
    "namespace": "Admin.Infrastructure.Abstractions",
    "path": "src/BargeOps.API/src/Admin.Infrastructure/Abstractions/IBargePositionHistoryRepository.cs",
    "methods": [
      {
        "name": "SearchAsync",
        "returnType": "Task<IEnumerable<BargePositionHistoryDto>>",
        "parameters": [
          "int? fleetId",
          "DateTime? positionStartDate",
          "int? tierGroupId",
          "string bargeNum",
          "bool includeBlankTierPos"
        ],
        "description": "Search fleet position history with filtering"
      },
      {
        "name": "GetByIdAsync",
        "returnType": "Task<BargePositionHistoryDto>",
        "parameters": ["int id"],
        "description": "Get single fleet position history record by ID"
      },
      {
        "name": "InsertAsync",
        "returnType": "Task<int>",
        "parameters": ["BargePositionHistoryDto entity", "string modifyUser"],
        "description": "Create new fleet position history record, returns new ID"
      },
      {
        "name": "UpdateAsync",
        "returnType": "Task",
        "parameters": ["BargePositionHistoryDto entity", "string modifyUser"],
        "description": "Update existing fleet position history record with optimistic concurrency"
      },
      {
        "name": "DeleteAsync",
        "returnType": "Task",
        "parameters": ["int id"],
        "description": "Hard delete fleet position history record"
      },
      {
        "name": "ValidateTierCoordinatesAsync",
        "returnType": "Task<bool>",
        "parameters": ["int tierId", "short tierX", "short tierY"],
        "description": "Validate tier coordinates are within boundaries"
      }
    ]
  },
  "repositoryImplementation": {
    "name": "BargePositionHistoryRepository",
    "namespace": "Admin.Infrastructure.Repositories",
    "path": "src/BargeOps.API/src/Admin.Infrastructure/Repositories/BargePositionHistoryRepository.cs",
    "sqlResourcePath": "src/BargeOps.API/src/Admin.Infrastructure/DataAccess/Sql/",
    "pattern": "Dapper with embedded SQL resources loaded via SqlText.GetSqlText()",
    "notes": [
      "All SQL queries stored in .sql files as embedded resources",
      "Use optimistic concurrency with ModifyDateTime check on updates",
      "Validate tier coordinates before insert/update operations",
      "LeftFleet flag determines if tier position fields are populated"
    ]
  },
  "dtoDefinition": {
    "name": "BargePositionHistoryDto",
    "namespace": "BargeOps.Shared.Dto",
    "path": "src/BargeOps.Shared/BargeOps.Shared/Dto/BargePositionHistoryDto.cs",
    "properties": [
      {
        "name": "FleetPositionHistoryID",
        "type": "int",
        "isPrimaryKey": true
      },
      {
        "name": "FleetID",
        "type": "int",
        "required": true
      },
      {
        "name": "BargeID",
        "type": "int",
        "required": true
      },
      {
        "name": "BargeNum",
        "type": "string",
        "description": "Display field from Barge join"
      },
      {
        "name": "TierID",
        "type": "int?",
        "nullable": true
      },
      {
        "name": "TierName",
        "type": "string",
        "description": "Display field from Tier join"
      },
      {
        "name": "TierX",
        "type": "short?",
        "nullable": true
      },
      {
        "name": "TierY",
        "type": "short?",
        "nullable": true
      },
      {
        "name": "TierPos",
        "type": "string",
        "description": "Computed display field: (TierX,TierY)"
      },
      {
        "name": "PositionStartDateTime",
        "type": "DateTime",
        "required": true,
        "filterable": true,
        "sortable": true
      },
      {
        "name": "LeftFleet",
        "type": "bool",
        "description": "If true, tier position fields should be null"
      },
      {
        "name": "CreateDateTime",
        "type": "DateTime"
      },
      {
        "name": "ModifyDateTime",
        "type": "DateTime?",
        "description": "Used for optimistic concurrency"
      },
      {
        "name": "CreateUser",
        "type": "string"
      },
      {
        "name": "ModifyUser",
        "type": "string"
      }
    ]
  },
  "listQueryFields": {
    "filterable": [
      "FleetID",
      "BargeNum",
      "TierGroupID",
      "PositionStartDateTime",
      "LeftFleet"
    ],
    "sortable": [
      "PositionStartDateTime",
      "BargeNum",
      "TierName",
      "CreateDateTime"
    ],
    "defaultSort": "PositionStartDateTime DESC"
  },
  "businessRules": [
    {
      "rule": "PositionStartDateTime is required",
      "validation": "Cannot be empty"
    },
    {
      "rule": "BargeNum must match existing barge",
      "validation": "Lookup BargeID from BargeNum, must return valid ID"
    },
    {
      "rule": "Tier coordinates validation",
      "validation": "When TierID is provided, TierX and TierY must be within tier boundaries (validated by FleetPositionHistoryCheck)"
    },
    {
      "rule": "LeftFleet behavior",
      "validation": "When LeftFleet is true, TierID, TierX, and TierY should be null"
    },
    {
      "rule": "Optimistic concurrency",
      "validation": "Update checks ModifyDateTime matches current value"
    }
  ],
  "dataTransformations": [
    {
      "field": "PositionStartDateTime",
      "format": "SmartDate with SmartDateTimeFormat",
      "display": "DateTime with military time (HH:mm)"
    },
    {
      "field": "TierPos",
      "format": "Computed as '(' + TierX + ',' + TierY + ')'",
      "display": "Example: (5,3)"
    },
    {
      "field": "BargeNum",
      "source": "Lookup from Barge.BargeNum via BargeID join"
    },
    {
      "field": "TierName",
      "source": "Lookup from Tier.Name via TierID join"
    }
  ],
  "relatedEntities": [
    {
      "entity": "Fleet",
      "relationship": "ManyToOne",
      "foreignKey": "FleetID"
    },
    {
      "entity": "Barge",
      "relationship": "ManyToOne",
      "foreignKey": "BargeID"
    },
    {
      "entity": "Tier",
      "relationship": "ManyToOne",
      "foreignKey": "TierID",
      "nullable": true
    },
    {
      "entity": "TierGroup",
      "relationship": "ManyToOne",
      "description": "Via Tier.TierGroupID for search filtering"
    }
  ],
  "uiPatterns": {
    "searchForm": {
      "file": "frmBargePositionHistory.vb",
      "searchCriteria": [
        "Date (required)",
        "TierGroup (required dropdown)",
        "BargeNum (optional text search)",
        "IncludeBlankTierPos (checkbox)"
      ],
      "gridColumns": [
        "PositionStartDateTime",
        "BargeNum",
        "LeftFleet",
        "TierName",
        "TierPos"
      ]
    },
    "editForm": {
      "file": "frmBargePositionHistory.vb",
      "fields": [
        "PositionStartDate (date picker)",
        "PositionStartTime (time combo)",
        "BargeNum (text input)",
        "LeftFleet (checkbox)",
        "TierID (dropdown - disabled if LeftFleet checked)",
        "TierX (numeric input - disabled if LeftFleet checked)",
        "TierY (numeric input - disabled if LeftFleet checked)"
      ],
      "validation": [
        "TierX and TierY must be Int16",
        "PositionStartTime must be valid time format"
      ]
    }
  },
  "migrationNotes": [
    "This entity represents historical tracking of barge positions within fleets",
    "No soft delete - uses hard delete for cleanup of historical records",
    "Tier coordinates (TierX, TierY) must be validated against tier boundaries",
    "When LeftFleet is true, tier position fields should be cleared/null",
    "Uses optimistic concurrency with ModifyDateTime for update conflict detection",
    "Search includes date range filtering (entire day based on PositionStartDate)",
    "BargeNum is a computed/lookup field from Barge table join",
    "Consider implementing as read-only in modern system if actively writing to separate history table"
  ]
}
