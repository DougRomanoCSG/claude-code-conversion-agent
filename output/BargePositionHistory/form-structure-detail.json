{
  "formName": "frmBargePositionHistory",
  "formTitle": "Barge Position History",
  "formType": "DetailEditList",
  "implements": ["IBaseDetailEdit"],
  "businessObject": "FleetPositionHistory",
  "uniqueIdentifier": "FleetPositionHistoryID",
  "description": "Form for managing barge position history within a fleet. Allows searching, adding, modifying, and removing barge position records with tier positioning and timing details.",

  "layout": {
    "sections": [
      {
        "name": "pnlDetailEdit",
        "type": "SearchCriteria",
        "label": "Search Criteria",
        "dock": "Top",
        "controls": ["dtDateSearch", "cboTierGroupSearch", "txtBargeNumSearch", "chkIncludeBlankTierPos", "btnFind", "btnReset"]
      },
      {
        "name": "grpDetailEditList",
        "type": "ResultsGrid",
        "label": "Barge Positions",
        "dock": "Fill",
        "controls": ["grdDetailEditList"]
      },
      {
        "name": "grpDetailEditChild",
        "type": "DetailEdit",
        "label": "Detail",
        "dock": "Bottom",
        "controls": ["dtPositionStartDate", "cboPositionStartTime", "txtBargeNum", "chkLeftFleet", "cboTierID", "txtTierX", "txtTierY", "btnSubmit", "btnCancel"]
      },
      {
        "name": "grpSubmitCancel",
        "type": "Footer",
        "dock": "Bottom",
        "controls": ["btnClose"]
      }
    ]
  },

  "controls": [
    {
      "name": "dtDateSearch",
      "type": "UltraDateTimeEditor",
      "category": "SearchCriteria",
      "label": "Date",
      "dataBinding": null,
      "required": true,
      "validation": ["Date is required for search"],
      "events": [],
      "defaultValue": "Date.Today",
      "modernPattern": {
        "type": "DateInput",
        "htmlType": "date",
        "class": "form-control"
      }
    },
    {
      "name": "cboTierGroupSearch",
      "type": "UltraCombo",
      "category": "SearchCriteria",
      "label": "Tier group",
      "dataBinding": null,
      "required": true,
      "validation": ["Tier group is required for search"],
      "populationMethod": "Lists.TierGroupSearch.GetList(_SelectedFleetID)",
      "dataSource": "TierGroupSearch",
      "valueField": "TierGroupID",
      "displayField": "TierGroupName",
      "events": [],
      "modernPattern": {
        "type": "Select",
        "enhancement": "Select2",
        "class": "form-select"
      }
    },
    {
      "name": "txtBargeNumSearch",
      "type": "UltraTextEditor",
      "category": "SearchCriteria",
      "label": "Barge",
      "dataBinding": null,
      "required": false,
      "validation": [],
      "events": [],
      "modernPattern": {
        "type": "TextInput",
        "htmlType": "text",
        "class": "form-control"
      }
    },
    {
      "name": "chkIncludeBlankTierPos",
      "type": "UltraCheckEditor",
      "category": "SearchCriteria",
      "label": "Include blank tier positions",
      "dataBinding": null,
      "required": false,
      "validation": [],
      "events": [],
      "defaultValue": false,
      "modernPattern": {
        "type": "Checkbox",
        "class": "form-check-input"
      }
    },
    {
      "name": "dtPositionStartDate",
      "type": "UltraDateTimeEditor",
      "category": "DataEntry",
      "label": "Date/Time",
      "dataBinding": "PositionStartDateTime",
      "required": true,
      "validation": ["PositionStartDateTime is required"],
      "events": ["Validated"],
      "note": "CRITICAL: This is part of a split DateTime control - date portion only",
      "modernPattern": {
        "type": "SplitDateTime",
        "dateInput": {
          "id": "dtPositionDate",
          "type": "date",
          "label": "Position Date",
          "required": true,
          "class": "form-control"
        },
        "timeInput": {
          "id": "dtPositionTime",
          "type": "time",
          "label": "Position Time (24-hour)",
          "required": true,
          "class": "form-control"
        },
        "combinedProperty": "PositionStartDateTime",
        "displayFormat": "MM/dd/yyyy HH:mm",
        "validationMethod": "InfragisticsHelper.SetCombinedDateTimeProp"
      }
    },
    {
      "name": "cboPositionStartTime",
      "type": "UltraCombo",
      "category": "DataEntry",
      "label": "Time",
      "dataBinding": "PositionStartDateTime",
      "required": true,
      "validation": ["Time validation via ValidatorExtender"],
      "populationMethod": "InfragisticsHelper.PopulateTimeCombo",
      "events": ["Validated"],
      "note": "CRITICAL: This is part of a split DateTime control - time portion only. Uses 24-hour military time format.",
      "modernPattern": {
        "type": "TimeInput",
        "format": "24-hour",
        "combinedWith": "dtPositionStartDate",
        "note": "See dtPositionStartDate modernPattern for combined implementation"
      }
    },
    {
      "name": "txtBargeNum",
      "type": "UltraTextEditor",
      "category": "DataEntry",
      "label": "Barge",
      "dataBinding": "BargeNum",
      "required": true,
      "validation": ["Barge number must match an existing barge record"],
      "events": ["Validated"],
      "businessRule": "BargeNum lookup validates against Barge.GetBargeID and sets BargeID property",
      "modernPattern": {
        "type": "TextInput",
        "htmlType": "text",
        "class": "form-control",
        "note": "Consider autocomplete/lookup implementation for barge validation"
      }
    },
    {
      "name": "chkLeftFleet",
      "type": "UltraCheckEditor",
      "category": "DataEntry",
      "label": "Left fleet",
      "dataBinding": "LeftFleet",
      "required": false,
      "validation": [],
      "events": ["CheckedChanged"],
      "businessRule": "When checked, disables and clears TierID, TierX, TierY fields",
      "defaultValue": false,
      "modernPattern": {
        "type": "Checkbox",
        "class": "form-check-input",
        "conditionalLogic": "When checked, disable tier-related fields (cboTierID, txtTierX, txtTierY)"
      }
    },
    {
      "name": "cboTierID",
      "type": "UltraCombo",
      "category": "DataEntry",
      "label": "Tier",
      "dataBinding": "TierID",
      "required": false,
      "validation": [],
      "populationMethod": "Lists.TierList.GetList(CStr(cboTierGroupSearch.ValueOrNull))",
      "dataSource": "TierList",
      "valueField": "TierID",
      "displayField": "TierName",
      "events": ["Validated"],
      "conditionalDisplay": "Disabled when chkLeftFleet is checked",
      "modernPattern": {
        "type": "Select",
        "enhancement": "Select2",
        "class": "form-select",
        "cascadeFrom": "cboTierGroupSearch"
      }
    },
    {
      "name": "txtTierX",
      "type": "UltraTextEditor",
      "category": "DataEntry",
      "label": "Tier X",
      "dataBinding": "TierX",
      "required": false,
      "validation": ["Int16"],
      "events": ["Validated"],
      "conditionalDisplay": "Disabled when chkLeftFleet is checked",
      "modernPattern": {
        "type": "TextInput",
        "htmlType": "number",
        "class": "form-control",
        "attributes": {
          "min": "-32768",
          "max": "32767",
          "step": "1"
        }
      }
    },
    {
      "name": "txtTierY",
      "type": "UltraTextEditor",
      "category": "DataEntry",
      "label": "Tier Y",
      "dataBinding": "TierY",
      "required": false,
      "validation": ["Int16"],
      "events": ["Validated"],
      "conditionalDisplay": "Disabled when chkLeftFleet is checked",
      "modernPattern": {
        "type": "TextInput",
        "htmlType": "number",
        "class": "form-control",
        "attributes": {
          "min": "-32768",
          "max": "32767",
          "step": "1"
        }
      }
    }
  ],

  "grids": [
    {
      "name": "grdDetailEditList",
      "type": "UltraGrid",
      "uniqueIdentifier": "FleetPositionHistoryID",
      "purpose": "Display list of barge position history records for selected fleet and criteria",
      "dataSource": "Lists.FleetPositionHistorySearch.GetList",
      "dataSourceParameters": [
        "_SelectedFleetID.ToString",
        "dtDateSearch.Value.ToString",
        "CStr(cboTierGroupSearch.ValueOrNull)",
        "txtBargeNumSearch.Text",
        "chkIncludeBlankTierPos.Checked"
      ],
      "columns": [
        {
          "key": "PositionStartDateTime",
          "header": "Date/Time",
          "dataType": "DateTime",
          "width": 105,
          "alignment": "Left",
          "sortable": true,
          "filterable": true,
          "defaultSort": "Ascending",
          "customComparer": "DateTimeSortComparer"
        },
        {
          "key": "BargeNum",
          "header": "Barge",
          "dataType": "String",
          "width": 146,
          "alignment": "Left",
          "sortable": true,
          "filterable": true
        },
        {
          "key": "LeftFleet",
          "header": "Left Fleet",
          "dataType": "Boolean",
          "width": 62,
          "alignment": "Center",
          "sortable": true,
          "filterable": true
        },
        {
          "key": "TierName",
          "header": "Tier",
          "dataType": "String",
          "width": 195,
          "alignment": "Left",
          "sortable": true,
          "filterable": true
        },
        {
          "key": "TierPos",
          "header": "Tier Pos",
          "dataType": "String",
          "width": 57,
          "alignment": "Left",
          "sortable": true,
          "filterable": true
        }
      ],
      "autoFitStyle": "ExtendLastColumn",
      "events": ["DoubleClick", "AfterSelectChange"],
      "gridSettings": "MyAppSettingHelper.SaveGrid",
      "modernPattern": {
        "type": "DataTable",
        "serverSide": true,
        "columns": [
          { "data": "positionStartDateTime", "title": "Date/Time", "type": "datetime", "format": "MM/dd/yyyy HH:mm" },
          { "data": "bargeNum", "title": "Barge" },
          { "data": "leftFleet", "title": "Left Fleet", "render": "checkbox" },
          { "data": "tierName", "title": "Tier" },
          { "data": "tierPos", "title": "Tier Pos" }
        ],
        "order": [[0, "asc"]],
        "rowActions": ["Edit", "Delete"]
      }
    }
  ],

  "buttons": [
    {
      "name": "btnFind",
      "text": "F&ind",
      "type": "Search",
      "category": "Search",
      "enabled": true,
      "visible": true,
      "handler": "btnFind_Click",
      "purpose": "Execute search using current criteria",
      "validationRequired": false,
      "shortcutKey": "i",
      "modernPattern": {
        "type": "button",
        "class": "btn btn-primary",
        "icon": "search"
      }
    },
    {
      "name": "btnReset",
      "text": "Reset",
      "type": "Action",
      "category": "Search",
      "enabled": true,
      "visible": true,
      "handler": "btnReset_Click",
      "purpose": "Clear search criteria and reset to defaults",
      "validationRequired": false,
      "modernPattern": {
        "type": "button",
        "class": "btn btn-secondary",
        "icon": "refresh"
      }
    },
    {
      "name": "btnSubmit",
      "text": "&Submit",
      "type": "Submit",
      "category": "DetailEdit",
      "enabled": true,
      "visible": true,
      "handler": "btnSubmit_Click",
      "purpose": "Save changes to barge position history record",
      "validationRequired": true,
      "shortcutKey": "s",
      "modernPattern": {
        "type": "submit",
        "class": "btn btn-success",
        "icon": "save"
      }
    },
    {
      "name": "btnCancel",
      "text": "C&ancel",
      "type": "CancelEdit",
      "category": "DetailEdit",
      "enabled": true,
      "visible": true,
      "handler": "btnCancel_Click",
      "purpose": "Cancel edit and discard changes",
      "validationRequired": false,
      "shortcutKey": "a",
      "modernPattern": {
        "type": "button",
        "class": "btn btn-warning",
        "icon": "times"
      }
    },
    {
      "name": "btnClose",
      "text": "&Close",
      "type": "Cancel",
      "category": "FormClose",
      "enabled": true,
      "visible": true,
      "handler": "btnClose_Click",
      "purpose": "Close the form",
      "validationRequired": false,
      "shortcutKey": "c",
      "dialogResult": "Cancel",
      "modernPattern": {
        "type": "button",
        "class": "btn btn-secondary",
        "icon": "times-circle"
      }
    }
  ],

  "toolbarButtons": [
    {
      "key": "Add",
      "caption": "&Add",
      "type": "Add",
      "icon": "Add",
      "handler": "ItemAdd",
      "purpose": "Create new barge position history record",
      "enabledCondition": "Not IsEditingChild",
      "securityCheck": true,
      "modernPattern": {
        "type": "button",
        "class": "btn btn-success btn-sm",
        "icon": "plus",
        "text": "Add"
      }
    },
    {
      "key": "Modify",
      "caption": "&Modify",
      "type": "Open",
      "icon": "Modify",
      "handler": "ItemModify",
      "purpose": "Edit selected barge position history record",
      "enabledCondition": "itemIsSelected AND Not IsEditingChild",
      "securityCheck": true,
      "modernPattern": {
        "type": "button",
        "class": "btn btn-primary btn-sm",
        "icon": "edit",
        "text": "Modify"
      }
    },
    {
      "key": "Remove",
      "caption": "&Remove",
      "type": "Remove",
      "icon": "Remove",
      "handler": "ItemRemove",
      "purpose": "Delete selected barge position history record",
      "enabledCondition": "itemIsSelected AND Not IsEditingChild",
      "securityCheck": true,
      "confirmationDialog": "Are you sure you want to remove this Barge Position?",
      "modernPattern": {
        "type": "button",
        "class": "btn btn-danger btn-sm",
        "icon": "trash",
        "text": "Remove"
      }
    },
    {
      "key": "Export",
      "caption": "Export",
      "type": "Open",
      "icon": "ExportResults",
      "handler": "Main.ExportGrid",
      "purpose": "Export grid data to external format",
      "enabledCondition": "atLeastOneRow AND Not IsEditingChild",
      "securityCheck": true,
      "isFirstInGroup": true,
      "modernPattern": {
        "type": "button",
        "class": "btn btn-info btn-sm",
        "icon": "download",
        "text": "Export"
      }
    }
  ],

  "validation": {
    "validatorExtender": "ValidatorExtender",
    "displayControl": "staStatus",
    "rules": [
      {
        "control": "dtDateSearch",
        "rule": "Required for search",
        "message": "Date and Tier group are required.",
        "validationType": null
      },
      {
        "control": "cboTierGroupSearch",
        "rule": "Required for search",
        "message": "Date and Tier group are required.",
        "validationType": null
      },
      {
        "control": "txtBargeNum",
        "rule": "Must match existing barge",
        "message": "Barge number must match an existing barge record.",
        "validationType": "String",
        "businessRule": "BargeNumberNotFound"
      },
      {
        "control": "txtTierX",
        "rule": "Must be valid Int16",
        "message": null,
        "validationType": "Int16"
      },
      {
        "control": "txtTierY",
        "rule": "Must be valid Int16",
        "message": null,
        "validationType": "Int16"
      },
      {
        "control": "cboPositionStartTime",
        "rule": "Must be valid time",
        "message": null,
        "validationType": "Time",
        "validationMethod": "Main.SetTimeValidatorExtender"
      },
      {
        "control": "dtPositionStartDate",
        "rule": "PositionStartDateTime is required",
        "message": "PositionStartDateTime is required",
        "validationType": "DateTime",
        "businessRule": "Required field from business object"
      }
    ]
  },

  "eventHandlers": {
    "Load": "Initialize controls, format grid, populate dropdowns, set defaults",
    "FormClosed": "Save grid settings via MyAppSettingHelper.SaveGrid",
    "btnFind_Click": "Execute RefreshList(True) with search criteria",
    "btnReset_Click": "Clear search criteria, set dtDateSearch to Date.Today",
    "btnSubmit_Click": "Validate and save FleetPositionHistory, refresh grid, exit edit mode",
    "btnCancel_Click": "Cancel edit, discard changes, refresh grid, exit edit mode",
    "btnClose_Click": "Close form with warning if unsaved changes exist",
    "ToolbarsManager_ToolClick": "Route toolbar button clicks to appropriate handlers",
    "grdDetailEditList_DoubleClick": "Call ItemModify to edit selected record",
    "grdDetailEditList_AfterSelectChange": "Call SetToolState to enable/disable toolbar buttons",
    "txtBargeNum_Validated": "Set FleetPositionHistory.BargeNum, validate against Barge.GetBargeID",
    "dtPositionStartDate_Validated": "Combine date and time into PositionStartDateTime via InfragisticsHelper.SetCombinedDateTimeProp",
    "cboPositionStartTime_Validated": "Combine date and time into PositionStartDateTime via InfragisticsHelper.SetCombinedDateTimeProp",
    "cboTierID_Validated": "Set FleetPositionHistory.TierID",
    "txtTierX_Validated": "Set FleetPositionHistory.TierX",
    "txtTierY_Validated": "Set FleetPositionHistory.TierY",
    "chkLeftFleet_CheckedChanged": "Set FleetPositionHistory.LeftFleet, call EnableDisableTierPos to toggle tier fields"
  },

  "businessLogic": {
    "businessObject": "FleetPositionHistory",
    "initializationMethod": "Initialize(selectedFleetID As Int32)",
    "properties": [
      {
        "name": "FleetPositionHistoryID",
        "type": "Int32",
        "primaryKey": true,
        "readOnly": true
      },
      {
        "name": "FleetID",
        "type": "Int32",
        "required": true,
        "setOnAdd": true,
        "setValue": "_SelectedFleetID"
      },
      {
        "name": "BargeID",
        "type": "Int32",
        "required": false,
        "derivedFrom": "BargeNum"
      },
      {
        "name": "BargeNum",
        "type": "String",
        "required": false,
        "customProperty": true,
        "validation": "Must match existing barge via Barge.GetBargeID"
      },
      {
        "name": "TierID",
        "type": "String (Int32)",
        "required": false,
        "clearedWhen": "LeftFleet = True"
      },
      {
        "name": "TierX",
        "type": "String (Int16)",
        "required": false,
        "clearedWhen": "LeftFleet = True"
      },
      {
        "name": "TierY",
        "type": "String (Int16)",
        "required": false,
        "clearedWhen": "LeftFleet = True"
      },
      {
        "name": "PositionStartDateTime",
        "type": "SmartDate (DateTime)",
        "required": true,
        "formatString": "SmartDateTimeFormat",
        "defaultOnAdd": "dtDateSearch.Text & ' ' & Lists.GlobalSettingList.FleetingDayStartTime"
      },
      {
        "name": "LeftFleet",
        "type": "Boolean",
        "required": false,
        "defaultValue": false
      }
    ],
    "methods": {
      "NewFleetPositionHistory": "Create new instance",
      "GetFleetPositionHistory": "Load existing by ID",
      "DeleteFleetPositionHistory": "Delete by ID",
      "BeginEdit": "Start edit transaction",
      "CancelEdit": "Rollback changes",
      "ApplyEdit": "Commit changes",
      "IsValid": "Validate business rules"
    },
    "dataAccess": {
      "selectSP": "FleetPositionHistorySelect",
      "selectAllSP": "FleetPositionHistoriesSelect",
      "insertSP": "FleetPositionHistoryInsert",
      "updateSP": "FleetPositionHistoryUpdate",
      "deleteSP": "FleetPositionHistoryDelete"
    }
  },

  "conditionalLogic": {
    "EnableDisableControls": {
      "when": "isEditing = True",
      "then": [
        "Enable grpDetailEditChild controls",
        "Disable pnlDetailEdit controls",
        "Call EnableDisableTierPos",
        "Set IsEditingChild = True",
        "Call SetToolState"
      ],
      "else": [
        "Disable grpDetailEditChild controls",
        "Enable pnlDetailEdit controls",
        "Set IsEditingChild = False",
        "Call SetToolState"
      ]
    },
    "EnableDisableTierPos": {
      "when": "chkLeftFleet.Checked = True",
      "then": [
        "Disable cboTierID",
        "Disable txtTierX",
        "Disable txtTierY",
        "Disable related labels"
      ],
      "else": [
        "Enable cboTierID",
        "Enable txtTierX",
        "Enable txtTierY",
        "Enable related labels"
      ]
    },
    "ClearUnusedFields": {
      "when": "LeftFleet = True",
      "then": [
        "Clear TierID",
        "Clear TierX",
        "Clear TierY",
        "Clear related controls"
      ]
    }
  },

  "formBehavior": {
    "formState": "DetailEditList",
    "editModes": [
      {
        "mode": "Search",
        "description": "Default mode - search criteria active, grid visible, detail section disabled"
      },
      {
        "mode": "EditingChild",
        "description": "When adding or modifying - search disabled, grid visible but inactive, detail section active"
      }
    ],
    "securityIntegration": {
      "controlAuthorization": true,
      "buttonTypes": {
        "btnFind": "Action",
        "btnReset": "Action",
        "btnSubmit": "Submit",
        "btnClose": "Cancel",
        "btnCancel": "CancelEdit",
        "Add": "Add",
        "Modify": "Open",
        "Remove": "Remove",
        "Export": "Open"
      }
    },
    "inheritance": "frmBaseDetailEditList",
    "baseFormFeatures": [
      "InitializeBase",
      "FormatGridControl",
      "RefreshListBase",
      "SubmitClick",
      "CancelClick",
      "ItemModify",
      "SetToolState",
      "GridControlUniqueIdentifierCol",
      "IsEditingChild property management"
    ]
  },

  "dataFlow": {
    "initialization": [
      "Form receives _SelectedFleetID parameter",
      "FormatControls: Populate tier group dropdown filtered by FleetID",
      "FormatControls: Populate time combo with standard times",
      "Set grid unique identifier column",
      "Set initial sort order",
      "Set validator properties",
      "Disable detail section"
    ],
    "searchFlow": [
      "User enters date (required)",
      "User selects tier group (required)",
      "User optionally enters barge number",
      "User optionally checks 'Include blank tier positions'",
      "Click Find button",
      "Validate date and tier group present",
      "Call Lists.FleetPositionHistorySearch.GetList with parameters",
      "Populate grid via RefreshListBase",
      "Enable toolbar buttons based on selection"
    ],
    "addFlow": [
      "Click Add toolbar button",
      "Create new FleetPositionHistory instance",
      "Set FleetID = _SelectedFleetID",
      "Set default PositionStartDateTime from search date + fleet day start time",
      "Populate tier dropdown based on selected tier group",
      "Load controls",
      "Enable detail section, disable search section",
      "Focus txtBargeNum"
    ],
    "editFlow": [
      "Select grid row and double-click or click Modify",
      "Load FleetPositionHistory by ID from selected row",
      "BeginEdit on business object",
      "Populate tier dropdown based on tier group",
      "Load all controls from business object properties",
      "Enable detail section, disable search section",
      "Focus dtPositionStartDate"
    ],
    "saveFlow": [
      "User modifies fields in detail section",
      "Each field Validated event updates business object property",
      "Click Submit",
      "Call ClearUnusedFields (clears tier fields if LeftFleet checked)",
      "Call SubmitClick (base form validation)",
      "Business object validates (IsValid)",
      "If valid: ApplyEdit, save to database",
      "Clear controls, disable detail section, enable search section",
      "Refresh grid with updated data"
    ],
    "deleteFlow": [
      "Select grid row",
      "Click Remove toolbar button",
      "Display confirmation dialog",
      "If confirmed: Call FleetPositionHistory.DeleteFleetPositionHistory with ID",
      "Refresh grid",
      "Update toolbar button states"
    ]
  },

  "modernizationNotes": {
    "criticalPatterns": [
      "SPLIT DATETIME: dtPositionStartDate + cboPositionStartTime must become separate date and time inputs with 24-hour format",
      "CONDITIONAL FIELDS: chkLeftFleet controls visibility/state of tier-related fields",
      "CASCADING DROPDOWNS: cboTierID depends on selected cboTierGroupSearch value",
      "INLINE EDITING: Detail section appears at bottom of grid, not separate modal"
    ],
    "recommendedImplementation": {
      "controller": "BargePositionHistoryController.cs",
      "views": [
        "BargePositionHistory/Index.cshtml - Main search and grid view",
        "BargePositionHistory/_DetailEdit.cshtml - Partial view for inline detail section"
      ],
      "viewModels": [
        "BargePositionHistorySearchViewModel.cs - Search criteria and grid",
        "BargePositionHistoryEditViewModel.cs - Detail edit section"
      ],
      "dto": "FleetPositionHistoryDto.cs in BargeOps.Shared",
      "javascript": "bargePositionHistory.js - DataTables, form interactions, conditional logic"
    },
    "uiComponents": {
      "grid": "DataTables with server-side processing",
      "dateInput": "HTML5 date input",
      "timeInput": "HTML5 time input with 24-hour format",
      "dropdowns": "Select2 for enhanced dropdowns",
      "validation": "Client-side: jQuery Validation, Server-side: FluentValidation",
      "toolbar": "Bootstrap button group"
    }
  }
}
