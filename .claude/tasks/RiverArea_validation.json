{
  "entity": "RiverArea",
  "extractedFrom": {
    "businessObject": "RiverArea.vb",
    "businessObjectBase": "RiverAreaBase.vb",
    "form": "frmRiverAreaDetail.vb",
    "childEntity": "RiverAreaSegment.vb",
    "childEntityBase": "RiverAreaSegmentBase.vb"
  },
  "formValidation": {
    "method": "SetValidatorExtenderForRiverArea / SetValidatorExtenderForRiverAreaSegment",
    "validatorExtender": "ValidatorExtender",
    "displayControl": "staStatus",
    "rules": [
      {
        "field": "txtName",
        "validationType": "ValidationTypeConstants.String",
        "description": "Name field must be valid string"
      },
      {
        "field": "txtStartMile",
        "validationType": "ValidationTypeConstants.Decimal",
        "description": "Start Mile must be decimal value (RiverAreaSegment)"
      },
      {
        "field": "txtEndMile",
        "validationType": "ValidationTypeConstants.Decimal",
        "description": "End Mile must be decimal value (RiverAreaSegment)"
      }
    ]
  },
  "businessValidation": {
    "mainEntity": "RiverArea",
    "method": "CheckBusinessRules",
    "rules": [
      {
        "ruleName": "NameRequired",
        "property": "Name",
        "condition": "String.IsNullOrEmpty(p_Name)",
        "message": "Name is required",
        "severity": "Error",
        "alwaysApplies": true,
        "location": "RiverAreaBase.vb:314-316"
      },
      {
        "ruleName": "NameMaxLength",
        "property": "Name",
        "condition": "(p_Name.Length > MaxLength.Name)",
        "message": "Name exceeds maximum length of 50.",
        "severity": "Error",
        "alwaysApplies": true,
        "maxLength": 50,
        "location": "RiverAreaBase.vb:317-319"
      },
      {
        "ruleName": "MutuallyExclusiveFlags",
        "property": "IsPriceZone, IsPortalArea, IsHighWaterArea",
        "condition": "((p_IsPriceZone AndAlso p_IsPortalArea) OrElse (p_IsPortalArea AndAlso p_IsHighWaterArea) OrElse (p_IsPriceZone AndAlso p_IsHighWaterArea))",
        "message": "Only one of these may be checked: Pricing zone, Portal area, or High water area.",
        "severity": "Error",
        "alwaysApplies": true,
        "description": "User can only select one of the three area types",
        "location": "RiverArea.vb:92-96"
      },
      {
        "ruleName": "CustomerIDRequiresHighWaterArea",
        "property": "CustomerID, IsHighWaterArea",
        "condition": "((Not p_IsHighWaterArea) AndAlso (Not String.IsNullOrEmpty(p_CustomerID)))",
        "message": "High water customer must be blank if High water area is not checked.",
        "severity": "Error",
        "alwaysApplies": false,
        "appliesWhen": "High Water Area is unchecked but CustomerID is populated",
        "location": "RiverArea.vb:101-104",
        "note": "Form clears this field automatically when High Water Area is unchecked (ClearUnusedFields method)"
      },
      {
        "ruleName": "OverlappingPricingZones",
        "property": "IsPriceZone, RiverAreaSegments",
        "condition": "Complex validation - checks if river segments overlap with other pricing zones",
        "message": "Another pricing zone has river segments that overlap this zone. The other zone(s) are {overlapping zone names}.",
        "severity": "Error",
        "alwaysApplies": false,
        "appliesWhen": "IsPriceZone = true",
        "description": "Validates that pricing zones don't have overlapping river segments",
        "validationLogic": "Compares Start Mile and End Mile of each river segment against other pricing zones with matching rivers. Uses HasOverlappingMiles method to check if ((myEndMile <= otherStartMile) OrElse (myStartMile >= otherEndMile)) = no overlap",
        "location": "RiverArea.vb:113-169",
        "triggeredBy": "IsValid property calls CheckBusinessRules('OverlappingPricingZones')"
      }
    ],
    "childEntity": "RiverAreaSegment",
    "childRules": [
      {
        "ruleName": "RiverRequired",
        "property": "River",
        "condition": "String.IsNullOrEmpty(p_River)",
        "message": "River is required",
        "severity": "Error",
        "alwaysApplies": true,
        "location": "RiverAreaSegmentBase.vb:211-213"
      },
      {
        "ruleName": "RiverMaxLength",
        "property": "River",
        "condition": "(p_River.Length > MaxLength.River)",
        "message": "River exceeds maximum length of 3.",
        "severity": "Error",
        "alwaysApplies": true,
        "maxLength": 3,
        "location": "RiverAreaSegmentBase.vb:214-216"
      },
      {
        "ruleName": "StartMileRequired",
        "property": "StartMile",
        "condition": "String.IsNullOrEmpty(p_StartMile)",
        "message": "Start mile is required",
        "severity": "Error",
        "alwaysApplies": true,
        "location": "RiverAreaSegmentBase.vb:219-221"
      },
      {
        "ruleName": "EndMileRequired",
        "property": "EndMile",
        "condition": "String.IsNullOrEmpty(p_EndMile)",
        "message": "End mile is required",
        "severity": "Error",
        "alwaysApplies": true,
        "location": "RiverAreaSegmentBase.vb:224-227"
      },
      {
        "ruleName": "StartMileWithinRiverRange",
        "property": "StartMile, River",
        "condition": "((Not String.IsNullOrEmpty(p_River)) AndAlso CheckMileInRangeForRiver(p_StartMile, minMile, maxMile))",
        "message": "Mile {StartMile} must be within the river's mile range of {minMile} to {maxMile}.",
        "severity": "Error",
        "alwaysApplies": false,
        "appliesWhen": "River is selected",
        "description": "Start mile must be >= river's MinMile and <= river's MaxMile",
        "location": "RiverAreaSegment.vb:76-78"
      },
      {
        "ruleName": "EndMileWithinRiverRange",
        "property": "EndMile, River",
        "condition": "((Not String.IsNullOrEmpty(p_River)) AndAlso CheckMileInRangeForRiver(p_EndMile, minMile, maxMile))",
        "message": "Mile {EndMile} must be within the river's mile range of {minMile} to {maxMile}.",
        "severity": "Error",
        "alwaysApplies": false,
        "appliesWhen": "River is selected",
        "description": "End mile must be >= river's MinMile and <= river's MaxMile",
        "location": "RiverAreaSegment.vb:81-83"
      },
      {
        "ruleName": "StartMileNotGreaterEndMile",
        "property": "StartMile, EndMile",
        "condition": "((Not String.IsNullOrEmpty(p_River)) AndAlso (Not String.IsNullOrEmpty(p_StartMile)) AndAlso (Not String.IsNullOrEmpty(p_EndMile)) AndAlso (CType(p_StartMile, Decimal) > CType(p_EndMile, Decimal)))",
        "message": "Start mile must not be greater than end mile.",
        "severity": "Error",
        "alwaysApplies": false,
        "appliesWhen": "River, StartMile, and EndMile are all populated",
        "location": "RiverAreaSegment.vb:86-91"
      }
    ]
  },
  "fieldConstraints": {
    "RiverArea": {
      "RiverAreaID": {
        "type": "Int32",
        "isPrimaryKey": true,
        "required": false,
        "description": "Auto-generated identity"
      },
      "Name": {
        "type": "String",
        "required": true,
        "maxLength": 50,
        "dbType": "VarChar"
      },
      "IsActive": {
        "type": "Boolean",
        "required": true,
        "defaultValue": true,
        "dbType": "Bit",
        "description": "Set to true on Initialize"
      },
      "IsPriceZone": {
        "type": "Boolean",
        "required": true,
        "defaultValue": false,
        "dbType": "Bit",
        "displayName": "Pricing zone",
        "description": "Mutually exclusive with IsPortalArea and IsHighWaterArea"
      },
      "IsPortalArea": {
        "type": "Boolean",
        "required": true,
        "defaultValue": false,
        "dbType": "Bit",
        "displayName": "Portal area",
        "description": "Mutually exclusive with IsPriceZone and IsHighWaterArea. Visible only with Portal license"
      },
      "IsHighWaterArea": {
        "type": "Boolean",
        "required": true,
        "defaultValue": false,
        "dbType": "Bit",
        "displayName": "High water area",
        "description": "Mutually exclusive with IsPriceZone and IsPortalArea. Visible only if EnableRiverSegmentHighWaterModel setting enabled"
      },
      "CustomerID": {
        "type": "String (stored as Int32)",
        "required": false,
        "dbType": "Int",
        "displayName": "High water customer",
        "description": "Must be blank if IsHighWaterArea is false. Combo enabled/disabled based on IsHighWaterArea state"
      },
      "IsFuelTaxArea": {
        "type": "Boolean",
        "required": true,
        "defaultValue": false,
        "dbType": "Bit"
      },
      "IsLiquidRateArea": {
        "type": "Boolean",
        "required": true,
        "defaultValue": false,
        "dbType": "Bit",
        "description": "Visible only with UnitTow license"
      }
    },
    "RiverAreaSegment": {
      "RiverAreaSegmentID": {
        "type": "Int32",
        "isPrimaryKey": true,
        "required": false,
        "description": "Auto-generated identity"
      },
      "RiverAreaID": {
        "type": "Int32",
        "required": true,
        "isForeignKey": true,
        "references": "RiverArea.RiverAreaID"
      },
      "River": {
        "type": "String (Char)",
        "required": true,
        "maxLength": 3,
        "dbType": "Char",
        "description": "3-character river code"
      },
      "StartMile": {
        "type": "String (Decimal)",
        "required": true,
        "dbType": "Decimal",
        "format": "Two decimal places",
        "displayName": "Start mile",
        "description": "Must be within river's mile range and <= EndMile"
      },
      "EndMile": {
        "type": "String (Decimal)",
        "required": true,
        "dbType": "Decimal",
        "format": "Two decimal places",
        "displayName": "End mile",
        "description": "Must be within river's mile range and >= StartMile"
      }
    }
  },
  "validationTriggers": {
    "onSubmit": [
      "ClearUnusedFields() - Clears CustomerID if IsHighWaterArea is false",
      "Base form SubmitNoRefreshClick validation"
    ],
    "onCancel": [
      "ClearUnusedFields() - Clears CustomerID if IsHighWaterArea is false"
    ],
    "onPropertyChange": [
      "CheckBusinessRules(propertyName) called after any property set",
      "chkIsHighWaterArea.CheckedChanged - Enables/disables cboCustomerID"
    ],
    "onIsValid": [
      "CheckBusinessRules('OverlappingPricingZones') - Always checked when IsValid is called"
    ],
    "onChildEdit": [
      "RiverAreaSegment validation runs when Set/Submit clicked",
      "SetClickListAndDetail adds child to collection if valid"
    ]
  },
  "modernValidationMapping": {
    "dataAnnotations": {
      "RiverArea": [
        "[Required(ErrorMessage = \"Name is required\")]",
        "[StringLength(50, ErrorMessage = \"Name exceeds maximum length of 50.\")]",
        "public string Name { get; set; }",
        "",
        "[Required]",
        "public bool IsActive { get; set; } = true;",
        "",
        "[Required]",
        "public bool IsPriceZone { get; set; }",
        "",
        "[Required]",
        "public bool IsPortalArea { get; set; }",
        "",
        "[Required]",
        "public bool IsHighWaterArea { get; set; }",
        "",
        "[StringLength(10)]",
        "public string? CustomerID { get; set; }",
        "",
        "[Required]",
        "public bool IsFuelTaxArea { get; set; }",
        "",
        "[Required]",
        "public bool IsLiquidRateArea { get; set; }"
      ],
      "RiverAreaSegment": [
        "[Required(ErrorMessage = \"River is required\")]",
        "[StringLength(3, ErrorMessage = \"River exceeds maximum length of 3.\")]",
        "public string River { get; set; }",
        "",
        "[Required(ErrorMessage = \"Start mile is required\")]",
        "public decimal StartMile { get; set; }",
        "",
        "[Required(ErrorMessage = \"End mile is required\")]",
        "public decimal EndMile { get; set; }"
      ]
    },
    "fluentValidation": {
      "RiverArea": [
        "RuleFor(x => x.Name)",
        "    .NotEmpty().WithMessage(\"Name is required\")",
        "    .MaximumLength(50).WithMessage(\"Name exceeds maximum length of 50.\");",
        "",
        "RuleFor(x => x)",
        "    .Must(HaveOnlyOneAreaTypeSelected)",
        "    .WithMessage(\"Only one of these may be checked: Pricing zone, Portal area, or High water area.\")",
        "    .When(x => x.IsPriceZone || x.IsPortalArea || x.IsHighWaterArea);",
        "",
        "RuleFor(x => x.CustomerID)",
        "    .Empty()",
        "    .When(x => !x.IsHighWaterArea)",
        "    .WithMessage(\"High water customer must be blank if High water area is not checked.\");",
        "",
        "RuleFor(x => x.RiverAreaSegments)",
        "    .Must((model, segments) => !HasOverlappingPricingZones(model, segments))",
        "    .When(x => x.IsPriceZone)",
        "    .WithMessage(\"Another pricing zone has river segments that overlap this zone. The other zone(s) are {0}.\");"
      ],
      "RiverAreaSegment": [
        "RuleFor(x => x.River)",
        "    .NotEmpty().WithMessage(\"River is required\")",
        "    .MaximumLength(3).WithMessage(\"River exceeds maximum length of 3.\");",
        "",
        "RuleFor(x => x.StartMile)",
        "    .NotEmpty().WithMessage(\"Start mile is required\")",
        "    .Must((segment, startMile) => IsWithinRiverRange(segment.River, startMile))",
        "    .WithMessage((segment, startMile) => $\"Mile {startMile} must be within the river's mile range of {GetRiverMinMile(segment.River)} to {GetRiverMaxMile(segment.River)}.\");",
        "",
        "RuleFor(x => x.EndMile)",
        "    .NotEmpty().WithMessage(\"End mile is required\")",
        "    .Must((segment, endMile) => IsWithinRiverRange(segment.River, endMile))",
        "    .WithMessage((segment, endMile) => $\"Mile {endMile} must be within the river's mile range of {GetRiverMinMile(segment.River)} to {GetRiverMaxMile(segment.River)}.\");",
        "",
        "RuleFor(x => x)",
        "    .Must(x => x.StartMile <= x.EndMile)",
        "    .When(x => !string.IsNullOrEmpty(x.River) && x.StartMile.HasValue && x.EndMile.HasValue)",
        "    .WithMessage(\"Start mile must not be greater than end mile.\");"
      ]
    },
    "clientSideValidation": {
      "jqueryValidate": [
        "// Name validation",
        "$('#txtName').rules('add', {",
        "    required: true,",
        "    maxlength: 50,",
        "    messages: {",
        "        required: 'Name is required',",
        "        maxlength: 'Name exceeds maximum length of 50.'",
        "    }",
        "});",
        "",
        "// Mutually exclusive checkboxes",
        "$('#chkIsPriceZone, #chkIsPortalArea, #chkIsHighWaterArea').on('change', function() {",
        "    var checkedCount = $('#chkIsPriceZone:checked, #chkIsPortalArea:checked, #chkIsHighWaterArea:checked').length;",
        "    if (checkedCount > 1) {",
        "        showError('Only one of these may be checked: Pricing zone, Portal area, or High water area.');",
        "        return false;",
        "    }",
        "});",
        "",
        "// Enable/disable CustomerID based on IsHighWaterArea",
        "$('#chkIsHighWaterArea').on('change', function() {",
        "    $('#cboCustomerID').prop('disabled', !this.checked);",
        "    if (!this.checked) {",
        "        $('#cboCustomerID').val('');",
        "    }",
        "});",
        "",
        "// River segment validation",
        "$('#txtStartMile').rules('add', {",
        "    required: true,",
        "    number: true,",
        "    messages: {",
        "        required: 'Start mile is required',",
        "        number: 'Start mile must be a valid number'",
        "    }",
        "});",
        "",
        "$('#txtEndMile').rules('add', {",
        "    required: true,",
        "    number: true,",
        "    messages: {",
        "        required: 'End mile is required',",
        "        number: 'End mile must be a valid number'",
        "    }",
        "});"
      ]
    }
  },
  "specialBehaviors": {
    "formBehavior": [
      {
        "behavior": "ClearUnusedFields",
        "description": "Automatically clears CustomerID if IsHighWaterArea is unchecked",
        "triggeredBy": "Submit and Cancel buttons",
        "location": "frmRiverAreaDetail.vb:466-475"
      },
      {
        "behavior": "EnableDisableCustomerID",
        "description": "CustomerID combo is enabled only when IsHighWaterArea is checked",
        "triggeredBy": "chkIsHighWaterArea.CheckedChanged event",
        "location": "frmRiverAreaDetail.vb:584-607"
      },
      {
        "behavior": "ConditionalVisibility",
        "description": "IsPortalArea visible only with Portal license, IsLiquidRateArea visible only with UnitTow license, IsHighWaterArea/CustomerID visible only if EnableRiverSegmentHighWaterModel setting enabled",
        "location": "frmRiverAreaDetail.vb:366-380"
      },
      {
        "behavior": "MileFormatting",
        "description": "StartMile and EndMile formatted to two decimal places via FormattedMile method",
        "location": "RiverAreaSegment.vb:95-97"
      }
    ],
    "validationHelpers": [
      {
        "method": "HasOverlappingMiles",
        "description": "Checks if two mile ranges overlap: returns false if ((myEndMile <= otherStartMile) OrElse (myStartMile >= otherEndMile))",
        "location": "RiverArea.vb:171-179"
      },
      {
        "method": "CheckMileInRangeForRiver",
        "description": "Validates mile is >= river's MinMile and <= river's MaxMile",
        "location": "RiverAreaSegment.vb:99-104"
      },
      {
        "method": "CheckOverlappingPricingZones",
        "description": "Queries RiverAreaPriceZoneSearch to find other pricing zones with matching rivers, then checks each segment for overlaps",
        "location": "RiverArea.vb:113-169"
      }
    ]
  },
  "databaseValidation": {
    "storedProcedures": [
      "RiverAreaInsert",
      "RiverAreaUpdate",
      "RiverAreaDelete",
      "RiverAreaSegmentInsert",
      "RiverAreaSegmentUpdate",
      "RiverAreaSegmentDelete"
    ],
    "queries": [
      {
        "list": "RiverAreaPriceZoneSearch",
        "description": "Returns other pricing zones with matching river codes for overlap validation",
        "usedBy": "CheckOverlappingPricingZones"
      },
      {
        "list": "RiverList.GetRiver",
        "description": "Returns MinMile and MaxMile for a specific river code",
        "usedBy": "CheckMileInRangeForRiver"
      }
    ]
  },
  "extractionNotes": [
    "RiverArea has complex child collection validation with RiverAreaSegments",
    "Overlapping pricing zones validation is sophisticated - compares river segments across different RiverArea records",
    "Conditional field requirements based on checkbox states (CustomerID requires IsHighWaterArea)",
    "Mutually exclusive boolean flags validation",
    "License-based visibility controls for certain features",
    "Global setting (EnableRiverSegmentHighWaterModel) controls visibility of high water features",
    "Mile values are stored as strings but validated as decimals with 2 decimal place formatting",
    "River segment mile ranges must be within the parent river's defined mile range",
    "Form automatically clears unused fields on submit/cancel to ensure data integrity"
  ]
}
