{
  "entity": "FleetPositionHistory",
  "formName": "frmBargePositionHistory",
  "description": "Complete validation rules for Barge Position History form including search, form-level, and business rule validation",

  "searchValidation": {
    "method": "RefreshList",
    "location": "frmBargePositionHistory.vb:513-523",
    "trigger": "btnFind_Click",
    "rules": [
      {
        "field": "dtDateSearch",
        "control": "dtDateSearch (DateTimePicker)",
        "rule": "Required",
        "condition": "dtDateSearch.Value Is Nothing",
        "message": "Date and Tier group are required.",
        "messageType": "MessageBox",
        "severity": "Error",
        "blocksSearch": true,
        "modernEquivalent": {
          "dataAnnotation": "[Required(ErrorMessage = \"Date is required.\")]",
          "fluentValidation": "RuleFor(x => x.SearchDate).NotEmpty().WithMessage(\"Date is required.\")",
          "clientSide": "required: true, messages: { required: 'Date is required.' }"
        }
      },
      {
        "field": "cboTierGroupSearch",
        "control": "cboTierGroupSearch (ComboBox)",
        "rule": "Required",
        "condition": "cboTierGroupSearch.ValueOrNull Is Nothing",
        "message": "Date and Tier group are required.",
        "messageType": "MessageBox",
        "severity": "Error",
        "blocksSearch": true,
        "modernEquivalent": {
          "dataAnnotation": "[Required(ErrorMessage = \"Tier group is required.\")]",
          "fluentValidation": "RuleFor(x => x.TierGroupId).NotEmpty().WithMessage(\"Tier group is required.\")",
          "clientSide": "required: true, messages: { required: 'Tier group is required.' }"
        }
      },
      {
        "field": "txtBargeNumSearch",
        "control": "txtBargeNumSearch (TextBox)",
        "rule": "Optional",
        "condition": "None",
        "message": "N/A",
        "severity": "None",
        "blocksSearch": false,
        "modernEquivalent": {
          "dataAnnotation": "// No annotation - optional field",
          "fluentValidation": "// No rule - optional filter",
          "clientSide": "// No validation - optional"
        }
      },
      {
        "field": "chkIncludeBlankTierPos",
        "control": "chkIncludeBlankTierPos (CheckBox)",
        "rule": "Optional",
        "condition": "None",
        "message": "N/A",
        "severity": "None",
        "blocksSearch": false,
        "modernEquivalent": {
          "dataAnnotation": "// Boolean - no validation needed",
          "fluentValidation": "// Boolean - no validation needed",
          "clientSide": "// Boolean - no validation needed"
        }
      }
    ]
  },

  "formValidation": {
    "method": "SetValidatorExtenderForFleetPositionHistory",
    "location": "frmBargePositionHistory.vb:707-718",
    "displayControl": "staStatus",
    "rules": [
      {
        "field": "txtTierX",
        "control": "txtTierX (TextBox)",
        "rule": "DataType",
        "validationType": "Int16",
        "validator": "ValidatorExtender",
        "condition": "If LeftFleet = false",
        "message": "Auto-generated by ValidatorExtender",
        "severity": "Error",
        "conditionallyRequired": true,
        "appliesWhen": "chkLeftFleet.Checked = false",
        "modernEquivalent": {
          "dataAnnotation": "[Range(-32768, 32767, ErrorMessage = \"Tier X must be a valid 16-bit integer.\")]",
          "fluentValidation": "RuleFor(x => x.TierX).Must(BeInt16OrEmpty).When(x => !x.LeftFleet).WithMessage(\"Tier X must be a valid 16-bit integer.\")",
          "clientSide": "number: true, min: -32768, max: 32767"
        }
      },
      {
        "field": "txtTierY",
        "control": "txtTierY (TextBox)",
        "rule": "DataType",
        "validationType": "Int16",
        "validator": "ValidatorExtender",
        "condition": "If LeftFleet = false",
        "message": "Auto-generated by ValidatorExtender",
        "severity": "Error",
        "conditionallyRequired": true,
        "appliesWhen": "chkLeftFleet.Checked = false",
        "modernEquivalent": {
          "dataAnnotation": "[Range(-32768, 32767, ErrorMessage = \"Tier Y must be a valid 16-bit integer.\")]",
          "fluentValidation": "RuleFor(x => x.TierY).Must(BeInt16OrEmpty).When(x => !x.LeftFleet).WithMessage(\"Tier Y must be a valid 16-bit integer.\")",
          "clientSide": "number: true, min: -32768, max: 32767"
        }
      },
      {
        "field": "cboPositionStartTime",
        "control": "cboPositionStartTime (TimeComboBox)",
        "rule": "TimeFormat",
        "validationType": "Time",
        "validator": "Main.SetTimeValidatorExtender",
        "condition": "Always",
        "message": "Auto-generated by ValidatorExtender",
        "severity": "Error",
        "required": true,
        "modernEquivalent": {
          "dataAnnotation": "[RegularExpression(@\"^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$\", ErrorMessage = \"Invalid time format.\")]",
          "fluentValidation": "RuleFor(x => x.PositionStartTime).Matches(@\"^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$\").WithMessage(\"Invalid time format.\")",
          "clientSide": "pattern: /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/"
        }
      }
    ]
  },

  "businessValidation": {
    "method": "CheckBusinessRules",
    "location": "FleetPositionHistory.vb:66-76 and FleetPositionHistoryBase.vb:264-275",
    "rules": [
      {
        "ruleName": "PositionStartDateTimeIsRequired",
        "property": "PositionStartDateTime",
        "condition": "p_PositionStartDateTime.IsEmpty",
        "message": "PositionStartDateTime is required.",
        "severity": "Error",
        "alwaysApplies": true,
        "ruleKey": "PositionStartDateTimeIsRequired",
        "location": "FleetPositionHistoryBase.vb:269-272",
        "triggeredBy": "Property setter CheckBusinessRules(p_dispPositionStartDateTime)",
        "modernEquivalent": {
          "dataAnnotation": "[Required(ErrorMessage = \"Date/Time is required.\")]",
          "fluentValidation": "RuleFor(x => x.PositionStartDateTime).NotEmpty().WithMessage(\"Date/Time is required.\")",
          "clientSide": "required: true, messages: { required: 'Date/Time is required.' }"
        }
      },
      {
        "ruleName": "BargeNumberNotFound",
        "property": "BargeNum",
        "condition": "Not String.IsNullOrEmpty(_BargeNum) AndAlso CInt(p_BargeID) < 1",
        "message": "Barge number must match an existing barge record.",
        "severity": "Error",
        "alwaysApplies": false,
        "appliesWhen": "BargeNum is provided",
        "ruleKey": "BargeNumBargeNumberNotFound",
        "location": "FleetPositionHistory.vb:71-74",
        "businessLogic": "BargeID lookup via Barge.GetBargeID(value) - FleetPositionHistory.vb:29",
        "triggeredBy": "txtBargeNum_Validated event sets BargeNum property",
        "modernEquivalent": {
          "dataAnnotation": "// Custom validation - use FluentValidation or custom validator",
          "fluentValidation": "RuleFor(x => x.BargeNum).MustAsync(async (bargeNum, cancellation) => await BargeExists(bargeNum)).When(x => !string.IsNullOrEmpty(x.BargeNum)).WithMessage(\"Barge number must match an existing barge record.\")",
          "clientSide": "remote: { url: '/api/validate/barge', type: 'post' }"
        }
      }
    ]
  },

  "conditionalValidation": {
    "description": "Tier position fields are conditionally enabled/disabled based on LeftFleet checkbox",
    "method": "EnableDisableTierPos and ClearUnusedFields",
    "location": "frmBargePositionHistory.vb:480-498 and 533-548",
    "rules": [
      {
        "condition": "chkLeftFleet.Checked = false",
        "description": "When barge is still in fleet, tier position fields are enabled and may be required",
        "affectedFields": [
          {
            "field": "cboTierID",
            "state": "Enabled",
            "rule": "Optional",
            "message": "N/A"
          },
          {
            "field": "txtTierX",
            "state": "Enabled",
            "rule": "Must be valid Int16 if provided",
            "message": "Tier X must be a valid 16-bit integer."
          },
          {
            "field": "txtTierY",
            "state": "Enabled",
            "rule": "Must be valid Int16 if provided",
            "message": "Tier Y must be a valid 16-bit integer."
          }
        ],
        "modernEquivalent": {
          "fluentValidation": "When(x => !x.LeftFleet, () => {\n  RuleFor(x => x.TierX).Must(BeInt16OrEmpty).WithMessage(\"Tier X must be a valid 16-bit integer.\");\n  RuleFor(x => x.TierY).Must(BeInt16OrEmpty).WithMessage(\"Tier Y must be a valid 16-bit integer.\");\n})"
        }
      },
      {
        "condition": "chkLeftFleet.Checked = true",
        "description": "When barge left fleet, tier position fields are disabled and cleared",
        "affectedFields": [
          {
            "field": "cboTierID",
            "state": "Disabled",
            "rule": "Not Applicable - cleared",
            "clearedOnSave": true,
            "clearLocation": "ClearUnusedFields - line 538"
          },
          {
            "field": "txtTierX",
            "state": "Disabled",
            "rule": "Not Applicable - cleared",
            "clearedOnSave": true,
            "clearLocation": "ClearUnusedFields - line 539"
          },
          {
            "field": "txtTierY",
            "state": "Disabled",
            "rule": "Not Applicable - cleared",
            "clearedOnSave": true,
            "clearLocation": "ClearUnusedFields - line 540"
          }
        ],
        "clearingLogic": "ClearUnusedFields() called in SubmitClick before ApplyEdit",
        "modernEquivalent": {
          "fluentValidation": "When(x => x.LeftFleet, () => {\n  RuleFor(x => x.TierID).Empty().WithMessage(\"Tier ID must be empty when barge left fleet.\");\n  RuleFor(x => x.TierX).Empty().WithMessage(\"Tier X must be empty when barge left fleet.\");\n  RuleFor(x => x.TierY).Empty().WithMessage(\"Tier Y must be empty when barge left fleet.\");\n})"
        }
      }
    ]
  },

  "fieldLevelValidation": {
    "description": "Validated event handlers that update business object properties",
    "location": "frmBargePositionHistory.vb:556-703",
    "fields": [
      {
        "field": "txtBargeNum",
        "property": "BargeNum",
        "eventHandler": "txtBargeNum_Validated",
        "location": "line 558-579",
        "validation": "Property setter triggers BargeID lookup and CheckBusinessRules",
        "required": false,
        "dataType": "String",
        "businessRule": "Must match existing barge via Barge.GetBargeID()",
        "errorHandling": "Exception published via ExceptionManager"
      },
      {
        "field": "cboTierID",
        "property": "TierID",
        "eventHandler": "cboTierID_Validated",
        "location": "line 581-599",
        "validation": "InfragisticsHelper.SetObjectProperty sets Int32 value from combo",
        "required": false,
        "conditionallyRequired": true,
        "appliesWhen": "LeftFleet = false",
        "dataType": "String (representing Int32)",
        "errorHandling": "Exception published via ExceptionManager"
      },
      {
        "field": "txtTierX",
        "property": "TierX",
        "eventHandler": "txtTierX_Validated",
        "location": "line 601-620",
        "validation": "Must be valid Int16 (validated by ValidatorExtender before property set)",
        "required": false,
        "conditionallyRequired": true,
        "appliesWhen": "LeftFleet = false",
        "dataType": "String (representing Int16)",
        "errorHandling": "Exception published via ExceptionManager"
      },
      {
        "field": "txtTierY",
        "property": "TierY",
        "eventHandler": "txtTierY_Validated",
        "location": "line 622-641",
        "validation": "Must be valid Int16 (validated by ValidatorExtender before property set)",
        "required": false,
        "conditionallyRequired": true,
        "appliesWhen": "LeftFleet = false",
        "dataType": "String (representing Int16)",
        "errorHandling": "Exception published via ExceptionManager"
      },
      {
        "field": "dtPositionStartDate",
        "property": "PositionStartDateTime",
        "eventHandler": "dtPositionStartDate_Validated",
        "location": "line 643-661",
        "validation": "Combined with cboPositionStartTime via InfragisticsHelper.SetCombinedDateTimeProp",
        "required": true,
        "bold": true,
        "dataType": "DateTime (date part)",
        "compositeField": true,
        "errorHandling": "Exception published via ExceptionManager"
      },
      {
        "field": "cboPositionStartTime",
        "property": "PositionStartDateTime",
        "eventHandler": "cboPositionStartTime_Validated",
        "location": "line 663-681",
        "validation": "Combined with dtPositionStartDate via InfragisticsHelper.SetCombinedDateTimeProp, Time format validated by ValidatorExtender",
        "required": true,
        "bold": true,
        "dataType": "DateTime (time part)",
        "compositeField": true,
        "errorHandling": "Exception published via ExceptionManager"
      },
      {
        "field": "chkLeftFleet",
        "property": "LeftFleet",
        "eventHandler": "chkLeftFleet_CheckedChanged",
        "location": "line 683-701",
        "validation": "Boolean value, triggers EnableDisableTierPos()",
        "required": false,
        "dataType": "Boolean",
        "sideEffect": "Enables/disables tier position fields",
        "errorHandling": "Exception published via ExceptionManager"
      }
    ]
  },

  "validationTriggers": {
    "description": "Events and methods that trigger validation",
    "triggers": [
      {
        "event": "btnFind_Click",
        "method": "RefreshList",
        "validationType": "Search validation",
        "blocksAction": true,
        "location": "line 197-211"
      },
      {
        "event": "ToolbarsManager_ToolClick",
        "method": "Me.Validate()",
        "validationType": "Force validation on current control",
        "blocksAction": true,
        "location": "line 166-195, specifically line 173"
      },
      {
        "event": "btnSubmit_Click",
        "method": "SubmitClick -> MyBase.SubmitClick",
        "validationType": "Business rule validation (IsValid check)",
        "blocksAction": true,
        "location": "line 118-132",
        "businessObjectValidation": "Calls CheckBusinessRules, checks IsValid property"
      },
      {
        "event": "Property Setters",
        "method": "CheckBusinessRules(propertyName)",
        "validationType": "Business rule validation",
        "blocksAction": false,
        "timing": "Real-time as fields change",
        "affectedProperties": [
          "FleetID",
          "BargeID (via BargeNum)",
          "TierID",
          "TierX",
          "TierY",
          "PositionStartDateTime",
          "LeftFleet"
        ]
      },
      {
        "event": "Control Validated Events",
        "method": "ValidatorExtender validation",
        "validationType": "Data type validation",
        "blocksAction": true,
        "displayLocation": "staStatus",
        "affectedControls": [
          "txtTierX",
          "txtTierY",
          "cboPositionStartTime"
        ]
      }
    ]
  },

  "validationPatterns": {
    "requiredFields": [
      {
        "field": "dtDateSearch",
        "context": "Search",
        "indication": "Bold label",
        "validation": "Client-side check before search"
      },
      {
        "field": "cboTierGroupSearch",
        "context": "Search",
        "indication": "Bold label",
        "validation": "Client-side check before search"
      },
      {
        "field": "PositionStartDateTime (date + time)",
        "context": "Edit",
        "indication": "Bold labels",
        "validation": "Business rule - server-side"
      }
    ],
    "dataTypeValidation": [
      {
        "pattern": "Int16 validation",
        "fields": ["txtTierX", "txtTierY"],
        "validator": "ValidatorExtender",
        "validationType": "ValidationTypeConstants.Int16"
      },
      {
        "pattern": "Time validation",
        "fields": ["cboPositionStartTime"],
        "validator": "Main.SetTimeValidatorExtender",
        "validationType": "Time format"
      },
      {
        "pattern": "DateTime validation",
        "fields": ["dtPositionStartDate", "cboPositionStartTime"],
        "validator": "InfragisticsHelper.SetCombinedDateTimeProp",
        "validationType": "Combined DateTime"
      }
    ],
    "conditionalValidation": [
      {
        "pattern": "Conditional enable/disable",
        "trigger": "chkLeftFleet.CheckedChanged",
        "method": "EnableDisableTierPos",
        "affectedFields": ["cboTierID", "txtTierX", "txtTierY"]
      },
      {
        "pattern": "Conditional clear",
        "trigger": "Submit with LeftFleet = true",
        "method": "ClearUnusedFields",
        "affectedFields": ["TierID", "TierX", "TierY"]
      }
    ],
    "databaseValidation": [
      {
        "pattern": "Foreign key lookup",
        "field": "BargeNum",
        "method": "Barge.GetBargeID(value)",
        "businessRule": "BargeNumberNotFound",
        "validation": "Must return valid ID > 0"
      }
    ]
  },

  "errorMessaging": {
    "displayMethods": [
      {
        "method": "MessageBox.Show",
        "usage": "Search validation errors",
        "location": "RefreshList method",
        "style": "Blocking modal dialog"
      },
      {
        "method": "staStatus.Text",
        "usage": "ValidatorExtender messages",
        "location": "Status bar at bottom of form",
        "style": "Non-blocking status message"
      },
      {
        "method": "BrokenRules collection",
        "usage": "Business rule validation",
        "location": "Business object",
        "style": "Prevents save, displayed via base form"
      }
    ],
    "messages": [
      {
        "message": "Date and Tier group are required.",
        "context": "Search validation",
        "severity": "Error",
        "displayMethod": "MessageBox"
      },
      {
        "message": "PositionStartDateTime is required.",
        "context": "Business rule",
        "severity": "Error",
        "displayMethod": "BrokenRules"
      },
      {
        "message": "Barge number must match an existing barge record.",
        "context": "Business rule",
        "severity": "Error",
        "displayMethod": "BrokenRules"
      },
      {
        "message": "Tier X must be a valid 16-bit integer.",
        "context": "Form validation",
        "severity": "Error",
        "displayMethod": "StatusBar"
      },
      {
        "message": "Tier Y must be a valid 16-bit integer.",
        "context": "Form validation",
        "severity": "Error",
        "displayMethod": "StatusBar"
      },
      {
        "message": "Invalid time format.",
        "context": "Form validation",
        "severity": "Error",
        "displayMethod": "StatusBar"
      }
    ]
  },

  "modernValidationMapping": {
    "aspNetCore": {
      "viewModel": {
        "properties": [
          "[Required(ErrorMessage = \"Date/Time is required.\")]",
          "public DateTime PositionStartDateTime { get; set; }",
          "",
          "[Range(-32768, 32767, ErrorMessage = \"Tier X must be a valid 16-bit integer.\")]",
          "public short? TierX { get; set; }",
          "",
          "[Range(-32768, 32767, ErrorMessage = \"Tier Y must be a valid 16-bit integer.\")]",
          "public short? TierY { get; set; }"
        ]
      },
      "fluentValidation": {
        "validatorClass": "FleetPositionHistoryValidator",
        "rules": [
          "RuleFor(x => x.PositionStartDateTime).NotEmpty().WithMessage(\"Date/Time is required.\");",
          "",
          "RuleFor(x => x.BargeNum)",
          "  .MustAsync(async (bargeNum, cancellation) => await BargeExists(bargeNum))",
          "  .When(x => !string.IsNullOrEmpty(x.BargeNum))",
          "  .WithMessage(\"Barge number must match an existing barge record.\");",
          "",
          "When(x => !x.LeftFleet, () => {",
          "  RuleFor(x => x.TierX)",
          "    .Must(BeInt16OrEmpty)",
          "    .WithMessage(\"Tier X must be a valid 16-bit integer.\");",
          "  RuleFor(x => x.TierY)",
          "    .Must(BeInt16OrEmpty)",
          "    .WithMessage(\"Tier Y must be a valid 16-bit integer.\");",
          "});",
          "",
          "When(x => x.LeftFleet, () => {",
          "  RuleFor(x => x.TierID).Empty();",
          "  RuleFor(x => x.TierX).Empty();",
          "  RuleFor(x => x.TierY).Empty();",
          "});"
        ]
      },
      "clientSideValidation": {
        "framework": "jquery.validate",
        "rules": {
          "PositionStartDateTime": "{ required: true }",
          "TierX": "{ number: true, min: -32768, max: 32767 }",
          "TierY": "{ number: true, min: -32768, max: 32767 }",
          "BargeNum": "{ remote: { url: '/api/validate/barge', type: 'post' } }"
        },
        "conditionalLogic": "Enable/disable tier fields based on LeftFleet checkbox using jQuery"
      }
    }
  },

  "conversionNotes": {
    "criticalValidations": [
      "PositionStartDateTime is required - MUST be enforced",
      "BargeNum lookup validation - MUST verify barge exists",
      "Conditional tier field clearing when LeftFleet = true - MUST be implemented"
    ],
    "complexPatterns": [
      "Composite DateTime field (date picker + time combo) - needs special handling",
      "Conditional enable/disable based on checkbox - implement client-side",
      "ValidatorExtender status bar display - convert to inline validation messages or toast"
    ],
    "recommendations": [
      "Use FluentValidation for business rules (more flexible than Data Annotations)",
      "Implement conditional validation for tier fields based on LeftFleet",
      "Use remote validation for BargeNum lookup",
      "Maintain same error messages for consistency with legacy system",
      "Consider using a DateTimePicker component that handles both date and time",
      "Implement clear visual indication for required fields (bold or asterisk)",
      "Use proper validation summary for displaying multiple errors"
    ]
  }
}
